<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.59" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://luxiag.github.io/luxiag/blog/vue2/parse.html"><meta property="og:title" content="Vue2.x框架原理分析-编译"><meta property="og:description" content="前言 vue 基于源码构建的有两个版本，一个是 runtime only(一个只包含运行时的版本)，另一个是 runtime + compiler(一个同时包含编译器和运行时的完整版本)。而两个版本的区别仅在于后者包含了一个编译器。 完整版本 完整版本 源码中，是先定义只包含运行时版本的$mount方法，再定义完整版本的$mount 方法 plantf..."><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2022-12-30T06:28:03.000Z"><meta property="article:published_time" content="2021-08-15T00:00:00.000Z"><meta property="article:modified_time" content="2022-12-30T06:28:03.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Vue2.x框架原理分析-编译","image":[""],"datePublished":"2021-08-15T00:00:00.000Z","dateModified":"2022-12-30T06:28:03.000Z","author":[{"@type":"Person","name":"luxiag","url":"https://luxiag.github.io/luxiag"}]}</script><title>Vue2.x框架原理分析-编译</title><meta name="description" content="前言 vue 基于源码构建的有两个版本，一个是 runtime only(一个只包含运行时的版本)，另一个是 runtime + compiler(一个同时包含编译器和运行时的完整版本)。而两个版本的区别仅在于后者包含了一个编译器。 完整版本 完整版本 源码中，是先定义只包含运行时版本的$mount方法，再定义完整版本的$mount 方法 plantf...">
    <link rel="preload" href="/blog/assets/style-DFpyBJPz.css" as="style"><link rel="stylesheet" href="/blog/assets/style-DFpyBJPz.css">
    <link rel="modulepreload" href="/blog/assets/app-CbGq5X0e.js"><link rel="modulepreload" href="/blog/assets/parse.html-BBRlrmqh.js">
    <link rel="prefetch" href="/blog/assets/index.html-Fwt8LUi1.js" as="script"><link rel="prefetch" href="/blog/assets/Dijkstra's-algorithm.html-DBkvokd7.js" as="script"><link rel="prefetch" href="/blog/assets/algorithm-diagram.html-CI0xeZul.js" as="script"><link rel="prefetch" href="/blog/assets/binary-search.html-BHIICO6q.js" as="script"><link rel="prefetch" href="/blog/assets/double_pointer.html-X3xPnauN.js" as="script"><link rel="prefetch" href="/blog/assets/dynamic-programming.html-CgBMKsJJ.js" as="script"><link rel="prefetch" href="/blog/assets/greedy-alogrithm.html-i59s0JRV.js" as="script"><link rel="prefetch" href="/blog/assets/hash-table.html-CbftrbZA.js" as="script"><link rel="prefetch" href="/blog/assets/k-nearest-neighbor.html-irbR2KM9.js" as="script"><link rel="prefetch" href="/blog/assets/large-o-notation.html-haoZsNSy.js" as="script"><link rel="prefetch" href="/blog/assets/linear-programming.html-CBjEz98T.js" as="script"><link rel="prefetch" href="/blog/assets/preferential-traversal.html-AvpENahm.js" as="script"><link rel="prefetch" href="/blog/assets/quick-sort.html-NEfo5CT-.js" as="script"><link rel="prefetch" href="/blog/assets/recursion.html-Bj-2xAHH.js" as="script"><link rel="prefetch" href="/blog/assets/select-sort.html-D4Do0WoB.js" as="script"><link rel="prefetch" href="/blog/assets/sort.html-BX4GSucA.js" as="script"><link rel="prefetch" href="/blog/assets/base.html-OqF-Au_t.js" as="script"><link rel="prefetch" href="/blog/assets/configure-system.html-CWUlyoPe.js" as="script"><link rel="prefetch" href="/blog/assets/get.html-CqQna1rB.js" as="script"><link rel="prefetch" href="/blog/assets/post.html-BRyZKks2.js" as="script"><link rel="prefetch" href="/blog/assets/restful.html-CCjV805_.js" as="script"><link rel="prefetch" href="/blog/assets/browsers-rendering.html-D7WVyhpq.js" as="script"><link rel="prefetch" href="/blog/assets/how-browsers-work.html-o2CaoObz.js" as="script"><link rel="prefetch" href="/blog/assets/implementation-mechanism.html-DthtrvBF.js" as="script"><link rel="prefetch" href="/blog/assets/page.html-09mhRo7-.js" as="script"><link rel="prefetch" href="/blog/assets/animation.html-Cd1WID6e.js" as="script"><link rel="prefetch" href="/blog/assets/bem.html-GEf24PA7.js" as="script"><link rel="prefetch" href="/blog/assets/clear-float.html-uKo7qYm9.js" as="script"><link rel="prefetch" href="/blog/assets/color-system.html-DXdCvRFh.js" as="script"><link rel="prefetch" href="/blog/assets/date-type.html-A0LOk4Tz.js" as="script"><link rel="prefetch" href="/blog/assets/fixed-aspect-ratio.html-DgG7iLHw.js" as="script"><link rel="prefetch" href="/blog/assets/formatting-context.html-BrokzZ0h.js" as="script"><link rel="prefetch" href="/blog/assets/layout.html-Xisn5fb8.js" as="script"><link rel="prefetch" href="/blog/assets/visual-formatting-model.html-CDq6CeNH.js" as="script"><link rel="prefetch" href="/blog/assets/mysql.html-U8BduvY-.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-function.html-B1hdUAW2.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-graphical-part1.html-DBNHBGgA.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-graphical-part2.html-DmDqH8BN.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-graphical-part3.html-BStgNchf.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-hello.html-CYxWGTO6.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-matrices.html-f-KJ8EvJ.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-sentence.html-CYpTAkZA.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-shapes.html-BA71em6U.js" as="script"><link rel="prefetch" href="/blog/assets/glsl-vars.html-8xN8GuMq.js" as="script"><link rel="prefetch" href="/blog/assets/water_smoke_cloud.html-BjgkNPOw.js" as="script"><link rel="prefetch" href="/blog/assets/eventloop.html-m0iUgps2.js" as="script"><link rel="prefetch" href="/blog/assets/iterators-and-generators.html-BZ0WK7yR.js" as="script"><link rel="prefetch" href="/blog/assets/promise.html-BT4rd0ec.js" as="script"><link rel="prefetch" href="/blog/assets/proxy-and-reflect.html-DDG8NJ7y.js" as="script"><link rel="prefetch" href="/blog/assets/life-cycle.html-CJwX4FRp.js" as="script"><link rel="prefetch" href="/blog/assets/browser-request.html-CAwx5fL6.js" as="script"><link rel="prefetch" href="/blog/assets/how-networks-work-part1.html-CBjU9Fg2.js" as="script"><link rel="prefetch" href="/blog/assets/how-networks-work-part2.html-CjFygmJx.js" as="script"><link rel="prefetch" href="/blog/assets/how-networks-work-part3.html-92gaoJlI.js" as="script"><link rel="prefetch" href="/blog/assets/how-networks-work-part4.html-DZlK0btV.js" as="script"><link rel="prefetch" href="/blog/assets/note.html-DN4r0txE.js" as="script"><link rel="prefetch" href="/blog/assets/apm.html-DoEK54G1.js" as="script"><link rel="prefetch" href="/blog/assets/log.html-U4rtaLEA.js" as="script"><link rel="prefetch" href="/blog/assets/safe.html-HnJzA70m.js" as="script"><link rel="prefetch" href="/blog/assets/test.html-CYT8CaTG.js" as="script"><link rel="prefetch" href="/blog/assets/compress.html-AoWfYV4b.js" as="script"><link rel="prefetch" href="/blog/assets/experience.html-C23TZInk.js" as="script"><link rel="prefetch" href="/blog/assets/load-policy.html-DDL2YtjO.js" as="script"><link rel="prefetch" href="/blog/assets/perform-rendering.html-DHMhQQvV.js" as="script"><link rel="prefetch" href="/blog/assets/picture.html-DoSwjz_2.js" as="script"><link rel="prefetch" href="/blog/assets/entify-framework-core.html-CPODeZPc.js" as="script"><link rel="prefetch" href="/blog/assets/how-work.html-Brscfn7z.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-3d-map.html-3XMTGo2t.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-bone-animation.html-DqmOFJVY.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-css3d.html-I_5WDs76.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-curve.html-Dn3xiFMS.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-firework.html-Cu4lY6EM.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-hello.html-Bz8SwsiA.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-light.html-BaaKAvv9.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-luminous.html-CZUt9v7q.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-material.html-2KaOfx3q.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-raycaster.html-CSKb1ZTC.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-texture.html-qSf-aKEU.js" as="script"><link rel="prefetch" href="/blog/assets/threejs-water.html-B9aqUnM5.js" as="script"><link rel="prefetch" href="/blog/assets/base.html-CJBpIHO5.js" as="script"><link rel="prefetch" href="/blog/assets/android.html-DJQ7iwYp.js" as="script"><link rel="prefetch" href="/blog/assets/computed-code-analysis.html-CWJMPJow.js" as="script"><link rel="prefetch" href="/blog/assets/direct-code-analysis.html-DljSbrkm.js" as="script"><link rel="prefetch" href="/blog/assets/init.html-CjPF-nNC.js" as="script"><link rel="prefetch" href="/blog/assets/keep-alive-code-analysis.html-452jPtLt.js" as="script"><link rel="prefetch" href="/blog/assets/life-cycle.html-FN1WYsn1.js" as="script"><link rel="prefetch" href="/blog/assets/mount.html-D25g-B7u.js" as="script"><link rel="prefetch" href="/blog/assets/scoped-code-analysis.html-CmqIkD4W.js" as="script"><link rel="prefetch" href="/blog/assets/summary.html-BlMz1l7V.js" as="script"><link rel="prefetch" href="/blog/assets/vue-loader-code-analysis.html-KlYkE1UX.js" as="script"><link rel="prefetch" href="/blog/assets/vue-router-code-analysis.html-B0qZjK9T.js" as="script"><link rel="prefetch" href="/blog/assets/vuex-code-analysis.html-Djke8Clb.js" as="script"><link rel="prefetch" href="/blog/assets/watch-code-analysis.html-b872GuNB.js" as="script"><link rel="prefetch" href="/blog/assets/provide-inject.html-C0p7hTw4.js" as="script"><link rel="prefetch" href="/blog/assets/vue3-and-vue2.html-B9yIIBEA.js" as="script"><link rel="prefetch" href="/blog/assets/vuex.html-UEWgazen.js" as="script"><link rel="prefetch" href="/blog/assets/ast.html-C5kxtVFj.js" as="script"><link rel="prefetch" href="/blog/assets/babel.html-B-8uLOvL.js" as="script"><link rel="prefetch" href="/blog/assets/browserslist.html-XZMadQui.js" as="script"><link rel="prefetch" href="/blog/assets/common-config.html-Bi-s2KGL.js" as="script"><link rel="prefetch" href="/blog/assets/custom-loader.html-ncsWk9aU.js" as="script"><link rel="prefetch" href="/blog/assets/custom-plugin.html-CCX8C1WV.js" as="script"><link rel="prefetch" href="/blog/assets/loader-basic-knowledge.html-DvQMLet4.js" as="script"><link rel="prefetch" href="/blog/assets/packaged-analytics.html-dqYW_yVq.js" as="script"><link rel="prefetch" href="/blog/assets/postcss.html-CI4IcHMa.js" as="script"><link rel="prefetch" href="/blog/assets/source-map.html-BazW3ehu.js" as="script"><link rel="prefetch" href="/blog/assets/start-process.html-CRMHlYHY.js" as="script"><link rel="prefetch" href="/blog/assets/tapable.html-JVRPT2IY.js" as="script"><link rel="prefetch" href="/blog/assets/socket-io.html-CXOe-I7m.js" as="script"><link rel="prefetch" href="/blog/assets/websocket.html-B9GWPIA8.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-5gnAo4wu.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CvJzL2q-.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CzkF8Y7m.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BKFdhsbr.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CBtpYZ-Z.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DnqWocFT.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Cu7gVKF_.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CgxMlDXM.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ACsZJv1H.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CYVMgup6.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ChpQGj0x.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-wdykHx0S.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CPQkh6mi.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C5au-5Gb.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DNnvC3wY.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DiJk4CmV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-J3U_L7Km.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C10JRu9I.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-MTM4J2xe.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-D0U8Bcq6.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-KSFt2MaQ.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BMUPHUDV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Cxger8Mi.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-rXaipLKY.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-HhflwgTS.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DbswWgJv.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Cu7AeYJ2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CYmYNmfo.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-dwRTOvt2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C3XxCEtF.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-GHlOSLuE.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Cst95C6g.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DkRVV7Ol.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ce8LkzeY.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-yepbwvvU.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ot5FVAGS.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DQXXvNSK.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CocIIOMu.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CV8AyFwE.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Dzin_T6w.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CwSOyxFh.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DLKWanba.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Chw9syk9.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-SUFOu9j-.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ck5mh1E1.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ByThdVev.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DtH-YeIV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ByThdVev.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DtH-YeIV.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-7tL4ujxw.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BM_Hfh3C.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Cj-TdiW3.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-D5BiheGR.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C8UzsQL7.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BgKHDBmv.js" as="script"><link rel="prefetch" href="/blog/assets/photoswipe.esm-GXRgw7eJ.js" as="script"><link rel="prefetch" href="/blog/assets/SearchResult-D4a0l1C6.js" as="script"><link rel="prefetch" href="/blog/assets/setupDevtools-7MC2TMWH-BVw_eJnU.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><!--[--><div class="theme-container no-sidebar external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/blog/" aria-label="Take me home"><img class="vp-nav-logo" src="/blog/./public/assets/images/logo.svg" alt><!----><!----></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/" aria-label="Blog"><!---->Blog<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/timeline/" aria-label="Timeline"><!---->Timeline<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/tools/" aria-label="/tools/"><!---->/tools/<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/games/" aria-label="/games/"><!---->/games/<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/luxiag/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">Search</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Vue2.x框架原理分析-编译</h1><div class="page-info"><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">August 15, 2021</span><meta property="datePublished" content="2021-08-15T00:00:00.000Z"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item clickable" role="navigation">Vue</span><!--]--><meta property="articleSection" content="Vue"></span><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 13 min</span><meta property="timeRequired" content="PT13M"></span><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc" vp-toc><!----><div class="vp-toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#前言">前言</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#完整版本">完整版本</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#运行时">运行时</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#流程">流程</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#parse">parse</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#html-解析">HTML 解析</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#parsehtml">parseHTML</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#parsestarttag">parseStartTag</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#handlestarttag">handleStartTag</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#start">start</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#文本解析">文本解析</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#parsetext">parseText</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#optimize">optimize</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#markstatic">markStatic</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#markstaticroots">markStaticRoots</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#generate">generate</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content" vp-content><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><figure><img src="/blog/assets/1680123400810165446-BowZKtyj.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>vue 基于源码构建的有两个版本，一个是 runtime only(一个只包含运行时的版本)，另一个是 runtime + compiler(一个同时包含编译器和运行时的完整版本)。而两个版本的区别仅在于后者包含了一个编译器。</p><h3 id="完整版本" tabindex="-1"><a class="header-anchor" href="#完整版本"><span>完整版本</span></a></h3><ul><li>完整版本</li></ul><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;font-weight:bold;">new</span><span style="color:#50FA7B;"> Vue</span><span style="color:#F8F8F2;">({</span></span>
<span class="line"><span style="color:#F8F8F2;">  template</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">&lt;div&gt;&lt;/div&gt;</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">});</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>源码中，是先定义只包含运行时版本的$mount方法，再定义完整版本的$mount 方法 <code>plantforms/web/runtime-with-compiler</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> mount </span><span style="color:#FF79C6;">=</span><span style="color:#8BE9FD;font-style:italic;"> Vue</span><span style="color:#F8F8F2;">.prototype.$mount;</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic;">Vue</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#50FA7B;">$mount</span><span style="color:#FF79C6;"> =</span><span style="color:#FF79C6;"> function</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  el</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> Element</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  hydrating</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> boolean</span></span>
<span class="line"><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Component</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  el </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> el </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#50FA7B;"> query</span><span style="color:#F8F8F2;">(el);</span></span>
<span class="line"><span style="color:#6272A4;">  /* istanbul ignore if */</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (el </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> document.body </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> el </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> document.documentElement) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#BD93F9;font-style:italic;"> this</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> options </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;font-style:italic;"> this</span><span style="color:#F8F8F2;">.$options;</span></span>
<span class="line"><span style="color:#6272A4;">  // resolve template/el and convert to render function</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">options.render) {</span></span>
<span class="line"><span style="color:#FF79C6;">    let</span><span style="color:#F8F8F2;"> template </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.template;</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (template) {</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">typeof</span><span style="color:#F8F8F2;"> template </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">string</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (template.</span><span style="color:#50FA7B;">charAt</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">#</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          template </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> idToTemplate</span><span style="color:#F8F8F2;">(template);</span></span>
<span class="line"><span style="color:#6272A4;">          /* istanbul ignore if */</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (template.nodeType) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        template </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> template.innerHTML;</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#BD93F9;font-style:italic;"> this</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el) {</span></span>
<span class="line"><span style="color:#6272A4;">      // @ts-expect-error</span></span>
<span class="line"><span style="color:#F8F8F2;">      template </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> getOuterHTML</span><span style="color:#F8F8F2;">(el);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (template) {</span></span>
<span class="line"><span style="color:#6272A4;">      /* istanbul ignore if */</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> { render, staticRenderFns } </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> compileToFunctions</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#F8F8F2;">        template,</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">          outputSourceRange</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> __DEV__,</span></span>
<span class="line"><span style="color:#F8F8F2;">          shouldDecodeNewlines,</span></span>
<span class="line"><span style="color:#F8F8F2;">          shouldDecodeNewlinesForHref,</span></span>
<span class="line"><span style="color:#F8F8F2;">          delimiters</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.delimiters,</span></span>
<span class="line"><span style="color:#F8F8F2;">          comments</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.comments,</span></span>
<span class="line"><span style="color:#F8F8F2;">        },</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic;">        this</span></span>
<span class="line"><span style="color:#F8F8F2;">      );</span></span>
<span class="line"><span style="color:#F8F8F2;">      options.render </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> render;</span></span>
<span class="line"><span style="color:#F8F8F2;">      options.staticRenderFns </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> staticRenderFns;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#F8F8F2;"> mount.</span><span style="color:#50FA7B;">call</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;font-style:italic;">this</span><span style="color:#F8F8F2;">, el, hydrating);</span></span>
<span class="line"><span style="color:#F8F8F2;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="运行时" tabindex="-1"><a class="header-anchor" href="#运行时"><span>运行时</span></a></h3><ul><li>只包含运行时版本</li></ul><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">import</span><span style="color:#F8F8F2;"> App </span><span style="color:#FF79C6;">from</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">./App.vue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;font-weight:bold;">new</span><span style="color:#50FA7B;"> Vue</span><span style="color:#F8F8F2;">({</span></span>
<span class="line"><span style="color:#50FA7B;">  render</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">h</span><span style="color:#F8F8F2;">) {},</span></span>
<span class="line"><span style="color:#F8F8F2;">});</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>完整版和只包含运行时版之间的差异主要在于是否有模板编译阶段</strong><code>运行时</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#8BE9FD;font-style:italic;">Vue</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#50FA7B;">$mount</span><span style="color:#FF79C6;"> =</span><span style="color:#FF79C6;"> function</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  el</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> Element</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  hydrating</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> boolean</span></span>
<span class="line"><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Component</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  el </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> el </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> inBrowser </span><span style="color:#FF79C6;">?</span><span style="color:#50FA7B;"> query</span><span style="color:#F8F8F2;">(el) </span><span style="color:#FF79C6;">:</span><span style="color:#BD93F9;"> undefined</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#50FA7B;"> mountComponent</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;font-style:italic;">this</span><span style="color:#F8F8F2;">, el, hydrating);</span></span>
<span class="line"><span style="color:#F8F8F2;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="流程" tabindex="-1"><a class="header-anchor" href="#流程"><span>流程</span></a></h2><p><img src="/blog/assets/1680123400713173220-JAABIXqO.png" alt="" loading="lazy"><img src="/blog/assets/1680123400728101022-DK_HekPn.png" alt="" loading="lazy"></p><ul><li>模板解析阶段：将一堆模板字符串用正则等方式解析成抽象语法树 AST；</li><li>优化阶段：遍历 AST，找出其中的静态节点，并打上标记；</li><li>代码生成阶段：将 AST 转换成渲染函数；</li></ul><p>template -&gt; compileToFunctions() -&gt;</p><p><code>template</code></p><figure><img src="/blog/assets/1680123400714155754-BwEEJ9b9.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>src/platforms/web</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> mount </span><span style="color:#FF79C6;">=</span><span style="color:#8BE9FD;font-style:italic;"> Vue</span><span style="color:#F8F8F2;">.prototype.$mount;</span></span>
<span class="line"><span style="color:#8BE9FD;font-style:italic;">Vue</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#50FA7B;">$mount</span><span style="color:#FF79C6;"> =</span><span style="color:#FF79C6;"> function</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  el</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> Element</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  hydrating</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> boolean</span></span>
<span class="line"><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Component</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  el </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> el </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#50FA7B;"> query</span><span style="color:#F8F8F2;">(el);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">  /* istanbul ignore if */</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (el </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> document.body </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> el </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> document.documentElement) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#BD93F9;font-style:italic;"> this</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> options </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;font-style:italic;"> this</span><span style="color:#F8F8F2;">.$options;</span></span>
<span class="line"><span style="color:#6272A4;">  // resolve template/el and convert to render function</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">options.render) {</span></span>
<span class="line"><span style="color:#FF79C6;">    let</span><span style="color:#F8F8F2;"> template </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.template;</span></span>
<span class="line"><span style="color:#6272A4;">    // #id 或者是一个 DOM 元素</span></span>
<span class="line"><span style="color:#6272A4;">    // 转成一个字符串模板</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (template) {</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">typeof</span><span style="color:#F8F8F2;"> template </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">string</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (template.</span><span style="color:#50FA7B;">charAt</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">#</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          template </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> idToTemplate</span><span style="color:#F8F8F2;">(template);</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (template.nodeType) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        template </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> template.innerHTML;</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#BD93F9;font-style:italic;"> this</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el) {</span></span>
<span class="line"><span style="color:#6272A4;">      // @ts-expect-error</span></span>
<span class="line"><span style="color:#F8F8F2;">      template </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> getOuterHTML</span><span style="color:#F8F8F2;">(el);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (template) {</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> { render, staticRenderFns } </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> compileToFunctions</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#F8F8F2;">        template,</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">          outputSourceRange</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> __DEV__,</span></span>
<span class="line"><span style="color:#F8F8F2;">          shouldDecodeNewlines,</span></span>
<span class="line"><span style="color:#F8F8F2;">          shouldDecodeNewlinesForHref,</span></span>
<span class="line"><span style="color:#F8F8F2;">          delimiters</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.delimiters,</span></span>
<span class="line"><span style="color:#F8F8F2;">          comments</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.comments,</span></span>
<span class="line"><span style="color:#F8F8F2;">        },</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic;">        this</span></span>
<span class="line"><span style="color:#F8F8F2;">      );</span></span>
<span class="line"><span style="color:#F8F8F2;">      options.render </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> render;</span></span>
<span class="line"><span style="color:#F8F8F2;">      options.staticRenderFns </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> staticRenderFns;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#F8F8F2;"> mount.</span><span style="color:#50FA7B;">call</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;font-style:italic;">this</span><span style="color:#F8F8F2;">, el, hydrating);</span></span>
<span class="line"><span style="color:#F8F8F2;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>处理各种不同写法的 template</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> idToTemplate </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> cached</span><span style="color:#F8F8F2;">((</span><span style="color:#FFB86C;font-style:italic;">id</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> el </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> query</span><span style="color:#F8F8F2;">(id);</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#F8F8F2;"> el </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> el.innerHTML;</span></span>
<span class="line"><span style="color:#F8F8F2;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> getOuterHTML</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">el</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Element</span><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (el.outerHTML) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#F8F8F2;"> el.outerHTML;</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> container </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> document.</span><span style="color:#50FA7B;">createElement</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">div</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    container.</span><span style="color:#50FA7B;">appendChild</span><span style="color:#F8F8F2;">(el.</span><span style="color:#50FA7B;">cloneNode</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#F8F8F2;"> container.innerHTML;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>模板解析阶段——解析器——源码路径：src/compiler/parser/index.js;</p></li><li><p>优化阶段——优化器——源码路径：src/compiler/optimizer.js;</p></li><li><p>代码生成阶段——代码生成器——源码路径：src/compiler/codegen/index.js;</p></li><li><p><code>const ast =parse(template.trim(), options):</code>parse 会用正则等方式解析 template 模板中的指令、class、style 等数据，形成 AST。</p></li><li><p><code>optimize(ast, options):</code> optimize 的主要作用是标记静态节点，这是 Vue 在编译过程中的一处优化，挡在进行 patch 的过程中， DOM-Diff 算法会直接跳过静态节点，从而减少了比较的过程，优化了 patch 的性能。</p></li><li><p><code>const code =generate(ast, options)</code>: 将 AST 转化成 render 函数字符串的过程，得到结果是 render 函数 的字符串以及 staticRenderFns 字符串。</p></li></ul><p><code>src/compiler createCompilerCreator</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#6272A4;">//createCompiler 是 createCompilerCreator 的返回值</span></span>
<span class="line"><span style="color:#6272A4;">//createCompilerCreator 返回了一个 createCompiler 函数</span></span>
<span class="line"><span style="color:#6272A4;">//CompilerOptions 最终还是调用baseCompile</span></span>
<span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> createCompiler </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> createCompilerCreator</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> baseCompile</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  template</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  options</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span></span>
<span class="line"><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompiledResult</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> ast </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> parse</span><span style="color:#F8F8F2;">(template.</span><span style="color:#50FA7B;">trim</span><span style="color:#F8F8F2;">(), options);</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (options.optimize </span><span style="color:#FF79C6;">!==</span><span style="color:#BD93F9;"> false</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#50FA7B;">    optimize</span><span style="color:#F8F8F2;">(ast, options);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> code </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> generate</span><span style="color:#F8F8F2;">(ast, options);</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    ast,</span></span>
<span class="line"><span style="color:#F8F8F2;">    render</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> code.render,</span></span>
<span class="line"><span style="color:#F8F8F2;">    staticRenderFns</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> code.staticRenderFns,</span></span>
<span class="line"><span style="color:#F8F8F2;">  };</span></span>
<span class="line"><span style="color:#F8F8F2;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> const</span><span style="color:#F8F8F2;"> { compile, compileToFunctions } </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> createCompiler</span><span style="color:#F8F8F2;">(baseOptions);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>src/compiler/create-compiler</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> createCompilerCreator</span><span style="color:#F8F8F2;">(</span><span style="color:#50FA7B;">baseCompile</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Function</span><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Function</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> createCompiler</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">baseOptions</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">    function</span><span style="color:#50FA7B;"> compile</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">      template</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">      options</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span></span>
<span class="line"><span style="color:#F8F8F2;">    )</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompiledResult</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> finalOptions </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Object.</span><span style="color:#50FA7B;">create</span><span style="color:#F8F8F2;">(baseOptions)</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> errors</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> WarningMessage</span><span style="color:#F8F8F2;">[] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> []</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> tips</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> WarningMessage</span><span style="color:#F8F8F2;">[] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      let</span><span style="color:#50FA7B;"> warn</span><span style="color:#FF79C6;"> =</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">        msg</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> WarningMessage</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">        range</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> { start</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> number</span><span style="color:#F8F8F2;">; end</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> number</span><span style="color:#F8F8F2;"> },</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">        tip</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span></span>
<span class="line"><span style="color:#F8F8F2;">      ) </span><span style="color:#FF79C6;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">        ;(tip </span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;"> tips </span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> errors).</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">(msg)</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (options) {</span></span>
<span class="line"><span style="color:#6272A4;">        // merge custom modules</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (options.modules) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          finalOptions.modules </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> (baseOptions.modules </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> []).</span><span style="color:#50FA7B;">concat</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#F8F8F2;">            options.modules</span></span>
<span class="line"><span style="color:#F8F8F2;">          )</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#6272A4;">        // merge custom directives</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (options.directives) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          finalOptions.directives </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> extend</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#F8F8F2;">            Object.</span><span style="color:#50FA7B;">create</span><span style="color:#F8F8F2;">(baseOptions.directives </span><span style="color:#FF79C6;">||</span><span style="color:#BD93F9;"> null</span><span style="color:#F8F8F2;">),</span></span>
<span class="line"><span style="color:#F8F8F2;">            options.directives</span></span>
<span class="line"><span style="color:#F8F8F2;">          )</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#6272A4;">        // copy other options</span></span>
<span class="line"><span style="color:#FF79C6;">        for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> key </span><span style="color:#FF79C6;">in</span><span style="color:#F8F8F2;"> options) {</span></span>
<span class="line"><span style="color:#FF79C6;">          if</span><span style="color:#F8F8F2;"> (key </span><span style="color:#FF79C6;">!==</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F1FA8C;">modules</span><span style="color:#E9F284;">&#39;</span><span style="color:#FF79C6;"> &amp;&amp;</span><span style="color:#F8F8F2;"> key </span><span style="color:#FF79C6;">!==</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F1FA8C;">directives</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">            finalOptions[key] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options[key </span><span style="color:#FF79C6;">as</span><span style="color:#FF79C6;"> keyof</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">          }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">      finalOptions.warn </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> warn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> compiled </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> baseCompile</span><span style="color:#F8F8F2;">(template.</span><span style="color:#50FA7B;">trim</span><span style="color:#F8F8F2;">(), finalOptions)</span></span>
<span class="line"><span style="color:#F8F8F2;">      compiled.errors </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> errors</span></span>
<span class="line"><span style="color:#F8F8F2;">      compiled.tips </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> tips</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#F8F8F2;"> compiled</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">      compile,</span></span>
<span class="line"><span style="color:#F8F8F2;">      compileToFunctions</span><span style="color:#FF79C6;">:</span><span style="color:#50FA7B;"> createCompileToFunctionFn</span><span style="color:#F8F8F2;">(compile)</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>src/compiler createCompileToFunctionFn</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> createCompileToFunctionFn</span><span style="color:#F8F8F2;">(</span><span style="color:#50FA7B;">compile</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Function</span><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> Function</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> cache </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Object.</span><span style="color:#50FA7B;">create</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">null</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> compileToFunctions</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    template</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    options</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    vm</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> Component</span></span>
<span class="line"><span style="color:#F8F8F2;">  )</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompiledFunctionResult</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    options </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> extend</span><span style="color:#F8F8F2;">({}, options);</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> warn </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.warn </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> baseWarn;</span></span>
<span class="line"><span style="color:#FF79C6;">    delete</span><span style="color:#F8F8F2;"> options.warn;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    // check cache</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> key </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.delimiters</span></span>
<span class="line"><span style="color:#FF79C6;">      ?</span><span style="color:#50FA7B;"> String</span><span style="color:#F8F8F2;">(options.delimiters) </span><span style="color:#FF79C6;">+</span><span style="color:#F8F8F2;"> template</span></span>
<span class="line"><span style="color:#FF79C6;">      :</span><span style="color:#F8F8F2;"> template;</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (cache[key]) {</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#F8F8F2;"> cache[key];</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    // compile</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> compiled </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> compile</span><span style="color:#F8F8F2;">(template, options);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    // turn code into functions</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> res</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> any</span><span style="color:#FF79C6;"> =</span><span style="color:#F8F8F2;"> {};</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> fnGenErrors</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> any</span><span style="color:#F8F8F2;">[] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> [];</span></span>
<span class="line"><span style="color:#F8F8F2;">    res.render </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> createFunction</span><span style="color:#F8F8F2;">(compiled.render, fnGenErrors);</span></span>
<span class="line"><span style="color:#F8F8F2;">    res.staticRenderFns </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> compiled.staticRenderFns.</span><span style="color:#50FA7B;">map</span><span style="color:#F8F8F2;">((</span><span style="color:#FFB86C;font-style:italic;">code</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#50FA7B;"> createFunction</span><span style="color:#F8F8F2;">(code, fnGenErrors);</span></span>
<span class="line"><span style="color:#F8F8F2;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#F8F8F2;"> (cache[key] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> res);</span></span>
<span class="line"><span style="color:#F8F8F2;">  };</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="parse" tabindex="-1"><a class="header-anchor" href="#parse"><span>parse</span></a></h2><p><img src="/blog/assets/1680123400715085332-BV_vpXwi.png" alt="" loading="lazy"><img src="/blog/assets/1680123400719161947-BCt6Aq9f.png" alt="" loading="lazy"> type 为 1 表示是普通元素，为 2 表示是表达式，为 3 表示是纯文本</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> ast </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> parse</span><span style="color:#F8F8F2;">(template.</span><span style="color:#50FA7B;">trim</span><span style="color:#F8F8F2;">(), options);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><code>parse</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#6272A4;">//将HTML模板字符串转化为AST</span></span>
<span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> parse</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">template</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">options</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTElement</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#6272A4;">  //...</span></span>
<span class="line"><span style="color:#6272A4;">  // 一些配置的处理</span></span>
<span class="line"><span style="color:#6272A4;">  // 这个变量是比较重要的，通过这个栈暂存对 parseHTML 返回的结果</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> stack</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> any</span><span style="color:#F8F8F2;">[] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> [];</span></span>
<span class="line"><span style="color:#50FA7B;">  parseHTML</span><span style="color:#F8F8F2;">(template, {</span></span>
<span class="line"><span style="color:#F8F8F2;">    warn,</span></span>
<span class="line"><span style="color:#F8F8F2;">    expectHTML</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.expectHTML,</span></span>
<span class="line"><span style="color:#F8F8F2;">    isUnaryTag</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.isUnaryTag,</span></span>
<span class="line"><span style="color:#F8F8F2;">    canBeLeftOpenTag</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.canBeLeftOpenTag,</span></span>
<span class="line"><span style="color:#F8F8F2;">    shouldDecodeNewlines</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.shouldDecodeNewlines,</span></span>
<span class="line"><span style="color:#F8F8F2;">    shouldDecodeNewlinesForHref</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.shouldDecodeNewlinesForHref,</span></span>
<span class="line"><span style="color:#F8F8F2;">    shouldKeepComment</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.comments,</span></span>
<span class="line"><span style="color:#F8F8F2;">    outputSourceRange</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> options.outputSourceRange,</span></span>
<span class="line"><span style="color:#6272A4;">    // 当解析到开始标签时，调用该函数</span></span>
<span class="line"><span style="color:#50FA7B;">    start</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">tag</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">attrs</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">unary</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">start</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">end</span><span style="color:#F8F8F2;">) {},</span></span>
<span class="line"><span style="color:#6272A4;">    // 当解析到结束标签时，调用该函数</span></span>
<span class="line"><span style="color:#50FA7B;">    end</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">tag</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">start</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">end</span><span style="color:#F8F8F2;">) {},</span></span>
<span class="line"><span style="color:#6272A4;">    // 当解析到文本时，调用该函数</span></span>
<span class="line"><span style="color:#50FA7B;">    chars</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">text</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">start</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> number</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">end</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> number</span><span style="color:#F8F8F2;">) {},</span></span>
<span class="line"><span style="color:#6272A4;">    // 当解析到注释时，调用该函数</span></span>
<span class="line"><span style="color:#50FA7B;">    comment</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">text</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">start</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">end</span><span style="color:#F8F8F2;">) {},</span></span>
<span class="line"><span style="color:#F8F8F2;">  });</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#F8F8F2;"> root;</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="html-解析" tabindex="-1"><a class="header-anchor" href="#html-解析"><span>HTML 解析</span></a></h2><p>流程 <code>parseHTML</code><code>parseStartTag</code><code>handleStartTag</code><code>start</code></p><h3 id="parsehtml" tabindex="-1"><a class="header-anchor" href="#parsehtml"><span>parseHTML</span></a></h3><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> parseHTML</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">html</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">options</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> HTMLParserOptions</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> stack</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> any</span><span style="color:#F8F8F2;">[] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> []; </span><span style="color:#6272A4;">// 维护AST节点层级的栈</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> expectHTML </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.expectHTML;</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> isUnaryTag </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.isUnaryTag </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> no;</span></span>
<span class="line"><span style="color:#6272A4;">  //用来检测一个标签是否是可以省略闭合标签的非自闭合标签</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> canBeLeftOpenTag </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.canBeLeftOpenTag </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> no;</span></span>
<span class="line"><span style="color:#FF79C6;">  let</span><span style="color:#F8F8F2;"> index </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">; </span><span style="color:#6272A4;">//解析游标，标识当前从何处开始解析模板字符串</span></span>
<span class="line"><span style="color:#FF79C6;">  let</span><span style="color:#F8F8F2;"> last, </span><span style="color:#6272A4;">// 存储剩余还未解析的模板字符串</span></span>
<span class="line"><span style="color:#F8F8F2;">    lastTag; </span><span style="color:#6272A4;">// 存储着位于 stack 栈顶的元素</span></span>
<span class="line"><span style="color:#FF79C6;">  while</span><span style="color:#F8F8F2;"> (html) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    last </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html;</span></span>
<span class="line"><span style="color:#6272A4;">    // 确保即将 parse 的内容不是在纯文本标签里 (script,style,textarea)</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">lastTag </span><span style="color:#FF79C6;">||</span><span style="color:#FF79C6;"> !</span><span style="color:#50FA7B;">isPlainTextElement</span><span style="color:#F8F8F2;">(lastTag)) {</span></span>
<span class="line"><span style="color:#FF79C6;">      let</span><span style="color:#F8F8F2;"> textEnd </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">indexOf</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">&lt;</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#6272A4;">      /**</span></span>
<span class="line"><span style="color:#6272A4;">       * 如果html字符串是以&#39;&lt;&#39;开头,则有以下几种可能</span></span>
<span class="line"><span style="color:#6272A4;">       * 开始标签:&lt;div&gt;</span></span>
<span class="line"><span style="color:#6272A4;">       * 结束标签:&lt;/div&gt;</span></span>
<span class="line"><span style="color:#6272A4;">       * 注释:&lt;!-- 我是注释 --&gt;</span></span>
<span class="line"><span style="color:#6272A4;">       * 条件注释:&lt;!-- [if !IE] --&gt; &lt;!-- [endif] --&gt;</span></span>
<span class="line"><span style="color:#6272A4;">       * DOCTYPE:&lt;!DOCTYPE html&gt;</span></span>
<span class="line"><span style="color:#6272A4;">       * 需要一一去匹配尝试</span></span>
<span class="line"><span style="color:#6272A4;">       */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (textEnd </span><span style="color:#FF79C6;">===</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#6272A4;">        // Comment:</span></span>
<span class="line"><span style="color:#6272A4;">        //  /^&lt;!\--/</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (comment.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(html)) {</span></span>
<span class="line"><span style="color:#FF79C6;">          const</span><span style="color:#F8F8F2;"> commentEnd </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">indexOf</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">--&gt;</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">          if</span><span style="color:#F8F8F2;"> (commentEnd </span><span style="color:#FF79C6;">&gt;=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">            if</span><span style="color:#F8F8F2;"> (options.shouldKeepComment </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> options.comment) {</span></span>
<span class="line"><span style="color:#F8F8F2;">              options.</span><span style="color:#50FA7B;">comment</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#F8F8F2;">                html.</span><span style="color:#50FA7B;">substring</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">4</span><span style="color:#F8F8F2;">, commentEnd),</span></span>
<span class="line"><span style="color:#F8F8F2;">                index,</span></span>
<span class="line"><span style="color:#F8F8F2;">                index </span><span style="color:#FF79C6;">+</span><span style="color:#F8F8F2;"> commentEnd </span><span style="color:#FF79C6;">+</span><span style="color:#BD93F9;"> 3</span></span>
<span class="line"><span style="color:#F8F8F2;">              );</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#50FA7B;">            advance</span><span style="color:#F8F8F2;">(commentEnd </span><span style="color:#FF79C6;">+</span><span style="color:#BD93F9;"> 3</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">            continue</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">          }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#6272A4;">        //  /^&lt;!\[/</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (conditionalComment.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(html)) {</span></span>
<span class="line"><span style="color:#FF79C6;">          const</span><span style="color:#F8F8F2;"> conditionalEnd </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">indexOf</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">]&gt;</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">          if</span><span style="color:#F8F8F2;"> (conditionalEnd </span><span style="color:#FF79C6;">&gt;=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#50FA7B;">            advance</span><span style="color:#F8F8F2;">(conditionalEnd </span><span style="color:#FF79C6;">+</span><span style="color:#BD93F9;"> 2</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">            continue</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">          }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        // Doctype:</span></span>
<span class="line"><span style="color:#6272A4;">        // /^&lt;!DOCTYPE [^&gt;]+&gt;/i</span></span>
<span class="line"><span style="color:#FF79C6;">        const</span><span style="color:#F8F8F2;"> doctypeMatch </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">match</span><span style="color:#F8F8F2;">(doctype);</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (doctypeMatch) {</span></span>
<span class="line"><span style="color:#50FA7B;">          advance</span><span style="color:#F8F8F2;">(doctypeMatch[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].length);</span></span>
<span class="line"><span style="color:#FF79C6;">          continue</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        // End tag:</span></span>
<span class="line"><span style="color:#FF79C6;">        const</span><span style="color:#F8F8F2;"> endTagMatch </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">match</span><span style="color:#F8F8F2;">(endTag);</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (endTagMatch) {</span></span>
<span class="line"><span style="color:#FF79C6;">          const</span><span style="color:#F8F8F2;"> curIndex </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> index;</span></span>
<span class="line"><span style="color:#50FA7B;">          advance</span><span style="color:#F8F8F2;">(endTagMatch[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].length);</span></span>
<span class="line"><span style="color:#50FA7B;">          parseEndTag</span><span style="color:#F8F8F2;">(endTagMatch[</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">], curIndex, index);</span></span>
<span class="line"><span style="color:#FF79C6;">          continue</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        // Start tag:</span></span>
<span class="line"><span style="color:#FF79C6;">        const</span><span style="color:#F8F8F2;"> startTagMatch </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> parseStartTag</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (startTagMatch) {</span></span>
<span class="line"><span style="color:#50FA7B;">          handleStartTag</span><span style="color:#F8F8F2;">(startTagMatch);</span></span>
<span class="line"><span style="color:#FF79C6;">          if</span><span style="color:#F8F8F2;"> (</span><span style="color:#50FA7B;">shouldIgnoreFirstNewline</span><span style="color:#F8F8F2;">(startTagMatch.tagName, html)) {</span></span>
<span class="line"><span style="color:#50FA7B;">            advance</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">          }</span></span>
<span class="line"><span style="color:#FF79C6;">          continue</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      let</span><span style="color:#F8F8F2;"> text, rest, next;</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (textEnd </span><span style="color:#FF79C6;">&gt;=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        rest </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">slice</span><span style="color:#F8F8F2;">(textEnd);</span></span>
<span class="line"><span style="color:#FF79C6;">        while</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#FF79C6;">          !</span><span style="color:#F8F8F2;">endTag.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(rest) </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#FF79C6;">          !</span><span style="color:#F8F8F2;">startTagOpen.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(rest) </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#FF79C6;">          !</span><span style="color:#F8F8F2;">comment.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(rest) </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#FF79C6;">          !</span><span style="color:#F8F8F2;">conditionalComment.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(rest)</span></span>
<span class="line"><span style="color:#F8F8F2;">        ) {</span></span>
<span class="line"><span style="color:#6272A4;">          // &lt; in plain text, be forgiving and treat it as text</span></span>
<span class="line"><span style="color:#F8F8F2;">          next </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> rest.</span><span style="color:#50FA7B;">indexOf</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">&lt;</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">          if</span><span style="color:#F8F8F2;"> (next </span><span style="color:#FF79C6;">&lt;</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">break</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">          textEnd </span><span style="color:#FF79C6;">+=</span><span style="color:#F8F8F2;"> next;</span></span>
<span class="line"><span style="color:#F8F8F2;">          rest </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">slice</span><span style="color:#F8F8F2;">(textEnd);</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">        text </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">substring</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">, textEnd);</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (textEnd </span><span style="color:#FF79C6;">&lt;</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        text </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html;</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (text) {</span></span>
<span class="line"><span style="color:#50FA7B;">        advance</span><span style="color:#F8F8F2;">(text.length);</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (options.chars </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> text) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        options.</span><span style="color:#50FA7B;">chars</span><span style="color:#F8F8F2;">(text, index </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> text.length, index);</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#6272A4;">    //将整个字符串作为文本对待</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (html </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> last) {</span></span>
<span class="line"><span style="color:#F8F8F2;">      options.chars </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> options.</span><span style="color:#50FA7B;">chars</span><span style="color:#F8F8F2;">(html);</span></span>
<span class="line"><span style="color:#FF79C6;">      break</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">  // Clean up any remaining tags</span></span>
<span class="line"><span style="color:#50FA7B;">  parseEndTag</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  function</span><span style="color:#50FA7B;"> advance</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">n</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    index </span><span style="color:#FF79C6;">+=</span><span style="color:#F8F8F2;"> n;</span></span>
<span class="line"><span style="color:#F8F8F2;">    html </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">substring</span><span style="color:#F8F8F2;">(n);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#6272A4;">  //第一件事是解析出开始标签名称；第二件事是解析出开始标签的属性</span></span>
<span class="line"><span style="color:#FF79C6;">  function</span><span style="color:#50FA7B;"> parseStartTag</span><span style="color:#F8F8F2;">() {}</span></span>
<span class="line"><span style="color:#6272A4;">  //标签处理</span></span>
<span class="line"><span style="color:#6272A4;">  /*</span></span>
<span class="line"><span style="color:#6272A4;">     处理前</span></span>
<span class="line"><span style="color:#6272A4;">    [</span></span>
<span class="line"><span style="color:#6272A4;">      [&#39; v-if=&quot;isShow&quot;&#39;, &#39;v-if&#39;, &#39;=&#39;, &#39;isShow&#39;, null, null],</span></span>
<span class="line"><span style="color:#6272A4;">      [&#39; class=&quot;header&quot;&#39;, &#39;class&#39;, &#39;=&#39;, &#39;header&#39;, null, null]</span></span>
<span class="line"><span style="color:#6272A4;">    ]</span></span>
<span class="line"><span style="color:#6272A4;">     处理后</span></span>
<span class="line"><span style="color:#6272A4;">    [</span></span>
<span class="line"><span style="color:#6272A4;">      { name: &#39;v-if&#39;, value: &#39;isShow&#39;, start: 5, end: 18 },</span></span>
<span class="line"><span style="color:#6272A4;">      { name: &#39;class&#39;, value: &#39;header&#39;, start: 19, end: 33 }</span></span>
<span class="line"><span style="color:#6272A4;">    ]</span></span>
<span class="line"><span style="color:#6272A4;">      */</span></span>
<span class="line"><span style="color:#FF79C6;">  function</span><span style="color:#50FA7B;"> handleStartTag</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">match</span><span style="color:#F8F8F2;">) {}</span></span>
<span class="line"><span style="color:#6272A4;">  //parse 结束标签</span></span>
<span class="line"><span style="color:#FF79C6;">  function</span><span style="color:#50FA7B;"> parseEndTag</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">tagName</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> any</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">start</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> any</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">end</span><span style="color:#FF79C6;">?:</span><span style="color:#8BE9FD;font-style:italic;"> any</span><span style="color:#F8F8F2;">) {}</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="parsestarttag" tabindex="-1"><a class="header-anchor" href="#parsestarttag"><span><code>parseStartTag</code></span></a></h3><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> ncname </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">[a-zA-Z_][</span><span style="color:#FF79C6;">\\</span><span style="color:#F1FA8C;">w</span><span style="color:#FF79C6;">\\</span><span style="color:#F1FA8C;">-</span><span style="color:#FF79C6;">\\</span><span style="color:#F1FA8C;">.]*</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> qnameCapture </span><span style="color:#FF79C6;">=</span><span style="color:#F1FA8C;"> `((?:</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">ncname</span><span style="color:#FF79C6;">}\\</span><span style="color:#F1FA8C;">:)?</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">ncname</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;">)`</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> startTagOpen </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;font-weight:bold;"> new</span><span style="color:#50FA7B;"> RegExp</span><span style="color:#F8F8F2;">(</span><span style="color:#F1FA8C;">`^&lt;</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">qnameCapture</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;">`</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> startTagClose </span><span style="color:#FF79C6;">=</span><span style="color:#FF5555;"> /</span><span style="color:#FF79C6;">^</span><span style="color:#BD93F9;">\s</span><span style="color:#FF79C6;">*</span><span style="color:#FFB86C;">(</span><span style="color:#F1FA8C;">\/</span><span style="color:#FF79C6;">?</span><span style="color:#FFB86C;">)</span><span style="color:#F1FA8C;">&gt;</span><span style="color:#FF5555;">/</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> parseStartTag</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> start </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">match</span><span style="color:#F8F8F2;">(startTagOpen);</span></span>
<span class="line"><span style="color:#6272A4;">  // &#39;&lt;div&gt;&lt;/div&gt;&#39;.match(startTagOpen)  =&gt; [&#39;&lt;div&#39;,&#39;div&#39;,index:0,input:&#39;&lt;div&gt;&lt;/div&gt;&#39;]</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (start) {</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> match </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">      tagName</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> start[</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">      attrs</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> [],</span></span>
<span class="line"><span style="color:#F8F8F2;">      start</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> index,</span></span>
<span class="line"><span style="color:#F8F8F2;">    };</span></span>
<span class="line"><span style="color:#50FA7B;">    advance</span><span style="color:#F8F8F2;">(start[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].length);</span></span>
<span class="line"><span style="color:#FF79C6;">    let</span><span style="color:#F8F8F2;"> end, attr;</span></span>
<span class="line"><span style="color:#6272A4;">    /**</span></span>
<span class="line"><span style="color:#6272A4;">     * &lt;div a=1 b=2 c=3&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#6272A4;">     * 从&lt;div之后到开始标签的结束符号&#39;&gt;&#39;之前，一直匹配属性attrs</span></span>
<span class="line"><span style="color:#6272A4;">     * 所有属性匹配完之后，html字符串还剩下</span></span>
<span class="line"><span style="color:#6272A4;">     * 自闭合标签剩下：&#39;/&gt;&#39;</span></span>
<span class="line"><span style="color:#6272A4;">     * 非自闭合标签剩下：&#39;&gt;&lt;/div&gt;&#39;</span></span>
<span class="line"><span style="color:#6272A4;">     */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    /*</span></span>
<span class="line"><span style="color:#6272A4;">    </span></span>
<span class="line"><span style="color:#6272A4;">    const attribute = /^\s*([^\s&quot;&#39;&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&#39;([^&#39;]*)&#39;+|([^\s&quot;&#39;=&lt;&gt;`]+)))?/</span></span>
<span class="line"><span style="color:#6272A4;">    let html = &#39;class=&quot;a&quot; id=&quot;b&quot;&gt;&lt;/div&gt;&#39;</span></span>
<span class="line"><span style="color:#6272A4;">    let attr = html.match(attribute)</span></span>
<span class="line"><span style="color:#6272A4;">    console.log(attr)</span></span>
<span class="line"><span style="color:#6272A4;">    [&quot;class=&quot;a&quot;&quot;, &quot;class&quot;, &quot;=&quot;, &quot;a&quot;, undefined, undefined, index: 0, input: &quot;class=&quot;a&quot; id=&quot;b&quot;&gt;&lt;/div&gt;&quot;, groups: undefined]</span></span>
<span class="line"><span style="color:#6272A4;">    </span></span>
<span class="line"><span style="color:#6272A4;">    */</span></span>
<span class="line"><span style="color:#FF79C6;">    while</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#FF79C6;">      !</span><span style="color:#F8F8F2;">(end </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">match</span><span style="color:#F8F8F2;">(startTagClose)) </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F8F8F2;">      (attr </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> html.</span><span style="color:#50FA7B;">match</span><span style="color:#F8F8F2;">(attribute))</span></span>
<span class="line"><span style="color:#F8F8F2;">    ) {</span></span>
<span class="line"><span style="color:#50FA7B;">      advance</span><span style="color:#F8F8F2;">(attr[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].length);</span></span>
<span class="line"><span style="color:#F8F8F2;">      match.attrs.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">(attr);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    /**</span></span>
<span class="line"><span style="color:#6272A4;">     * 这里判断了该标签是否为自闭合标签</span></span>
<span class="line"><span style="color:#6272A4;">     * 自闭合标签如:&lt;input type=&#39;text&#39; /&gt;</span></span>
<span class="line"><span style="color:#6272A4;">     * 非自闭合标签如:&lt;div&gt;&lt;/div&gt;</span></span>
<span class="line"><span style="color:#6272A4;">     * const startTagClose = /^\s*(\/?)&gt;/</span></span>
<span class="line"><span style="color:#6272A4;">     * let end = html.match(startTagClose)</span></span>
<span class="line"><span style="color:#6272A4;">     * &#39;&gt;&lt;/div&gt;&#39;.match(startTagClose) =&gt; [&quot;&gt;&quot;, &quot;&quot;, index: 0, input: &quot;&gt;&lt;/div&gt;&quot;, groups: undefined]</span></span>
<span class="line"><span style="color:#6272A4;">     * &#39;/&gt;&lt;div&gt;&lt;/div&gt;&#39;.match(startTagClose) =&gt; [&quot;/&gt;&quot;, &quot;/&quot;, index: 0, input: &quot;/&gt;&lt;div&gt;&lt;/div&gt;&quot;, groups: undefined]</span></span>
<span class="line"><span style="color:#6272A4;">     * 因此，我们可以通过end[1]是否是&quot;/&quot;来判断该标签是否是自闭合标签</span></span>
<span class="line"><span style="color:#6272A4;">     */</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (end) {</span></span>
<span class="line"><span style="color:#F8F8F2;">      match.unarySlash </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> end[</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">];</span></span>
<span class="line"><span style="color:#50FA7B;">      advance</span><span style="color:#F8F8F2;">(end[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].length);</span></span>
<span class="line"><span style="color:#F8F8F2;">      match.end </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> index;</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#F8F8F2;"> match;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="handlestarttag" tabindex="-1"><a class="header-anchor" href="#handlestarttag"><span>handleStartTag</span></a></h3><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> handleStartTag</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">match</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#6272A4;">  // 开始标签的标签名</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> tagName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> match.tagName;</span></span>
<span class="line"><span style="color:#6272A4;">  // 是否为自闭合标签的标志，自闭合为&quot;&quot;,非自闭合为&quot;/&quot;</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> unarySlash </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> match.unarySlash;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (expectHTML) {</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (lastTag </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">p</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;"> &amp;&amp;</span><span style="color:#50FA7B;"> isNonPhrasingTag</span><span style="color:#F8F8F2;">(tagName)) {</span></span>
<span class="line"><span style="color:#50FA7B;">      parseEndTag</span><span style="color:#F8F8F2;">(lastTag);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (</span><span style="color:#50FA7B;">canBeLeftOpenTag</span><span style="color:#F8F8F2;">(tagName) </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> lastTag </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> tagName) {</span></span>
<span class="line"><span style="color:#50FA7B;">      parseEndTag</span><span style="color:#F8F8F2;">(tagName);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#6272A4;">  // 布尔值，标志是否为自闭合标签</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> unary </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> isUnaryTag</span><span style="color:#F8F8F2;">(tagName) </span><span style="color:#FF79C6;">||</span><span style="color:#FF79C6;"> !!</span><span style="color:#F8F8F2;">unarySlash;</span></span>
<span class="line"><span style="color:#6272A4;">  // match.attrs 数组的长度</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> l </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> match.attrs.length;</span></span>
<span class="line"><span style="color:#6272A4;">  // 一个与match.attrs数组长度相等的数组</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> attrs</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTAttr</span><span style="color:#F8F8F2;">[] </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;font-weight:bold;"> new</span><span style="color:#50FA7B;"> Array</span><span style="color:#F8F8F2;">(l);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">; i </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> l; i</span><span style="color:#FF79C6;">++</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> args </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> match.attrs[i];</span></span>
<span class="line"><span style="color:#6272A4;">    //const args = [&quot;class=&quot;a&quot;&quot;, &quot;class&quot;, &quot;=&quot;, &quot;a&quot;, undefined, undefined, index: 0, input: &quot;class=&quot;a&quot; id=&quot;b&quot;&gt;&lt;/div&gt;&quot;, groups: undefined]</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> value </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> args[</span><span style="color:#BD93F9;">3</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> args[</span><span style="color:#BD93F9;">4</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> args[</span><span style="color:#BD93F9;">5</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">||</span><span style="color:#E9F284;"> &quot;&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> shouldDecodeNewlines </span><span style="color:#FF79C6;">=</span></span>
<span class="line"><span style="color:#F8F8F2;">      tagName </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">a</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;"> &amp;&amp;</span><span style="color:#F8F8F2;"> args[</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">href</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#FF79C6;">        ?</span><span style="color:#F8F8F2;"> options.shouldDecodeNewlinesForHref</span></span>
<span class="line"><span style="color:#FF79C6;">        :</span><span style="color:#F8F8F2;"> options.shouldDecodeNewlines;</span></span>
<span class="line"><span style="color:#F8F8F2;">    attrs[i] </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">      name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> args[</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">      value</span><span style="color:#FF79C6;">:</span><span style="color:#50FA7B;"> decodeAttr</span><span style="color:#F8F8F2;">(value, shouldDecodeNewlines),</span></span>
<span class="line"><span style="color:#F8F8F2;">    };</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">unary) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    stack.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">({</span></span>
<span class="line"><span style="color:#F8F8F2;">      tag</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> tagName,</span></span>
<span class="line"><span style="color:#F8F8F2;">      lowerCasedTag</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> tagName.</span><span style="color:#50FA7B;">toLowerCase</span><span style="color:#F8F8F2;">(),</span></span>
<span class="line"><span style="color:#F8F8F2;">      attrs</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> attrs,</span></span>
<span class="line"><span style="color:#F8F8F2;">      start</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> match.start,</span></span>
<span class="line"><span style="color:#F8F8F2;">      end</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> match.end,</span></span>
<span class="line"><span style="color:#F8F8F2;">    });</span></span>
<span class="line"><span style="color:#F8F8F2;">    lastTag </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> tagName;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (options.start) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    options.</span><span style="color:#50FA7B;">start</span><span style="color:#F8F8F2;">(tagName, attrs, unary, match.start, match.end);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="start" tabindex="-1"><a class="header-anchor" href="#start"><span>start</span></a></h3><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#50FA7B;">    start</span><span style="color:#F8F8F2;">(tag, attrs, unary, start, end) {</span></span>
<span class="line"><span style="color:#6272A4;">      // check namespace.</span></span>
<span class="line"><span style="color:#6272A4;">      // inherit parent ns if there is one</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> ns </span><span style="color:#FF79C6;">=</span></span>
<span class="line"><span style="color:#F8F8F2;">        (currentParent </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> currentParent.ns) </span><span style="color:#FF79C6;">||</span><span style="color:#50FA7B;"> platformGetTagNamespace</span><span style="color:#F8F8F2;">(tag)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">      // handle IE svg bug</span></span>
<span class="line"><span style="color:#6272A4;">      /* istanbul ignore if */</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (isIE </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> ns </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F1FA8C;">svg</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        attrs </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> guardIESVGBug</span><span style="color:#F8F8F2;">(attrs)</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      let</span><span style="color:#F8F8F2;"> element</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTElement</span><span style="color:#FF79C6;"> =</span><span style="color:#50FA7B;"> createASTElement</span><span style="color:#F8F8F2;">(tag, attrs, currentParent)</span></span>
<span class="line"><span style="color:#6272A4;">      /*</span></span>
<span class="line"><span style="color:#6272A4;">      export function createASTElement (tag,attrs,parent) {</span></span>
<span class="line"><span style="color:#6272A4;">        return {</span></span>
<span class="line"><span style="color:#6272A4;">          type: 1,</span></span>
<span class="line"><span style="color:#6272A4;">          tag,</span></span>
<span class="line"><span style="color:#6272A4;">          attrsList: attrs,</span></span>
<span class="line"><span style="color:#6272A4;">          attrsMap: makeAttrsMap(attrs),</span></span>
<span class="line"><span style="color:#6272A4;">          parent,</span></span>
<span class="line"><span style="color:#6272A4;">          children: []</span></span>
<span class="line"><span style="color:#6272A4;">        }</span></span>
<span class="line"><span style="color:#6272A4;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">      */</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (ns) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        element.ns </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> ns</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#50FA7B;">isForbiddenTag</span><span style="color:#F8F8F2;">(element) </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#50FA7B;">isServerRendering</span><span style="color:#F8F8F2;">()) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        element.forbidden </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> true</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">      // apply pre-transforms</span></span>
<span class="line"><span style="color:#FF79C6;">      for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">; i </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> preTransforms.length; i</span><span style="color:#FF79C6;">++</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        element </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> preTransforms[i](element, options) </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> element</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">inVPre) {</span></span>
<span class="line"><span style="color:#50FA7B;">        processPre</span><span style="color:#F8F8F2;">(element)</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (element.pre) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          inVPre </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> true</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#50FA7B;">platformIsPreTag</span><span style="color:#F8F8F2;">(element.tag)) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        inPre </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> true</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (inVPre) {</span></span>
<span class="line"><span style="color:#50FA7B;">        processRawAttrs</span><span style="color:#F8F8F2;">(element)</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">element.processed) {</span></span>
<span class="line"><span style="color:#6272A4;">        // structural directives</span></span>
<span class="line"><span style="color:#50FA7B;">        processFor</span><span style="color:#F8F8F2;">(element)</span></span>
<span class="line"><span style="color:#50FA7B;">        processIf</span><span style="color:#F8F8F2;">(element)</span></span>
<span class="line"><span style="color:#50FA7B;">        processOnce</span><span style="color:#F8F8F2;">(element)</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">root) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        root </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> element</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (__DEV__) {</span></span>
<span class="line"><span style="color:#50FA7B;">          checkRootConstraints</span><span style="color:#F8F8F2;">(root)</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">unary) {</span></span>
<span class="line"><span style="color:#6272A4;">        // 指定当前父元素</span></span>
<span class="line"><span style="color:#6272A4;">        // end 出栈的时候 会重新指定</span></span>
<span class="line"><span style="color:#F8F8F2;">        currentParent </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> element</span></span>
<span class="line"><span style="color:#F8F8F2;">        stack.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">(element)</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#50FA7B;">        closeElement</span><span style="color:#F8F8F2;">(element)</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    },</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="文本解析" tabindex="-1"><a class="header-anchor" href="#文本解析"><span>文本解析</span></a></h2><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#50FA7B;">    chars</span><span style="color:#F8F8F2;">(text: string, start</span><span style="color:#FF79C6;">?:</span><span style="color:#F8F8F2;"> number, end</span><span style="color:#FF79C6;">?:</span><span style="color:#F8F8F2;"> number) {</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">currentParent) {</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#6272A4;">      // IE textarea placeholder bug</span></span>
<span class="line"><span style="color:#6272A4;">      /* istanbul ignore if */</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#F8F8F2;">        isIE </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F8F8F2;">        currentParent.tag </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F1FA8C;">textarea</span><span style="color:#E9F284;">&#39;</span><span style="color:#FF79C6;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#F8F8F2;">        currentParent.attrsMap.placeholder </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> text</span></span>
<span class="line"><span style="color:#F8F8F2;">      ) {</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#6272A4;">      //start push element 会将 currentParent =&gt; element</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> children </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> currentParent.children</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (inPre </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> text.</span><span style="color:#50FA7B;">trim</span><span style="color:#F8F8F2;">()) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        text </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> isTextTag</span><span style="color:#F8F8F2;">(currentParent)</span></span>
<span class="line"><span style="color:#FF79C6;">          ?</span><span style="color:#F8F8F2;"> text</span></span>
<span class="line"><span style="color:#FF79C6;">          :</span><span style="color:#F8F8F2;"> (</span><span style="color:#50FA7B;">decodeHTMLCached</span><span style="color:#F8F8F2;">(text) </span><span style="color:#FF79C6;">as</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">children.length) {</span></span>
<span class="line"><span style="color:#6272A4;">        // remove the whitespace-only node right after an opening tag</span></span>
<span class="line"><span style="color:#F8F8F2;">        text </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &#39;&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (whitespaceOption) {</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (whitespaceOption </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F1FA8C;">condense</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#6272A4;">          // in condense mode, remove the whitespace node if it contains</span></span>
<span class="line"><span style="color:#6272A4;">          // line break, otherwise condense to a single space</span></span>
<span class="line"><span style="color:#F8F8F2;">          text </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> lineBreakRE.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(text) </span><span style="color:#FF79C6;">?</span><span style="color:#E9F284;"> &#39;&#39;</span><span style="color:#FF79C6;"> :</span><span style="color:#E9F284;"> &#39;</span><span style="color:#E9F284;"> &#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">        } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">          text </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &#39;</span><span style="color:#E9F284;"> &#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">        text </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> preserveWhitespace </span><span style="color:#FF79C6;">?</span><span style="color:#E9F284;"> &#39;</span><span style="color:#E9F284;"> &#39;</span><span style="color:#FF79C6;"> :</span><span style="color:#E9F284;"> &#39;&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (text) {</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">inPre </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> whitespaceOption </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F1FA8C;">condense</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#6272A4;">          // condense consecutive whitespaces into single space</span></span>
<span class="line"><span style="color:#F8F8F2;">          text </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> text.</span><span style="color:#50FA7B;">replace</span><span style="color:#F8F8F2;">(whitespaceRE, </span><span style="color:#E9F284;">&#39;</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#FF79C6;">        let</span><span style="color:#F8F8F2;"> res</span></span>
<span class="line"><span style="color:#FF79C6;">        let</span><span style="color:#F8F8F2;"> child</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTNode</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> undefined</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">inVPre </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> text </span><span style="color:#FF79C6;">!==</span><span style="color:#E9F284;"> &#39;</span><span style="color:#E9F284;"> &#39;</span><span style="color:#FF79C6;"> &amp;&amp;</span><span style="color:#F8F8F2;"> (res </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> parseText</span><span style="color:#F8F8F2;">(text, delimiters))) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          child </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">            type</span><span style="color:#FF79C6;">:</span><span style="color:#BD93F9;"> 2</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">            expression</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> res.expression,</span></span>
<span class="line"><span style="color:#F8F8F2;">            tokens</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> res.tokens,</span></span>
<span class="line"><span style="color:#F8F8F2;">            text</span></span>
<span class="line"><span style="color:#F8F8F2;">          }</span></span>
<span class="line"><span style="color:#F8F8F2;">        } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#F8F8F2;">          text </span><span style="color:#FF79C6;">!==</span><span style="color:#E9F284;"> &#39;</span><span style="color:#E9F284;"> &#39;</span><span style="color:#FF79C6;"> ||</span></span>
<span class="line"><span style="color:#FF79C6;">          !</span><span style="color:#F8F8F2;">children.length </span><span style="color:#FF79C6;">||</span></span>
<span class="line"><span style="color:#F8F8F2;">          children[children.length </span><span style="color:#FF79C6;">-</span><span style="color:#BD93F9;"> 1</span><span style="color:#F8F8F2;">].text </span><span style="color:#FF79C6;">!==</span><span style="color:#E9F284;"> &#39;</span><span style="color:#E9F284;"> &#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">        ) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          child </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">            type</span><span style="color:#FF79C6;">:</span><span style="color:#BD93F9;"> 3</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">            text</span></span>
<span class="line"><span style="color:#F8F8F2;">          }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (child) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          children.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">(child)</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    },</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#6272A4;">//text = &quot;我叫{{name}}，我今年{{age}}岁了&quot;</span></span>
<span class="line"><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> res </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> parseText</span><span style="color:#F8F8F2;">(text)</span></span>
<span class="line"><span style="color:#F8F8F2;">res </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    expression</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">我叫</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">+</span><span style="color:#50FA7B;">_s</span><span style="color:#F8F8F2;">(name)</span><span style="color:#FF79C6;">+</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">，我今年</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">+</span><span style="color:#50FA7B;">_s</span><span style="color:#F8F8F2;">(age)</span><span style="color:#FF79C6;">+</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">岁了</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">    tokens</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;">[</span></span>
<span class="line"><span style="color:#E9F284;">        &quot;</span><span style="color:#F1FA8C;">我叫</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">@binding</span><span style="color:#E9F284;">&#39;</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> name },</span></span>
<span class="line"><span style="color:#E9F284;">        &quot;</span><span style="color:#F1FA8C;">，我今年</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">@binding</span><span style="color:#E9F284;">&#39;</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> age },</span></span>
<span class="line"><span style="color:#E9F284;">     &quot;</span><span style="color:#F1FA8C;">岁了</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">    ]</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="parsetext" tabindex="-1"><a class="header-anchor" href="#parsetext"><span>parseText</span></a></h3><ul><li>判断传入的文本是否包含变量</li><li>构造 expression</li><li>构造 tokens</li></ul><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> defaultTagRE </span><span style="color:#FF79C6;">=</span><span style="color:#FF5555;"> /</span><span style="color:#F1FA8C;">\{\{</span><span style="color:#FFB86C;">((?:</span><span style="color:#BD93F9;">.</span><span style="color:#FF79C6;">|</span><span style="color:#BD93F9;">\n</span><span style="color:#FFB86C;">)</span><span style="color:#FF79C6;">+?</span><span style="color:#FFB86C;">)</span><span style="color:#F1FA8C;">\}\}</span><span style="color:#FF5555;">/</span><span style="color:#FF79C6;">g</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> buildRegex </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> cached</span><span style="color:#F8F8F2;">((</span><span style="color:#FFB86C;font-style:italic;">delimiters</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> open </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> delimiters[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].</span><span style="color:#50FA7B;">replace</span><span style="color:#F8F8F2;">(regexEscapeRE, </span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">\\</span><span style="color:#F1FA8C;">$&amp;</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> close </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> delimiters[</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">].</span><span style="color:#50FA7B;">replace</span><span style="color:#F8F8F2;">(regexEscapeRE, </span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">\\</span><span style="color:#F1FA8C;">$&amp;</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#FF79C6;font-weight:bold;"> new</span><span style="color:#50FA7B;"> RegExp</span><span style="color:#F8F8F2;">(open </span><span style="color:#FF79C6;">+</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">((?:.|</span><span style="color:#FF79C6;">\\</span><span style="color:#F1FA8C;">n)+?)</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;"> +</span><span style="color:#F8F8F2;"> close, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">g</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">});</span></span>
<span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> parseText</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">text</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">delimiters</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> tagRE </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> delimiters </span><span style="color:#FF79C6;">?</span><span style="color:#50FA7B;"> buildRegex</span><span style="color:#F8F8F2;">(delimiters) </span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> defaultTagRE;</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">tagRE.</span><span style="color:#50FA7B;">test</span><span style="color:#F8F8F2;">(text)) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> tokens </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> [];</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> rawTokens </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> [];</span></span>
<span class="line"><span style="color:#6272A4;">  /**</span></span>
<span class="line"><span style="color:#6272A4;">   * let lastIndex = tagRE.lastIndex = 0</span></span>
<span class="line"><span style="color:#6272A4;">   * 上面这行代码等同于下面这两行代码:</span></span>
<span class="line"><span style="color:#6272A4;">   * tagRE.lastIndex = 0</span></span>
<span class="line"><span style="color:#6272A4;">   * let lastIndex = tagRE.lastIndex</span></span>
<span class="line"><span style="color:#6272A4;">   */</span></span>
<span class="line"><span style="color:#FF79C6;">  let</span><span style="color:#F8F8F2;"> lastIndex </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> (tagRE.lastIndex </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">  let</span><span style="color:#F8F8F2;"> match, index, tokenValue;</span></span>
<span class="line"><span style="color:#FF79C6;">  while</span><span style="color:#F8F8F2;"> ((match </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> tagRE.</span><span style="color:#50FA7B;">exec</span><span style="color:#F8F8F2;">(text))) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    index </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> match.index;</span></span>
<span class="line"><span style="color:#6272A4;">    // push text token</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (index </span><span style="color:#FF79C6;">&gt;</span><span style="color:#F8F8F2;"> lastIndex) {</span></span>
<span class="line"><span style="color:#6272A4;">      // 先把&#39;{{&#39;前面的文本放入tokens中
      rawTokens.push((tokenValue = text.slice(lastIndex, index)));
      tokens.push(JSON.stringify(tokenValue));
    }
    // tag token
    // 取出&#39;{{ }}&#39;中间的变量exp</span></span>
<span class="line"><span style="color:#FF79C6;">    const</span><span style="color:#F8F8F2;"> exp </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> parseFilters</span><span style="color:#F8F8F2;">(match[</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">].</span><span style="color:#50FA7B;">trim</span><span style="color:#F8F8F2;">());</span></span>
<span class="line"><span style="color:#6272A4;">    // 把变量exp改成_s(exp)形式也放入tokens中</span></span>
<span class="line"><span style="color:#F8F8F2;">    tokens.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">(</span><span style="color:#F1FA8C;">`_s(</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">exp</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;">)`</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    rawTokens.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">({ </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">@binding</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> exp });</span></span>
<span class="line"><span style="color:#6272A4;">    // 设置lastIndex 以保证下一轮循环时，只从&#39;}}&#39;后面再开始匹配正则</span></span>
<span class="line"><span style="color:#F8F8F2;">    lastIndex </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> index </span><span style="color:#FF79C6;">+</span><span style="color:#F8F8F2;"> match[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].length;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#6272A4;">  // 当剩下的text不再被正则匹配上时，表示所有变量已经处理完毕</span></span>
<span class="line"><span style="color:#6272A4;">  // 此时如果lastIndex &lt; text.length，表示在最后一个变量后面还有文本</span></span>
<span class="line"><span style="color:#6272A4;">  // 最后将后面的文本再加入到tokens中</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (lastIndex </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> text.length) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    rawTokens.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">((tokenValue </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> text.</span><span style="color:#50FA7B;">slice</span><span style="color:#F8F8F2;">(lastIndex)));</span></span>
<span class="line"><span style="color:#F8F8F2;">    tokens.</span><span style="color:#50FA7B;">push</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">JSON</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">stringify</span><span style="color:#F8F8F2;">(tokenValue));</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">  // 最后把数组tokens中的所有元素用&#39;+&#39;拼接起来</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    expression</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> tokens.</span><span style="color:#50FA7B;">join</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">+</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">),</span></span>
<span class="line"><span style="color:#F8F8F2;">    tokens</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> rawTokens,</span></span>
<span class="line"><span style="color:#F8F8F2;">  };</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="optimize" tabindex="-1"><a class="header-anchor" href="#optimize"><span>optimize</span></a></h2><p>在优化阶段将所有静态节点都打上标记，这样在 patch 过程中就可以跳过对比这些节点。</p><ul><li>在 AST 中找出所有静态节点并打上标记；</li><li>在 AST 中找出所有静态根节点并打上标记；</li></ul><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> optimize</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  root</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTElement</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> null</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> undefined</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  options</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span></span>
<span class="line"><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">root) </span><span style="color:#FF79C6;">return</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  isStaticKey </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> genStaticKeysCached</span><span style="color:#F8F8F2;">(options.staticKeys </span><span style="color:#FF79C6;">||</span><span style="color:#E9F284;"> &quot;&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">  isPlatformReservedTag </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> options.isReservedTag </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> no;</span></span>
<span class="line"><span style="color:#6272A4;">  // 标记静态节点</span></span>
<span class="line"><span style="color:#50FA7B;">  markStatic</span><span style="color:#F8F8F2;">(root);</span></span>
<span class="line"><span style="color:#6272A4;">  // 标记静态根节点</span></span>
<span class="line"><span style="color:#50FA7B;">  markStaticRoots</span><span style="color:#F8F8F2;">(root, </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="markstatic" tabindex="-1"><a class="header-anchor" href="#markstatic"><span>markStatic</span></a></h3><p><strong>从根节点开始，先标记根节点是否为静态节点，然后看根节点如果是元素节点，那么就去向下递归它的子节点，子节点如果还有子节点那就继续向下递归，直到标记完所有节点。</strong></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> markStatic</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">node</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTNode</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">  node.static </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> isStatic</span><span style="color:#F8F8F2;">(node);</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (node.type </span><span style="color:#FF79C6;">===</span><span style="color:#BD93F9;"> 1</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#6272A4;">    // do not make component slot content static. this avoids</span></span>
<span class="line"><span style="color:#6272A4;">    // 1. components not able to mutate slot nodes</span></span>
<span class="line"><span style="color:#6272A4;">    // 2. static slot content fails for hot-reloading</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#FF79C6;">      !</span><span style="color:#50FA7B;">isPlatformReservedTag</span><span style="color:#F8F8F2;">(node.tag) </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F8F8F2;">      node.tag </span><span style="color:#FF79C6;">!==</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">slot</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#F8F8F2;">      node.attrsMap[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">inline-template</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">==</span><span style="color:#BD93F9;"> null</span></span>
<span class="line"><span style="color:#F8F8F2;">    ) {</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#FF79C6;">    for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">, l </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> node.children.length; i </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> l; i</span><span style="color:#FF79C6;">++</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> child </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> node.children[i];</span></span>
<span class="line"><span style="color:#50FA7B;">      markStatic</span><span style="color:#F8F8F2;">(child);</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">child.static) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        node.static </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> false</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (node.ifConditions) {</span></span>
<span class="line"><span style="color:#FF79C6;">      for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 1</span><span style="color:#F8F8F2;">, l </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> node.ifConditions.length; i </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> l; i</span><span style="color:#FF79C6;">++</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">        const</span><span style="color:#F8F8F2;"> block </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> node.ifConditions[i].block;</span></span>
<span class="line"><span style="color:#50FA7B;">        markStatic</span><span style="color:#F8F8F2;">(block);</span></span>
<span class="line"><span style="color:#FF79C6;">        if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">block.static) {</span></span>
<span class="line"><span style="color:#F8F8F2;">          node.static </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> false</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>type 取值</th><th style="text-align:center;">对应的 AST 节点类型</th></tr></thead><tbody><tr><td>1</td><td style="text-align:center;">元素节点</td></tr><tr><td>2</td><td style="text-align:center;">包含变量的动态文本节点</td></tr><tr><td>3</td><td style="text-align:center;">不包含变量的纯文本节点</td></tr></tbody></table><ul><li>如果节点使用了 v-pre 指令，那就断定它是静态节点；</li><li>如果节点没有使用 v-pre 指令，那它要成为静态节点必须满足： <ul><li>不能使用动态绑定语法，即标签上不能有 v-、@、:开头的属性；</li><li>不能使用 v-if、v-else、v-for 指令；</li><li>不能是内置组件，即标签名不能是 slot 和 component；</li><li>标签名必须是平台保留标签，即不能是组件；</li><li>当前节点的父节点不能是带有 v-for 的 template 标签；</li><li>节点的所有属性的 key 都必须是静态节点才有的 key，注：静态节点的 key 是有限的，它只能是 type,tag,attrsList,attrsMap,plain,parent,children,attrs 之一；</li></ul></li></ul><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> isStatic</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">node</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTNode</span><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> boolean</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (node.type </span><span style="color:#FF79C6;">===</span><span style="color:#BD93F9;"> 2</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#6272A4;">    // 包含变量的动态文本节点</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#BD93F9;"> false</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (node.type </span><span style="color:#FF79C6;">===</span><span style="color:#BD93F9;"> 3</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#6272A4;">    // 不包含变量的纯文本节点</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#BD93F9;"> true</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#FF79C6;"> !!</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#F8F8F2;">    node.pre </span><span style="color:#FF79C6;">||</span></span>
<span class="line"><span style="color:#F8F8F2;">    (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">node.hasBindings </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#6272A4;"> // no dynamic bindings</span></span>
<span class="line"><span style="color:#FF79C6;">      !</span><span style="color:#F8F8F2;">node.if </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#FF79C6;">      !</span><span style="color:#F8F8F2;">node.for </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#6272A4;"> // not v-if or v-for or v-else</span></span>
<span class="line"><span style="color:#FF79C6;">      !</span><span style="color:#50FA7B;">isBuiltInTag</span><span style="color:#F8F8F2;">(node.tag) </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#6272A4;"> // not a built-in</span></span>
<span class="line"><span style="color:#50FA7B;">      isPlatformReservedTag</span><span style="color:#F8F8F2;">(node.tag) </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#6272A4;"> // not a component</span></span>
<span class="line"><span style="color:#FF79C6;">      !</span><span style="color:#50FA7B;">isDirectChildOfTemplateFor</span><span style="color:#F8F8F2;">(node) </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F8F8F2;">      Object.</span><span style="color:#50FA7B;">keys</span><span style="color:#F8F8F2;">(node).</span><span style="color:#50FA7B;">every</span><span style="color:#F8F8F2;">(isStaticKey))</span></span>
<span class="line"><span style="color:#F8F8F2;">  );</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="markstaticroots" tabindex="-1"><a class="header-anchor" href="#markstaticroots"><span>markStaticRoots</span></a></h3><ul><li>节点本身必须是静态节点；</li><li>必须拥有子节点 children；</li><li>子节点不能只是只有一个文本节点； 否则的话，对它的优化成本将大于优化后带来的收益。</li></ul><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> markStaticRoots</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">node</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTNode</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">isInFor</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> boolean</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (node.type </span><span style="color:#FF79C6;">===</span><span style="color:#BD93F9;"> 1</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (node.static </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> node.once) {</span></span>
<span class="line"><span style="color:#F8F8F2;">      node.staticInFor </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> isInFor;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#6272A4;">    // For a node to qualify as a static root, it should have children that</span></span>
<span class="line"><span style="color:#6272A4;">    // are not just static text. Otherwise the cost of hoisting out will</span></span>
<span class="line"><span style="color:#6272A4;">    // outweigh the benefits and it&#39;s better off to just always render it fresh.</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (</span></span>
<span class="line"><span style="color:#F8F8F2;">      node.static </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F8F8F2;">      node.children.length </span><span style="color:#FF79C6;">&amp;&amp;</span></span>
<span class="line"><span style="color:#FF79C6;">      !</span><span style="color:#F8F8F2;">(node.children.length </span><span style="color:#FF79C6;">===</span><span style="color:#BD93F9;"> 1</span><span style="color:#FF79C6;"> &amp;&amp;</span><span style="color:#F8F8F2;"> node.children[</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">].type </span><span style="color:#FF79C6;">===</span><span style="color:#BD93F9;"> 3</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    ) {</span></span>
<span class="line"><span style="color:#F8F8F2;">      node.staticRoot </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> true</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">      node.staticRoot </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> false</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (node.children) {</span></span>
<span class="line"><span style="color:#FF79C6;">      for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">, l </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> node.children.length; i </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> l; i</span><span style="color:#FF79C6;">++</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#50FA7B;">        markStaticRoots</span><span style="color:#F8F8F2;">(node.children[i], isInFor </span><span style="color:#FF79C6;">||</span><span style="color:#FF79C6;"> !!</span><span style="color:#F8F8F2;">node.for);</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (node.ifConditions) {</span></span>
<span class="line"><span style="color:#FF79C6;">      for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 1</span><span style="color:#F8F8F2;">, l </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> node.ifConditions.length; i </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> l; i</span><span style="color:#FF79C6;">++</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#50FA7B;">        markStaticRoots</span><span style="color:#F8F8F2;">(node.ifConditions[i].block, isInFor);</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="generate" tabindex="-1"><a class="header-anchor" href="#generate"><span>generate</span></a></h2><p>AST =&gt; render <code>template</code></p><div class="language-html line-numbers-mode" data-highlighter="shiki" data-ext="html" data-title="html" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">template</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">  &lt;</span><span style="color:#FF79C6;">div</span><span style="color:#50FA7B;font-style:italic;"> id</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">app</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">    &lt;</span><span style="color:#FF79C6;">input</span><span style="color:#50FA7B;font-style:italic;"> v-focus</span><span style="color:#F8F8F2;"> /&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">  &lt;/</span><span style="color:#FF79C6;">div</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">template</span><span style="color:#F8F8F2;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AST</code><img src="/blog/assets/1680123400809154438-GoS9ncp1.png" alt="" loading="lazy"><br><code>render</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#50FA7B;">_c</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">div</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, { attrs</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> { id</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">app</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> } }, [</span></span>
<span class="line"><span style="color:#50FA7B;">  _c</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">input</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, { directives</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> [{ name</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">focus</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, rawName</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">v-focus</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> }] }),</span></span>
<span class="line"><span style="color:#F8F8F2;">]);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">const</span><span style="color:#F8F8F2;"> code </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> generate</span><span style="color:#F8F8F2;">(ast, options);</span></span>
<span class="line"><span style="color:#FF79C6;">return</span><span style="color:#F8F8F2;"> { render</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> code.render };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> generate</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  ast</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTElement</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> void</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">  options</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CompilerOptions</span></span>
<span class="line"><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CodegenResult</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> state </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;font-weight:bold;"> new</span><span style="color:#50FA7B;"> CodegenState</span><span style="color:#F8F8F2;">(options);</span></span>
<span class="line"><span style="color:#FF79C6;">  const</span><span style="color:#F8F8F2;"> code </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> ast </span><span style="color:#FF79C6;">?</span><span style="color:#50FA7B;"> genSSRElement</span><span style="color:#F8F8F2;">(ast, state) </span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &#39;</span><span style="color:#F1FA8C;">_c(&quot;div&quot;)</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">  return</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    render</span><span style="color:#FF79C6;">:</span><span style="color:#F1FA8C;"> `with(this){return </span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">code</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;">}`</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">    staticRenderFns</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> state.staticRenderFns,</span></span>
<span class="line"><span style="color:#F8F8F2;">  };</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">function</span><span style="color:#50FA7B;"> genSSRElement</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">el</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTElement</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">state</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CodegenState</span><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (el.for </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.forProcessed) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genFor</span><span style="color:#F8F8F2;">(el, state, genSSRElement);</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el.if </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.ifProcessed) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genIf</span><span style="color:#F8F8F2;">(el, state, genSSRElement);</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el.tag </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">template</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;"> &amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.slotTarget) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#F8F8F2;"> el.ssrOptimizability </span><span style="color:#FF79C6;">===</span><span style="color:#F8F8F2;"> optimizability.</span><span style="color:#BD93F9;">FULL</span></span>
<span class="line"><span style="color:#FF79C6;">      ?</span><span style="color:#50FA7B;"> genChildrenAsStringNode</span><span style="color:#F8F8F2;">(el, state)</span></span>
<span class="line"><span style="color:#FF79C6;">      :</span><span style="color:#50FA7B;"> genSSRChildren</span><span style="color:#F8F8F2;">(el, state) </span><span style="color:#FF79C6;">||</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">void 0</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  switch</span><span style="color:#F8F8F2;"> (el.ssrOptimizability) {</span></span>
<span class="line"><span style="color:#FF79C6;">    case</span><span style="color:#F8F8F2;"> optimizability.</span><span style="color:#BD93F9;">FULL</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#6272A4;">      // stringify whole tree</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#50FA7B;"> genStringElement</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#FF79C6;">    case</span><span style="color:#F8F8F2;"> optimizability.</span><span style="color:#BD93F9;">SELF</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#6272A4;">      // stringify self and check children</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#50FA7B;"> genStringElementWithChildren</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#FF79C6;">    case</span><span style="color:#F8F8F2;"> optimizability.</span><span style="color:#BD93F9;">CHILDREN</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#6272A4;">      // generate self as VNode and stringify children</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#50FA7B;"> genNormalElement</span><span style="color:#F8F8F2;">(el, state, </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">    case</span><span style="color:#F8F8F2;"> optimizability.</span><span style="color:#BD93F9;">PARTIAL</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#6272A4;">      // generate self as VNode and check children</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#50FA7B;"> genNormalElement</span><span style="color:#F8F8F2;">(el, state, </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">    default</span><span style="color:#F8F8F2;">:</span></span>
<span class="line"><span style="color:#6272A4;">      // bail whole tree</span></span>
<span class="line"><span style="color:#FF79C6;">      return</span><span style="color:#50FA7B;"> genElement</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>genElement</code></p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">export</span><span style="color:#FF79C6;"> function</span><span style="color:#50FA7B;"> genElement</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">el</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> ASTElement</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">state</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> CodegenState</span><span style="color:#F8F8F2;">)</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (el.parent) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    el.pre </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> el.pre </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> el.parent.pre;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">  if</span><span style="color:#F8F8F2;"> (el.staticRoot </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.staticProcessed) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genStatic</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el.once </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.onceProcessed) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genOnce</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el.for </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.forProcessed) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genFor</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el.if </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.ifProcessed) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genIf</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el.tag </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">template</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;"> &amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">el.slotTarget </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">state.pre) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genChildren</span><span style="color:#F8F8F2;">(el, state) </span><span style="color:#FF79C6;">||</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">void 0</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (el.tag </span><span style="color:#FF79C6;">===</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">slot</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#50FA7B;"> genSlot</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#6272A4;">    // component or element</span></span>
<span class="line"><span style="color:#FF79C6;">    let</span><span style="color:#F8F8F2;"> code;</span></span>
<span class="line"><span style="color:#FF79C6;">    if</span><span style="color:#F8F8F2;"> (el.component) {</span></span>
<span class="line"><span style="color:#F8F8F2;">      code </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> genComponent</span><span style="color:#F8F8F2;">(el.component, el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#FF79C6;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#FF79C6;">      let</span><span style="color:#F8F8F2;"> data;</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">el.plain </span><span style="color:#FF79C6;">||</span><span style="color:#F8F8F2;"> (el.pre </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> state.</span><span style="color:#50FA7B;">maybeComponent</span><span style="color:#F8F8F2;">(el))) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        data </span><span style="color:#FF79C6;">=</span><span style="color:#50FA7B;"> genData</span><span style="color:#F8F8F2;">(el, state);</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      let</span><span style="color:#F8F8F2;"> tag</span><span style="color:#FF79C6;">:</span><span style="color:#8BE9FD;font-style:italic;"> string</span><span style="color:#FF79C6;"> |</span><span style="color:#8BE9FD;font-style:italic;"> undefined</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#6272A4;">      // check if this is a component in &lt;script setup&gt;</span></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> bindings </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> state.options.bindings;</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (bindings </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> bindings.__isScriptSetup </span><span style="color:#FF79C6;">!==</span><span style="color:#BD93F9;"> false</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        tag </span><span style="color:#FF79C6;">=</span></span>
<span class="line"><span style="color:#50FA7B;">          checkBindingType</span><span style="color:#F8F8F2;">(bindings, el.tag) </span><span style="color:#FF79C6;">||</span></span>
<span class="line"><span style="color:#50FA7B;">          checkBindingType</span><span style="color:#F8F8F2;">(bindings, </span><span style="color:#50FA7B;">camelize</span><span style="color:#F8F8F2;">(el.tag)) </span><span style="color:#FF79C6;">||</span></span>
<span class="line"><span style="color:#50FA7B;">          checkBindingType</span><span style="color:#F8F8F2;">(bindings, </span><span style="color:#50FA7B;">capitalize</span><span style="color:#F8F8F2;">(</span><span style="color:#50FA7B;">camelize</span><span style="color:#F8F8F2;">(el.tag)));</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"><span style="color:#FF79C6;">      if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">tag) tag </span><span style="color:#FF79C6;">=</span><span style="color:#F1FA8C;"> `&#39;</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">el.tag</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;">&#39;`</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">      const</span><span style="color:#F8F8F2;"> children </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> el.inlineTemplate </span><span style="color:#FF79C6;">?</span><span style="color:#BD93F9;"> null</span><span style="color:#FF79C6;"> :</span><span style="color:#50FA7B;"> genChildren</span><span style="color:#F8F8F2;">(el, state, </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">      code </span><span style="color:#FF79C6;">=</span><span style="color:#F1FA8C;"> `_c(</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">tag</span><span style="color:#FF79C6;">}${</span></span>
<span class="line"><span style="color:#F8F8F2;">        data</span><span style="color:#FF79C6;"> ?</span><span style="color:#F1FA8C;"> `,</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">data</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;">`</span><span style="color:#FF79C6;"> :</span><span style="color:#E9F284;"> &quot;&quot;</span><span style="color:#6272A4;"> // data</span></span>
<span class="line"><span style="color:#FF79C6;">      }${</span></span>
<span class="line"><span style="color:#F8F8F2;">        children</span><span style="color:#FF79C6;"> ?</span><span style="color:#F1FA8C;"> `,</span><span style="color:#FF79C6;">${</span><span style="color:#F8F8F2;">children</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;">`</span><span style="color:#FF79C6;"> :</span><span style="color:#E9F284;"> &quot;&quot;</span><span style="color:#6272A4;"> // children</span></span>
<span class="line"><span style="color:#FF79C6;">      }</span><span style="color:#F1FA8C;">)`</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#6272A4;">    // module transforms</span></span>
<span class="line"><span style="color:#FF79C6;">    for</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 0</span><span style="color:#F8F8F2;">; i </span><span style="color:#FF79C6;">&lt;</span><span style="color:#F8F8F2;"> state.transforms.length; i</span><span style="color:#FF79C6;">++</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">      code </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> state.transforms[i](el, code);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#FF79C6;">    return</span><span style="color:#F8F8F2;"> code;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/blog/vue2/vue-loader-code-analysis.html" aria-label="vue-loader-15.9.8代码分析"><div class="hint">Next<span class="arrow end"></span></div><div class="link">vue-loader-15.9.8代码分析<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-CbGq5X0e.js" defer></script>
  </body>
</html>
