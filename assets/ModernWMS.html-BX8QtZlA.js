import{_ as n,e as a,g as l,o as e}from"./app-Dt3FNJM0.js";const p={};function o(t,s){return e(),a("div",null,s[0]||(s[0]=[l(`<h2 id="startup" tabindex="-1"><a class="header-anchor" href="#startup"><span>startup</span></a></h2><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> Startup</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">summary</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        /// startup</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">summary</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">param</span><span style="color:#50FA7B;font-style:italic;"> name</span><span style="color:#6272A4;">=</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">configuration</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">&gt;</span><span style="color:#6272A4;">Config</span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">param</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#FF79C6;">        public</span><span style="color:#50FA7B;"> Startup</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> configuration</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            Configuration </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration;</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        public</span><span style="color:#8BE9FD;font-style:italic;"> IConfiguration</span><span style="color:#F8F8F2;"> Configuration { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">summary</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        ///  register service </span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">summary</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">param</span><span style="color:#50FA7B;font-style:italic;"> name</span><span style="color:#6272A4;">=</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">services</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">&gt;</span><span style="color:#6272A4;">services</span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">param</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#FF79C6;">        public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> ConfigureServices</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IServiceCollection</span><span style="color:#FFB86C;font-style:italic;"> services</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            services.</span><span style="color:#50FA7B;">AddExtensionsService</span><span style="color:#F8F8F2;">(Configuration);</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">summary</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        /// configure</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">summary</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">param</span><span style="color:#50FA7B;font-style:italic;"> name</span><span style="color:#6272A4;">=</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">app</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">&gt;</span><span style="color:#6272A4;">app</span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">param</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">param</span><span style="color:#50FA7B;font-style:italic;"> name</span><span style="color:#6272A4;">=</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">env</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">&gt;</span><span style="color:#6272A4;">env</span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">param</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#6272A4;">        /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">param</span><span style="color:#50FA7B;font-style:italic;"> name</span><span style="color:#6272A4;">=</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">serviceProvider</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">&gt;</span><span style="color:#6272A4;">serviceProvider</span><span style="color:#F8F8F2;">&lt;/</span><span style="color:#FF79C6;">param</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#FF79C6;">        public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Configure</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IApplicationBuilder</span><span style="color:#FFB86C;font-style:italic;"> app</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">IWebHostEnvironment</span><span style="color:#FFB86C;font-style:italic;"> env</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">IServiceProvider</span><span style="color:#FFB86C;font-style:italic;"> service_provider</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            app.</span><span style="color:#50FA7B;">UseExtensionsConfigure</span><span style="color:#F8F8F2;">(env, service_provider, Configuration);</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="configuration" tabindex="-1"><a class="header-anchor" href="#configuration"><span>configuration</span></a></h3><p><code>configuration</code>æ˜¯é…ç½®ï¼Œç”¨æ¥è·å–é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ ä¾‹å¦‚ï¼š <code>appsettings.json</code></p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" data-title="json" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#8BE9FE;">  &quot;</span><span style="color:#8BE9FD;">MyAppSettings</span><span style="color:#8BE9FE;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#8BE9FE;">    &quot;</span><span style="color:#8BE9FD;">ApiKey</span><span style="color:#8BE9FE;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">123456</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ Configuration[&quot;MyAppSettings:ApiKey&quot;] æ¥è¯»å–è¿™ä¸ªå€¼ã€‚</p><h3 id="configureservices" tabindex="-1"><a class="header-anchor" href="#configureservices"><span>ConfigureServices</span></a></h3><p>å°†ä½ éœ€è¦çš„æœåŠ¡æ·»åŠ åˆ°ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­ã€‚æ‰€æœ‰é€šè¿‡ services.AddXxx() æ·»åŠ çš„æœåŠ¡éƒ½å¯ä»¥åœ¨æ§åˆ¶å™¨ã€æœåŠ¡ç±»ä¸­æ³¨å…¥ä½¿ç”¨ã€‚</p><ul><li>è¯¥æ–¹æ³•æ˜¯å¯é€‰çš„</li><li>è¯¥æ–¹æ³•ç”¨äºæ·»åŠ æœåŠ¡åˆ°DIå®¹å™¨ä¸­</li><li>è¯¥æ–¹æ³•åœ¨Configureæ–¹æ³•ä¹‹å‰è¢«è°ƒç”¨</li><li>è¯¥æ–¹æ³•è¦ä¹ˆæ— å‚æ•°ï¼Œè¦ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªå‚æ•°ä¸”ç±»å‹å¿…é¡»ä¸ºIServiceCollection</li><li>è¯¥æ–¹æ³•å†…çš„ä»£ç å¤§å¤šæ˜¯å½¢å¦‚Add{Service}çš„æ‰©å±•æ–¹æ³•</li></ul><p><code>AddExtensionsService</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">     public</span><span style="color:#FF79C6;"> static</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> AddExtensionsService</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">this</span><span style="color:#8BE9FD;font-style:italic;"> IServiceCollection</span><span style="color:#FFB86C;font-style:italic;"> services</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> configuration</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">     {  </span></span>
<span class="line"><span style="color:#6272A4;">        // æ³¨å†Œæœ¬åœ°åŒ–æ”¯æŒ</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddLocalization</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddSingleton</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IStringLocalizer</span><span style="color:#F8F8F2;">&gt;((</span><span style="color:#FFB86C;font-style:italic;">sp</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">         {  </span></span>
<span class="line"><span style="color:#6272A4;">            // æ³¨å…¥ IStringLocalizerï¼Œé»˜è®¤ä½¿ç”¨æ³›å‹ç‰ˆ IStringLocalizer&lt;MultiLanguage&gt;ï¼Œå®ç°å¤šè¯­è¨€åŠŸèƒ½ã€‚</span></span>
<span class="line"><span style="color:#FF79C6;">             var</span><span style="color:#F8F8F2;"> sharedLocalizer </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> sp.</span><span style="color:#50FA7B;">GetRequiredService</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IStringLocalizer</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">MultiLanguage</span><span style="color:#F8F8F2;">&gt;&gt;();</span></span>
<span class="line"><span style="color:#FF79C6;">             return</span><span style="color:#F8F8F2;"> sharedLocalizer;</span></span>
<span class="line"><span style="color:#F8F8F2;">         });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        //  ç”¨äºå‘é€ HTTP è¯·æ±‚ã€‚</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddHttpClient</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#6272A4;">        //  å…è®¸åœ¨æœåŠ¡ç±»ä¸­è®¿é—® HttpContextï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ã€è¯·æ±‚å¤´ç­‰ã€‚</span></span>
<span class="line"><span style="color:#6272A4;">        // </span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddSingleton</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IHttpContextAccessor</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">HttpContextAccessor</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        //  æ³¨å†Œç¼“å­˜ç®¡ç†å™¨</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddSingleton</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">CacheManager</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddSingleton</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IMemoryCache</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#FFB86C;font-style:italic;">factory</span><span style="color:#FF79C6;"> =&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">         {</span></span>
<span class="line"><span style="color:#FF79C6;">             var</span><span style="color:#F8F8F2;"> cache </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> MemoryCache</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> MemoryCacheOptions</span><span style="color:#F8F8F2;">());</span></span>
<span class="line"><span style="color:#FF79C6;">             return</span><span style="color:#F8F8F2;"> cache;</span></span>
<span class="line"><span style="color:#F8F8F2;">         });</span></span>
<span class="line"><span style="color:#6272A4;">        // æ•°æ®åº“è¿æ¥ï¼ˆå¤šæ•°æ®åº“æ”¯æŒï¼‰</span></span>
<span class="line"><span style="color:#FF79C6;">         var</span><span style="color:#F8F8F2;"> database_config </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#50FA7B;">GetSection</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">Database</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">db</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">];</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddDbContextPool</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">SqlDBContext</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#FFB86C;font-style:italic;">t</span><span style="color:#FF79C6;"> =&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">         {</span></span>
<span class="line"><span style="color:#FF79C6;">             if</span><span style="color:#F8F8F2;"> (database_config.</span><span style="color:#50FA7B;">ToUpper</span><span style="color:#F8F8F2;">() </span><span style="color:#FF79C6;">==</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">SQLLITE</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">             {</span></span>
<span class="line"><span style="color:#FF79C6;">                 var</span><span style="color:#F8F8F2;"> SqlLite_connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#50FA7B;">GetConnectionString</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">SqlLiteConn</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">                 t.</span><span style="color:#50FA7B;">UseSqlite</span><span style="color:#F8F8F2;">(SqlLite_connection, </span><span style="color:#FFB86C;font-style:italic;">b</span><span style="color:#FF79C6;"> =&gt;</span><span style="color:#F8F8F2;"> b.</span><span style="color:#50FA7B;">MigrationsAssembly</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">ModernWMS</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"><span style="color:#F8F8F2;">             }</span></span>
<span class="line"><span style="color:#FF79C6;">             else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (database_config.</span><span style="color:#50FA7B;">ToUpper</span><span style="color:#F8F8F2;">() </span><span style="color:#FF79C6;">==</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">MYSQL</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">             {</span></span>
<span class="line"><span style="color:#FF79C6;">                 var</span><span style="color:#F8F8F2;"> Mysql_connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#50FA7B;">GetConnectionString</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">MySqlConn</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">                 t.</span><span style="color:#50FA7B;">UseMySql</span><span style="color:#F8F8F2;">(Mysql_connection, </span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> MySqlServerVersion</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> Version</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">8</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">26</span><span style="color:#F8F8F2;">)));</span></span>
<span class="line"><span style="color:#F8F8F2;">             }</span></span>
<span class="line"><span style="color:#FF79C6;">             else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (database_config.</span><span style="color:#50FA7B;">ToUpper</span><span style="color:#F8F8F2;">() </span><span style="color:#FF79C6;">==</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">SQLSERVER</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">             {</span></span>
<span class="line"><span style="color:#FF79C6;">                 var</span><span style="color:#F8F8F2;"> SqlServer_connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#50FA7B;">GetConnectionString</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">SqlServerConn</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">                 t.</span><span style="color:#50FA7B;">UseSqlServer</span><span style="color:#F8F8F2;">(SqlServer_connection);</span></span>
<span class="line"><span style="color:#F8F8F2;">             }</span></span>
<span class="line"><span style="color:#FF79C6;">             else</span><span style="color:#FF79C6;"> if</span><span style="color:#F8F8F2;"> (database_config.</span><span style="color:#50FA7B;">ToUpper</span><span style="color:#F8F8F2;">() </span><span style="color:#FF79C6;">==</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">POSTGRES</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">             {</span></span>
<span class="line"><span style="color:#FF79C6;">                 var</span><span style="color:#F8F8F2;"> Postgre_connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration.</span><span style="color:#50FA7B;">GetConnectionString</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">PostGresConn</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">                 t.</span><span style="color:#50FA7B;">UseNpgsql</span><span style="color:#F8F8F2;">(Postgre_connection);</span></span>
<span class="line"><span style="color:#F8F8F2;">                 AppContext.</span><span style="color:#50FA7B;">SetSwitch</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">Npgsql.EnableLegacyTimestampBehavior</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">                 AppContext.</span><span style="color:#50FA7B;">SetSwitch</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">Npgsql.DisableDateTimeInfinityConversions</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">             }</span></span>
<span class="line"><span style="color:#F8F8F2;">             t.</span><span style="color:#50FA7B;">EnableSensitiveDataLogging</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">             t.</span><span style="color:#50FA7B;">UseLoggerFactory</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> LoggerFactory</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#F8F8F2;">[] { </span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> DebugLoggerProvider</span><span style="color:#F8F8F2;">() }));</span></span>
<span class="line"><span style="color:#F8F8F2;">         }, </span><span style="color:#BD93F9;">100</span><span style="color:#F8F8F2;">); ;</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddMemoryCache</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddScoped</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">MultiTenancy</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">ITenantProvider</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">MultiTenancy</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">TenantProvider</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddSwaggerService</span><span style="color:#F8F8F2;">(configuration, AppContext.BaseDirectory);</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddTokenGeneratorService</span><span style="color:#F8F8F2;">(configuration);</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">RegisterAssembly</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddControllers</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">c</span><span style="color:#FF79C6;"> =&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">         {</span></span>
<span class="line"><span style="color:#F8F8F2;">             c.Filters.</span><span style="color:#50FA7B;">Add</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">typeof</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">ViewModelActionFiter</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"><span style="color:#F8F8F2;">             c.MaxModelValidationErrors </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 99999</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">         }).</span><span style="color:#50FA7B;">ConfigureApiBehaviorOptions</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">o</span><span style="color:#FF79C6;"> =&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">         {</span></span>
<span class="line"><span style="color:#F8F8F2;">             o.SuppressModelStateInvalidFilter </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> true</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">         })</span><span style="color:#6272A4;">//format</span></span>
<span class="line"><span style="color:#F8F8F2;">           .</span><span style="color:#50FA7B;">AddNewtonsoftJson</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">options</span><span style="color:#FF79C6;"> =&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">           {</span></span>
<span class="line"><span style="color:#F8F8F2;">               options.SerializerSettings.ReferenceLoopHandling </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> ReferenceLoopHandling.Ignore;</span></span>
<span class="line"><span style="color:#F8F8F2;">               options.SerializerSettings.DateFormatString </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">yyyy-MM-dd HH:mm:ss</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">               options.SerializerSettings.Converters.</span><span style="color:#50FA7B;">Add</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> JsonStringTrimConverter</span><span style="color:#F8F8F2;">());</span></span>
<span class="line"><span style="color:#F8F8F2;">               options.SerializerSettings.Formatting </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Formatting.Indented;</span></span>
<span class="line"><span style="color:#F8F8F2;">               options.SerializerSettings.ContractResolver </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> Newtonsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Json</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Serialization</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">CamelCasePropertyNamesContractResolver</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">           }).</span><span style="color:#50FA7B;">AddDataAnnotationsLocalization</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">options</span><span style="color:#FF79C6;"> =&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">           {</span></span>
<span class="line"><span style="color:#F8F8F2;">               options.DataAnnotationLocalizerProvider </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FFB86C;font-style:italic;">type</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">factory</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">                   factory.</span><span style="color:#50FA7B;">Create</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">typeof</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">ModernWMS</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Core</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">MultiLanguage</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"><span style="color:#F8F8F2;">           });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">         // Hangfire</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddHangfire</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">x</span><span style="color:#FF79C6;"> =&gt;</span><span style="color:#F8F8F2;"> x.</span><span style="color:#50FA7B;">SetDataCompatibilityLevel</span><span style="color:#F8F8F2;">(CompatibilityLevel.Version_170)</span></span>
<span class="line"><span style="color:#F8F8F2;">             .</span><span style="color:#50FA7B;">UseSimpleAssemblyNameTypeSerializer</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">             .</span><span style="color:#50FA7B;">UseRecommendedSerializerSettings</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">             .</span><span style="color:#50FA7B;">UseStorage</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> MemoryStorage</span><span style="color:#F8F8F2;">()));</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddHangfireServer</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">         services.</span><span style="color:#50FA7B;">AddScoped</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">FunctionHelper</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"><span style="color:#F8F8F2;">     }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="addhttpclient" tabindex="-1"><a class="header-anchor" href="#addhttpclient"><span>AddHttpClient</span></a></h4><p>åœ¨ä¾èµ–æ³¨å…¥ï¼ˆDependency Injection, DIï¼‰å®¹å™¨ä¸­æ³¨å†Œ HttpClient å®ä¾‹ã€‚è¿™ä½¿å¾—ä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­æ–¹ä¾¿åœ°ä½¿ç”¨ HttpClient æ¥å‘é€ HTTP è¯·æ±‚ï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨ ASP.NET Core çš„ä¾èµ–æ³¨å…¥æœºåˆ¶æ¥ç®¡ç† HttpClient çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#6272A4;">// **æ³¨å†Œ**</span></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> ConfigureServices</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IServiceCollection</span><span style="color:#FFB86C;font-style:italic;"> services</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#F8F8F2;">    services.</span><span style="color:#50FA7B;">AddHttpClient</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"><span style="color:#6272A4;">// ä½¿ç”¨</span></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> MyController</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">ControllerBase</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> HttpClient</span><span style="color:#F8F8F2;"> _httpClient;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> MyController</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">HttpClient</span><span style="color:#FFB86C;font-style:italic;"> httpClient</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _httpClient </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> httpClient;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    [</span><span style="color:#8BE9FD;font-style:italic;">HttpGet</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">api/data</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)]</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> async</span><span style="color:#8BE9FD;font-style:italic;"> Task</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IActionResult</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#50FA7B;">GetData</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> response </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> await</span><span style="color:#F8F8F2;"> _httpClient.</span><span style="color:#50FA7B;">GetAsync</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">https://api.example.com/data</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> content </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> await</span><span style="color:#F8F8F2;"> response.Content.</span><span style="color:#50FA7B;">ReadAsStringAsync</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#50FA7B;"> Ok</span><span style="color:#F8F8F2;">(content);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="httpcontextaccessor" tabindex="-1"><a class="header-anchor" href="#httpcontextaccessor"><span>HttpContextAccessor</span></a></h4><div class="hint-container info"><p class="hint-container-title">httpContext</p><p>HttpContext æ˜¯ ASP.NET Core å¤„ç†æ¯ä¸€ä¸ª HTTP è¯·æ±‚æ—¶çš„é‡è¦å¯¹è±¡ã€‚</p><p>å®ƒåŒ…å«äº†è¯·æ±‚ã€å“åº”ã€ç”¨æˆ·ã€Sessionã€è¯·æ±‚å¤´ã€Cookies ç­‰ç­‰ä¿¡æ¯ã€‚</p><p>ä½†æ˜¯å®ƒé»˜è®¤åªèƒ½åœ¨ä¸­é—´ä»¶æˆ–æ§åˆ¶å™¨ä¸­ä½¿ç”¨ï¼Œåœ¨æ™®é€šçš„æœåŠ¡ç±»é‡Œæ˜¯æ— æ³•ç›´æ¥è®¿é—®çš„ã€‚</p></div><div class="hint-container info"><p class="hint-container-title"><code>AsyncLocal&lt;T&gt;</code></p><p>åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œä»»åŠ¡ï¼ˆ Task ï¼‰å¯èƒ½ä¼šåœ¨ä¸åŒçš„çº¿ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œè¿™ä½¿å¾—ä¼ ç»Ÿçš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆTLSï¼‰æ— æ³•æ­£ç¡®åœ°ç»´æŠ¤ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨å¼‚æ­¥æ–¹æ³•ä¸­ä½¿ç”¨ <code>ThreadLocal&lt;T&gt;</code> ï¼Œå¯èƒ½ä¼šå› ä¸ºä»»åŠ¡åˆ‡æ¢åˆ°ä¸åŒçš„çº¿ç¨‹è€Œå¯¼è‡´ä¸Šä¸‹æ–‡ä¸¢å¤±æˆ–æ··ä¹±ã€‚</p><p><code>AsyncLocal&lt;T&gt;</code> è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒç¡®ä¿åœ¨å¼‚æ­¥ä»»åŠ¡åˆ‡æ¢æ—¶ï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯èƒ½å¤Ÿæ­£ç¡®åœ°ä¼ æ’­å’Œä¿æŒä¸€è‡´ã€‚</p></div><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#6272A4;">// è®©ä½ åœ¨æœåŠ¡ç±»ã€å·¥å…·ç±»æˆ–ä¸­é—´ä»¶ä¹‹å¤–çš„åœ°æ–¹ï¼Œä¹Ÿèƒ½è·å–å½“å‰çš„ HttpContext</span></span>
<span class="line"><span style="color:#F8F8F2;">services.</span><span style="color:#50FA7B;">AddSingleton</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IHttpContextAccessor</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">HttpContextAccessor</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"><span style="color:#6272A4;">// IHttpContextAccessor æ˜¯ ASP.NET Core æä¾›çš„æ¥å£ï¼Œå®ƒèƒ½è®©ä½ åœ¨ä»»ä½•åœ°æ–¹æ‹¿åˆ°å½“å‰è¯·æ±‚çš„ HttpContext</span></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> HttpContextAccessor</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">IHttpContextAccessor</span></span>
<span class="line"><span style="color:#F8F8F2;">{   </span></span>
<span class="line"><span style="color:#6272A4;">    /*</span></span>
<span class="line"><span style="color:#6272A4;">    ğŸ”§ AsyncLocal&lt;T&gt; æ˜¯ .NET æä¾›çš„ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æœ¬åœ°å˜é‡å®¹å™¨ï¼Œé€‚ç”¨äºï¼š</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ï¼ˆä¸ä¼šè¢«å¹¶å‘æ±¡æŸ“ï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    è·¨ä¸­é—´ä»¶ã€è·¨å¼‚æ­¥æ–¹æ³•ä¼ é€’çŠ¶æ€</span></span>
<span class="line"><span style="color:#6272A4;">    </span></span>
<span class="line"><span style="color:#6272A4;">    */</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> static</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> AsyncLocal</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">HttpContextHolder</span><span style="color:#F8F8F2;">&gt; _httpContextCurrent </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> AsyncLocal</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">HttpContextHolder</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">    /// </span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">inheritdoc</span><span style="color:#F8F8F2;">/&gt;</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> HttpContext</span><span style="color:#F8F8F2;">? HttpContext</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        get</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#FF79C6;">            return</span><span style="color:#F8F8F2;"> _httpContextCurrent.Value</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.Context;</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#FF79C6;">        set</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> holder </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _httpContextCurrent.Value;</span></span>
<span class="line"><span style="color:#FF79C6;">            if</span><span style="color:#F8F8F2;"> (holder </span><span style="color:#FF79C6;">!=</span><span style="color:#BD93F9;"> null</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#6272A4;">                // Clear current HttpContext trapped in the AsyncLocals, as its done.</span></span>
<span class="line"><span style="color:#F8F8F2;">                holder.Context </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> null</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">            if</span><span style="color:#F8F8F2;"> (value </span><span style="color:#FF79C6;">!=</span><span style="color:#BD93F9;"> null</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#6272A4;">                // Use an object indirection to hold the HttpContext in the AsyncLocal,</span></span>
<span class="line"><span style="color:#6272A4;">                // so it can be cleared in all ExecutionContexts when its cleared.</span></span>
<span class="line"><span style="color:#F8F8F2;">                _httpContextCurrent.Value </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> HttpContextHolder</span><span style="color:#F8F8F2;"> { Context </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> value };</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> sealed</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> HttpContextHolder</span></span>
<span class="line"><span style="color:#F8F8F2;">    {   </span></span>
<span class="line"><span style="color:#6272A4;">        // è§£å†³ AsyncLocal&lt;T&gt; å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹æ¸…ç†çš„é—®é¢˜ã€‚</span></span>
<span class="line"><span style="color:#FF79C6;">        public</span><span style="color:#8BE9FD;font-style:italic;"> HttpContext</span><span style="color:#F8F8F2;">? Context;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="configure" tabindex="-1"><a class="header-anchor" href="#configure"><span>Configure</span></a></h3><p>Configure æ˜¯ ASP.NET Core æ¡†æ¶åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨çš„æ–¹æ³•ä¹‹ä¸€</p><ul><li>è¯¥æ–¹æ³•æ˜¯å¿…é¡»çš„</li><li>è¯¥æ–¹æ³•ç”¨äºé…ç½®HTTPè¯·æ±‚ç®¡é“ï¼Œé€šè¿‡å‘ç®¡é“æ·»åŠ ä¸­é—´ä»¶ï¼Œåº”ç”¨ä¸åŒçš„å“åº”æ–¹å¼ã€‚</li><li>è¯¥æ–¹æ³•åœ¨ConfigureServicesæ–¹æ³•ä¹‹åè¢«è°ƒç”¨</li><li>è¯¥æ–¹æ³•ä¸­çš„å‚æ•°å¯ä»¥æ¥å—ä»»ä½•å·²æ³¨å…¥åˆ°DIå®¹å™¨ä¸­çš„æœåŠ¡</li><li>è¯¥æ–¹æ³•å†…çš„ä»£ç å¤§å¤šæ˜¯å½¢å¦‚Use{Middleware}çš„æ‰©å±•æ–¹æ³•</li><li>è¯¥æ–¹æ³•å†…ä¸­é—´ä»¶çš„æ³¨å†Œé¡ºåºä¸ä»£ç çš„ä¹¦å†™é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œå…ˆæ³¨å†Œçš„å…ˆæ‰§è¡Œï¼Œåæ³¨å†Œçš„åæ‰§è¡Œ</li></ul>`,21)]))}const F=n(p,[["render",o],["__file","ModernWMS.html.vue"]]),i=JSON.parse('{"path":"/dotnet/ModernWMS.html","title":"ModernWMSå­¦ä¹ ç¬”è®°","lang":"en-US","frontmatter":{"title":"ModernWMSå­¦ä¹ ç¬”è®°","description":"startup configuration configurationæ˜¯é…ç½®ï¼Œç”¨æ¥è·å–é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ ä¾‹å¦‚ï¼š appsettings.json é€šè¿‡ Configuration[\\"MyAppSettings:ApiKey\\"] æ¥è¯»å–è¿™ä¸ªå€¼ã€‚ ConfigureServices å°†ä½ éœ€è¦çš„æœåŠ¡æ·»åŠ åˆ°ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­ã€‚æ‰€æœ‰é€šè¿‡ services.AddXx...","head":[["meta",{"property":"og:url","content":"https://luxiag.github.io/luxiag/blog/dotnet/ModernWMS.html"}],["meta",{"property":"og:title","content":"ModernWMSå­¦ä¹ ç¬”è®°"}],["meta",{"property":"og:description","content":"startup configuration configurationæ˜¯é…ç½®ï¼Œç”¨æ¥è·å–é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ ä¾‹å¦‚ï¼š appsettings.json é€šè¿‡ Configuration[\\"MyAppSettings:ApiKey\\"] æ¥è¯»å–è¿™ä¸ªå€¼ã€‚ ConfigureServices å°†ä½ éœ€è¦çš„æœåŠ¡æ·»åŠ åˆ°ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­ã€‚æ‰€æœ‰é€šè¿‡ services.AddXx..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-04-23T08:18:43.000Z"}],["meta",{"property":"article:modified_time","content":"2025-04-23T08:18:43.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ModernWMSå­¦ä¹ ç¬”è®°\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-04-23T08:18:43.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"luxiag\\",\\"url\\":\\"https://luxiag.github.io/luxiag\\"}]}"]]},"git":{"createdTime":1745396323000,"updatedTime":1745396323000,"contributors":[{"name":"luxiag","username":"luxiag","email":"luxiag@qq.com","commits":1,"url":"https://github.com/luxiag"}]},"readingTime":{"minutes":3.89,"words":1168},"filePathRelative":"dotnet/ModernWMS.md","localizedDate":"April 23, 2025","excerpt":"<h2>startup</h2>\\n<div class=\\"language-csharp line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"csharp\\" data-title=\\"csharp\\" style=\\"background-color:#282A36;color:#F8F8F2\\"><pre class=\\"shiki dracula vp-code\\"><code><span class=\\"line\\"><span style=\\"color:#FF79C6\\">    public</span><span style=\\"color:#FF79C6\\"> class</span><span style=\\"color:#8BE9FD\\"> Startup</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">    {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">summary</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// startup</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">summary</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#50FA7B;font-style:italic\\"> name</span><span style=\\"color:#6272A4\\">=</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F1FA8C\\">configuration</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F8F8F2\\">&gt;</span><span style=\\"color:#6272A4\\">Config</span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#FF79C6\\">        public</span><span style=\\"color:#50FA7B\\"> Startup</span><span style=\\"color:#F8F8F2\\">(</span><span style=\\"color:#8BE9FD;font-style:italic\\">IConfiguration</span><span style=\\"color:#FFB86C;font-style:italic\\"> configuration</span><span style=\\"color:#F8F8F2\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">        {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">            Configuration </span><span style=\\"color:#FF79C6\\">=</span><span style=\\"color:#F8F8F2\\"> configuration;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">        }</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#FF79C6\\">        public</span><span style=\\"color:#8BE9FD;font-style:italic\\"> IConfiguration</span><span style=\\"color:#F8F8F2\\"> Configuration { </span><span style=\\"color:#FF79C6\\">get</span><span style=\\"color:#F8F8F2\\">; }</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">summary</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        ///  register service </span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">summary</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#50FA7B;font-style:italic\\"> name</span><span style=\\"color:#6272A4\\">=</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F1FA8C\\">services</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F8F8F2\\">&gt;</span><span style=\\"color:#6272A4\\">services</span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#FF79C6\\">        public</span><span style=\\"color:#FF79C6\\"> void</span><span style=\\"color:#50FA7B\\"> ConfigureServices</span><span style=\\"color:#F8F8F2\\">(</span><span style=\\"color:#8BE9FD;font-style:italic\\">IServiceCollection</span><span style=\\"color:#FFB86C;font-style:italic\\"> services</span><span style=\\"color:#F8F8F2\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">        {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">            services.</span><span style=\\"color:#50FA7B\\">AddExtensionsService</span><span style=\\"color:#F8F8F2\\">(Configuration);</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">        }</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">summary</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// configure</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">summary</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#50FA7B;font-style:italic\\"> name</span><span style=\\"color:#6272A4\\">=</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F1FA8C\\">app</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F8F8F2\\">&gt;</span><span style=\\"color:#6272A4\\">app</span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#50FA7B;font-style:italic\\"> name</span><span style=\\"color:#6272A4\\">=</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F1FA8C\\">env</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F8F8F2\\">&gt;</span><span style=\\"color:#6272A4\\">env</span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#6272A4\\">        /// </span><span style=\\"color:#F8F8F2\\">&lt;</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#50FA7B;font-style:italic\\"> name</span><span style=\\"color:#6272A4\\">=</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F1FA8C\\">serviceProvider</span><span style=\\"color:#E9F284\\">\\"</span><span style=\\"color:#F8F8F2\\">&gt;</span><span style=\\"color:#6272A4\\">serviceProvider</span><span style=\\"color:#F8F8F2\\">&lt;/</span><span style=\\"color:#FF79C6\\">param</span><span style=\\"color:#F8F8F2\\">&gt;</span></span>\\n<span class=\\"line\\"><span style=\\"color:#FF79C6\\">        public</span><span style=\\"color:#FF79C6\\"> void</span><span style=\\"color:#50FA7B\\"> Configure</span><span style=\\"color:#F8F8F2\\">(</span><span style=\\"color:#8BE9FD;font-style:italic\\">IApplicationBuilder</span><span style=\\"color:#FFB86C;font-style:italic\\"> app</span><span style=\\"color:#F8F8F2\\">, </span><span style=\\"color:#8BE9FD;font-style:italic\\">IWebHostEnvironment</span><span style=\\"color:#FFB86C;font-style:italic\\"> env</span><span style=\\"color:#F8F8F2\\">, </span><span style=\\"color:#8BE9FD;font-style:italic\\">IServiceProvider</span><span style=\\"color:#FFB86C;font-style:italic\\"> service_provider</span><span style=\\"color:#F8F8F2\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">        {</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">            app.</span><span style=\\"color:#50FA7B\\">UseExtensionsConfigure</span><span style=\\"color:#F8F8F2\\">(env, service_provider, Configuration);</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">        }</span></span>\\n<span class=\\"line\\"><span style=\\"color:#F8F8F2\\">    }</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{F as comp,i as data};
