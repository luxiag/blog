import{_ as l,e,h as n,k as p,l as o,o as F}from"./app-DPJYBgB6.js";const c="/blog/assets/1122171745299754136-DOjQsv2S.png",t="/blog/assets/1122171745321537572-Bsiq3YLa.png",r="/blog/assets/1122171745321691076-D-nGanGI.png",i="/blog/assets/1122171745323376735-4g9O2PKo.png",y="/blog/assets/1122171745323392517-VzqC0xrG.png",d="/blog/assets/1122171745323770548-BQbwZkn3.png",v="/blog/assets/1122171745324528565-6uwndgIU.png",u={};function b(m,s){const a=o("Mermaid");return F(),e("div",null,[s[0]||(s[0]=n('<p>RabbitMQ æ˜¯ä¸€ä¸ªå®ç°äº† AMQP åè®®çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒAMQP è¢«å®šä¹‰ä¸ºä½œä¸ºæ¶ˆæ¯ä¼ é€’ä¸­é—´ä»¶çš„å¼€æ”¾æ ‡å‡†çš„åº”ç”¨å±‚åè®®ã€‚å®ƒä»£è¡¨é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œå…·æœ‰æ¶ˆæ¯å®šä½ã€è·¯ç”±ã€é˜Ÿåˆ—ã€å®‰å…¨æ€§å’Œå¯é æ€§ç­‰ç‰¹ç‚¹ã€‚</p><p>RabbitMQ çš„ä¼˜ç‚¹ã€ç”¨é€”ç­‰ï¼Œå¤§æ¦‚æ˜¯å¯é æ€§é«˜ã€çµæ´»çš„è·¯ç”±è§„åˆ™é…ç½®ã€æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€éµå®ˆ AMQP åè®®ç­‰ã€‚å¯ä»¥ç”¨äºå¼‚æ­¥é€šè®¯ã€æ—¥å¿—æ”¶é›†(æ—¥å¿—æ”¶é›†è¿˜æ˜¯ Kafka æ¯”è¾ƒå¥½)ã€äº‹ä»¶é©±åŠ¨æ¶æ„ç³»ç»Ÿã€åº”ç”¨é€šè®¯è§£è€¦ç­‰</p><p>ç‰¹ç‚¹</p><ul><li><p>æŒå¤šç§æ¶ˆæ¯ä¼ é€’åè®®ã€æ¶ˆæ¯é˜Ÿåˆ—ã€ä¼ é€’ç¡®è®¤ã€çµæ´»çš„é˜Ÿåˆ—è·¯ç”±ã€å¤šç§äº¤æ¢ç±»å‹(äº¤æ¢å™¨)ã€‚</p></li><li><p>æ”¯æŒ Kubernetes ç­‰åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæä¾›å¤šç§è¯­è¨€çš„ SDKï¼Œå¦‚ Javaã€Goã€C#ã€‚</p></li><li><p>å¯æ’å…¥çš„èº«ä»½éªŒè¯ã€æˆæƒï¼Œæ”¯æŒ TLS å’Œ LDAPã€‚</p></li><li><p>æ”¯æŒæŒç»­é›†æˆã€æ“ä½œåº¦é‡å’Œä¸å…¶ä»–ä¼ä¸šç³»ç»Ÿé›†æˆçš„å„ç§å·¥å…·å’Œæ’ä»¶ã€‚</p></li><li><p>æä¾›ä¸€å¥—ç”¨äºç®¡ç†å’Œç›‘è§† RabbitMQ çš„ HTTP-APIã€å‘½ä»¤è¡Œå·¥å…·å’Œ UIã€‚</p></li></ul><h2 id="mqæ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#mqæ˜¯ä»€ä¹ˆ"><span>MQæ˜¯ä»€ä¹ˆ</span></a></h2><h2 id="ä¸ºä»€ä¹ˆè¦ç”¨mq" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆè¦ç”¨mq"><span>ä¸ºä»€ä¹ˆè¦ç”¨MQ</span></a></h2><ul><li>é«˜å¹¶å‘çš„æµé‡å‰Šå³° ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æŸè®¢å•ç³»ç»Ÿæ¯ç§’æœ€å¤šèƒ½å¤„ç†ä¸€ä¸‡æ¬¡è®¢å•ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šæ‰¿å—çš„10000qpsï¼Œè¿™ä¸ªå¤„ç†èƒ½åŠ›åº”ä»˜æ­£å¸¸æ—¶æ®µçš„ä¸‹å•æ—¶ç»°ç»°æœ‰ä½™ï¼Œæ­£å¸¸æ—¶æ®µæˆ‘ä»¬ä¸‹å•ä¸€ç§’åå°±èƒ½è¿”å›ç»“æœã€‚ä½†æ˜¯åœ¨é«˜å³°æœŸï¼Œå¦‚æœæœ‰ä¸¤ä¸‡æ¬¡ä¸‹å•æ“ä½œç³»ç»Ÿæ˜¯å¤„ç†ä¸äº†çš„ï¼Œåªèƒ½é™åˆ¶è®¢å•è¶…è¿‡ä¸€ä¸‡åä¸å…è®¸ç”¨æˆ·ä¸‹å•ã€‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšç¼“å†²ï¼Œæˆ‘ä»¬å¯ä»¥å–æ¶ˆè¿™ä¸ªé™åˆ¶ï¼ŒæŠŠä¸€ç§’å†…ä¸‹çš„è®¢å•åˆ†æ•£æˆä¸€æ®µæ—¶é—´æ¥å¤„ç†ï¼Œè¿™æ—¶æœ‰äº›ç”¨æˆ·å¯èƒ½åœ¨ä¸‹å•åå‡ ç§’åæ‰èƒ½æ”¶åˆ°ä¸‹å•æˆåŠŸçš„æ“ä½œï¼Œä½†æ˜¯æ¯”ä¸èƒ½ä¸‹å•çš„ä½“éªŒè¦å¥½ã€‚</li></ul><figure><img src="'+c+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>åº”ç”¨è§£è€¦</li></ul><p>ä»¥ç”µå•†åº”ç”¨ä¸ºä¾‹ï¼Œåº”ç”¨ä¸­æœ‰è®¢å•ç³»ç»Ÿã€åº“å­˜ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿã€æ”¯ä»˜ç³»ç»Ÿã€‚ç”¨æˆ·åˆ›å»ºè®¢å•åï¼Œå¦‚æœè€¦åˆè°ƒç”¨åº“å­˜ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿã€æ”¯ä»˜ç³»ç»Ÿï¼Œä»»ä½•ä¸€ä¸ªå­ç³»ç»Ÿå‡ºäº†æ•…éšœï¼Œéƒ½ä¼šé€ æˆä¸‹å•æ“ä½œå¼‚å¸¸ã€‚å½“è½¬å˜æˆåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼åï¼Œç³»ç»Ÿé—´è°ƒç”¨çš„é—®é¢˜ä¼šå‡å°‘å¾ˆå¤šï¼Œæ¯”å¦‚ç‰©æµç³»ç»Ÿå› ä¸ºå‘ç”Ÿæ•…éšœï¼Œéœ€è¦å‡ åˆ†é’Ÿæ¥ä¿®å¤ã€‚åœ¨è¿™å‡ åˆ†é’Ÿçš„æ—¶é—´é‡Œï¼Œç‰©æµç³»ç»Ÿè¦å¤„ç†çš„å†…å­˜è¢«ç¼“å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç”¨æˆ·çš„ä¸‹å•æ“ä½œå¯ä»¥æ­£å¸¸å®Œæˆã€‚å½“ç‰©æµç³»ç»Ÿæ¢å¤åï¼Œç»§ç»­å¤„ç†è®¢å•ä¿¡æ¯å³å¯ï¼Œä¸­å•ç”¨æˆ·æ„Ÿå—ä¸åˆ°ç‰©æµç³»ç»Ÿçš„æ•…éšœï¼Œæå‡ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</p><figure><img src="'+t+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>å¼‚æ­¥å¤„ç†</li></ul><p>ä¾‹å¦‚ A è°ƒç”¨ Bï¼ŒB éœ€è¦èŠ±è´¹å¾ˆé•¿æ—¶é—´æ‰§è¡Œï¼Œä½†æ˜¯ A éœ€è¦çŸ¥é“ B ä»€ä¹ˆæ—¶å€™å¯ä»¥æ‰§è¡Œå®Œï¼Œä»¥å‰ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼ŒA è¿‡ä¸€æ®µæ—¶é—´å»è°ƒç”¨ B çš„æŸ¥è¯¢ api æŸ¥è¯¢ã€‚æˆ–è€… A æä¾›ä¸€ä¸ª callback apiï¼Œ B æ‰§è¡Œå®Œä¹‹åè°ƒç”¨ api é€šçŸ¥ A æœåŠ¡ã€‚è¿™ä¸¤ç§æ–¹å¼éƒ½ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒA è°ƒç”¨ B æœåŠ¡åï¼Œåªéœ€è¦ç›‘å¬ B å¤„ç†å®Œæˆçš„æ¶ˆæ¯ï¼Œå½“ B å¤„ç†å®Œæˆåï¼Œä¼šå‘é€ä¸€æ¡æ¶ˆæ¯ç»™ MQï¼ŒMQ ä¼šå°†æ­¤æ¶ˆæ¯è½¬å‘ç»™ A æœåŠ¡ã€‚</p><figure><img src="'+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>åˆ†å¸ƒå¼äº‹åŠ¡</li></ul><p>ä¼ ç»Ÿçš„æ–¹å¼ä¸ºå•ä½“åº”ç”¨ï¼Œæ”¯ä»˜ã€ä¿®æ”¹è®¢å•çŠ¶æ€ã€åˆ›å»ºç‰©æµè®¢å•ä¸‰ä¸ªæ­¥éª¤é›†æˆåœ¨ä¸€ä¸ªæœåŠ¡ä¸­ï¼Œå› æ­¤è¿™ä¸‰ä¸ªæ­¥éª¤å¯ä»¥æ”¾åœ¨ä¸€ä¸ªjdbcäº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ã€‚è€Œåœ¨å¾®æœåŠ¡çš„ç¯å¢ƒä¸‹ï¼Œä¼šå°†ä¸‰ä¸ªæ­¥éª¤æ‹†åˆ†æˆä¸‰ä¸ªæœåŠ¡ï¼Œä¾‹å¦‚ï¼šæ”¯ä»˜æœåŠ¡ï¼Œè®¢å•æœåŠ¡ï¼Œç‰©æµæœåŠ¡ã€‚ä¸‰è€…å„å¸å…¶èŒï¼Œç›¸äº’ä¹‹é—´è¿›è¡ŒæœåŠ¡é—´è°ƒç”¨ï¼Œä½†è¿™ä¼šå¸¦æ¥åˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ï¼Œå› ä¸ºä¸‰ä¸ªæ­¥éª¤æ“ä½œçš„ä¸æ˜¯åŒä¸€ä¸ªæ•°æ®åº“ï¼Œå¯¼è‡´æ— æ³•ä½¿ç”¨jdbcäº‹åŠ¡ç®¡ç†ä»¥è¾¾åˆ°ä¸€è‡´æ€§ã€‚è€Œ MQ èƒ½å¤Ÿå¾ˆå¥½çš„å¸®æˆ‘ä»¬è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“ç†è§£çš„æ–¹æ¡ˆï¼Œå°±æ˜¯äºŒæ¬¡æäº¤ã€‚åŸºäºMQçš„ç‰¹ç‚¹ï¼ŒMQä½œä¸ºäºŒæ¬¡æäº¤çš„ä¸­é—´èŠ‚ç‚¹ï¼Œè´Ÿè´£å­˜å‚¨è¯·æ±‚æ•°æ®ï¼Œåœ¨å¤±è´¥çš„æƒ…å†µå¯ä»¥è¿›è¡Œå¤šæ¬¡å°è¯•ï¼Œæˆ–è€…åŸºäºMQä¸­çš„é˜Ÿåˆ—æ•°æ®è¿›è¡Œå›æ»šæ“ä½œï¼Œæ˜¯ä¸€ä¸ªæ—¢èƒ½ä¿è¯æ€§èƒ½ï¼Œåˆèƒ½ä¿è¯ä¸šåŠ¡ä¸€è‡´æ€§çš„æ–¹æ¡ˆ</p><figure><img src="'+i+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>æ•°æ®åˆ†å‘</li></ul><p>MQ å…·æœ‰å‘å¸ƒè®¢é˜…æœºåˆ¶ï¼Œä¸ä»…ä»…æ˜¯ç®€å•çš„ä¸Šæ¸¸å’Œä¸‹æ¸¸ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œè¿˜æœ‰æ”¯æŒä¸€å¯¹å¤šæˆ–è€…å¹¿æ’­çš„æ¨¡å¼ï¼Œå¹¶ä¸”éƒ½å¯ä»¥æ ¹æ®è§„åˆ™é€‰æ‹©åˆ†å‘çš„å¯¹è±¡ã€‚ <img src="'+y+'" alt="" loading="lazy"></p><h2 id="rabbitmqçš„æ¶æ„" tabindex="-1"><a class="header-anchor" href="#rabbitmqçš„æ¶æ„"><span>RabbitMQçš„æ¶æ„</span></a></h2><h3 id="å·¥ä½œåŸç†" tabindex="-1"><a class="header-anchor" href="#å·¥ä½œåŸç†"><span>å·¥ä½œåŸç†</span></a></h3><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç”Ÿäº§è€…ï¼ˆProducerï¼‰ ç”Ÿäº§è€…æ˜¯å‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ã€‚åœ¨å›¾ä¸­ï¼Œæœ‰ä¸¤ä¸ªç”Ÿäº§è€…ï¼Œå®ƒä»¬é€šè¿‡å„è‡ªçš„è¿æ¥ï¼ˆConnectionï¼‰å’Œé€šé“ï¼ˆChannelï¼‰ä¸ RabbitMQ æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚</p><p>è¿æ¥ï¼ˆConnectionï¼‰ è¿æ¥æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸ RabbitMQ æœåŠ¡å™¨ä¹‹é—´çš„ TCP è¿æ¥ã€‚ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥å»ºç«‹å¤šä¸ªè¿æ¥ï¼Œæ¯ä¸ªè¿æ¥å¯ä»¥åŒ…å«å¤šä¸ªé€šé“ã€‚</p><p>é€šé“ï¼ˆChannelï¼‰ é€šé“æ˜¯è¿æ¥ä¸­çš„ä¸€ä¸ªè™šæ‹Ÿé€šé“ï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚ä¸€ä¸ªè¿æ¥å¯ä»¥åŒ…å«å¤šä¸ªé€šé“ï¼Œæ¯ä¸ªé€šé“å¯ä»¥ç‹¬ç«‹å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚é€šé“æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥æé«˜é€šä¿¡æ•ˆç‡ã€‚</p><p>äº¤æ¢å™¨ï¼ˆExchangeï¼‰ äº¤æ¢å™¨æ˜¯ RabbitMQ ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œå®ƒæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®ä¸€å®šçš„è§„åˆ™å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ä¸­ã€‚å›¾ä¸­æœ‰ä¸¤ä¸ªäº¤æ¢å™¨ï¼Œæ¯ä¸ªäº¤æ¢å™¨å¯ä»¥è¿æ¥åˆ°å¤šä¸ªé˜Ÿåˆ—ã€‚</p><p>é˜Ÿåˆ—ï¼ˆQueueï¼‰ é˜Ÿåˆ—æ˜¯å­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨ï¼Œæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚å›¾ä¸­æœ‰å¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å¯ä»¥æ¥æ”¶æ¥è‡ªä¸€ä¸ªæˆ–å¤šä¸ªäº¤æ¢å™¨çš„æ¶ˆæ¯ã€‚</p><p>ç»‘å®šï¼ˆBindingï¼‰ ç»‘å®šæ˜¯äº¤æ¢å™¨å’Œé˜Ÿåˆ—ä¹‹é—´çš„è¿æ¥å…³ç³»ï¼Œå®ƒå®šä¹‰äº†æ¶ˆæ¯å¦‚ä½•ä»äº¤æ¢å™¨è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚ç»‘å®šæ—¶ï¼Œå¯ä»¥æŒ‡å®šè·¯ç”±é”®ï¼ˆRouting Keyï¼‰æˆ–ä¸»é¢˜æ¨¡å¼ï¼ˆBinding Keyï¼‰ï¼Œå…·ä½“å–å†³äºäº¤æ¢å™¨çš„ç±»å‹ã€‚</p><p>æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ æ¶ˆè´¹è€…æ˜¯æ¥æ”¶æ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨ã€‚æ¶ˆè´¹è€…é€šè¿‡å„è‡ªçš„è¿æ¥å’Œé€šé“ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚å›¾ä¸­æœ‰ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œå®ƒä»¬é€šè¿‡å„è‡ªçš„è¿æ¥å’Œé€šé“ä¸ RabbitMQ æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚</p><p>å·¥ä½œæµç¨‹</p><ol><li>ç”Ÿäº§è€…é€šè¿‡é€šé“å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢å™¨ã€‚</li><li>äº¤æ¢å™¨æ ¹æ®ç»‘å®šå…³ç³»å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚</li><li>æ¶ˆè´¹è€…é€šè¿‡é€šé“ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚</li></ol><h3 id="æ ¸å¿ƒæ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæ¦‚å¿µ"><span>æ ¸å¿ƒæ¦‚å¿µ</span></a></h3><figure><img src="'+v+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>ç”Ÿäº§è€…ï¼šäº§ç”Ÿæ•°æ®å‘é€æ¶ˆæ¯çš„ç¨‹åºæ˜¯ç”Ÿäº§è€…ã€‚</li><li>äº¤æ¢æœºï¼šäº¤æ¢æœºæ˜¯ RabbitMQ éå¸¸é‡è¦çš„ä¸€ä¸ªéƒ¨ä»¶ï¼Œä¸€æ–¹é¢å®ƒæ¥æ”¶æ¥è‡ªç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œå¦ä¸€æ–¹é¢å®ƒå°†æ¶ˆæ¯æ¨é€åˆ°é˜Ÿåˆ—ä¸­ã€‚äº¤æ¢æœºå¿…é¡»ç¡®åˆ‡çŸ¥é“å¦‚ä½•å¤„ç†å®ƒæ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ˜¯å°†è¿™äº›æ¶ˆæ¯æ¨é€åˆ°ç‰¹å®šé˜Ÿåˆ—è¿˜æ˜¯æ¨é€åˆ°å¤šä¸ªé˜Ÿåˆ—ï¼Œäº¦æˆ–è€…æ˜¯æŠŠæ¶ˆæ¯ä¸¢å¼ƒï¼Œè¿™ä¸ªæ˜¯ç”±äº¤æ¢æœºç±»å‹å†³å®šçš„ã€‚- é˜Ÿåˆ—ï¼šé˜Ÿåˆ—æ˜¯ RabbitMQ å†…éƒ¨ä½¿ç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå°½ç®¡æ¶ˆæ¯æµç» RabbitMQ å’Œåº”ç”¨ç¨‹åºï¼Œä½†å®ƒä»¬åªèƒ½å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­ã€‚é˜Ÿåˆ—ä»…å—ä¸»æœºçš„å†…å­˜å’Œç£ç›˜é™åˆ¶çš„çº¦æŸï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤§çš„æ¶ˆæ¯ç¼“å†²åŒºã€‚è®¸å¤šç”Ÿäº§è€…å¯ä»¥å°†æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè®¸å¤šæ¶ˆè´¹è€…å¯ä»¥å°è¯•ä»ä¸€ä¸ªé˜Ÿåˆ—æ¥æ”¶æ•°æ®ã€‚</li><li>æ¶ˆè´¹è€…ï¼šæ¶ˆè´¹ä¸æ¥æ”¶å…·æœ‰ç›¸ä¼¼çš„å«ä¹‰ã€‚æ¶ˆè´¹è€…å¤§å¤šæ—¶å€™æ˜¯ä¸€ä¸ªç­‰å¾…æ¥æ”¶æ¶ˆæ¯çš„ç¨‹åºã€‚è¯·æ³¨æ„ç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…å’Œæ¶ˆæ¯ä¸­é—´ä»¶å¾ˆå¤šæ—¶å€™å¹¶ä¸åœ¨åŒä¸€æœºå™¨ä¸Šã€‚åŒä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¢å¯ä»¥æ˜¯ç”Ÿäº§è€…åˆæ˜¯å¯ä»¥æ˜¯æ¶ˆè´¹è€…ã€‚</li></ul><h2 id="å¸¸ç”¨api" tabindex="-1"><a class="header-anchor" href="#å¸¸ç”¨api"><span>å¸¸ç”¨API</span></a></h2><table><thead><tr><th>ç”¨æ³•</th><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>åˆ›å»ºè¿æ¥</td><td>ConnectionFactory.CreateConnection()</td><td>å»ºç«‹ TCP è¿æ¥</td></tr><tr><td>åˆ›å»ºé€šé“</td><td>IConnection.CreateModel()</td><td>å»ºç«‹æ“ä½œé€šé“</td></tr><tr><td>å£°æ˜é˜Ÿåˆ—</td><td>IModel.QueueDeclare()</td><td>ç¡®ä¿é˜Ÿåˆ—å­˜åœ¨</td></tr><tr><td>å‘é€æ¶ˆæ¯</td><td>IModel.BasicPublish()</td><td>å‘å¸ƒæ¶ˆæ¯åˆ°é˜Ÿåˆ—æˆ–äº¤æ¢æœº</td></tr><tr><td>æ¶ˆè´¹æ¶ˆæ¯</td><td>IModel.BasicConsume()</td><td>æ³¨å†Œæ¶ˆè´¹è€…</td></tr><tr><td>ç¡®è®¤æ¶ˆæ¯</td><td>IModel.BasicAck()</td><td>æ‰‹åŠ¨ç¡®è®¤ï¼ˆå¯é€‰ï¼‰</td></tr></tbody></table><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> RabbitMqOptions</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> HostName { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">localhost</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> UserName { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">guest</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> Password { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">guest</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> QueueName { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">order_created</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> interface</span><span style="color:#8BE9FD;font-style:italic;"> IRabbitMqHelper</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    void</span><span style="color:#50FA7B;"> Publish</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">    void</span><span style="color:#50FA7B;"> Consume</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">Action</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#FFB86C;font-style:italic;">onMessageReceived</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> RabbitMqHelper</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">IRabbitMqHelper</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">IDisposable</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConnection</span><span style="color:#F8F8F2;"> _connection;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IModel</span><span style="color:#F8F8F2;"> _channel;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMqOptions</span><span style="color:#F8F8F2;"> _options;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> RabbitMqHelper</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> config</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _options </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config.</span><span style="color:#50FA7B;">GetSection</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">).</span><span style="color:#50FA7B;">Get</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">RabbitMqOptions</span><span style="color:#F8F8F2;">&gt;() </span><span style="color:#FF79C6;">??</span><span style="color:#FF79C6;"> new</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _options.HostName,</span></span>
<span class="line"><span style="color:#F8F8F2;">            UserName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _options.UserName,</span></span>
<span class="line"><span style="color:#F8F8F2;">            Password </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _options.Password</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            queue</span><span style="color:#F8F8F2;">: _options.QueueName,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            arguments</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">null</span></span>
<span class="line"><span style="color:#F8F8F2;">        );</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Publish</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetBytes</span><span style="color:#F8F8F2;">(JsonSerializer.</span><span style="color:#50FA7B;">Serialize</span><span style="color:#F8F8F2;">(message));</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            exchange</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            routingKey</span><span style="color:#F8F8F2;">: _options.QueueName,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            basicProperties</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">null</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            body</span><span style="color:#F8F8F2;">: body</span></span>
<span class="line"><span style="color:#F8F8F2;">        );</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Consume</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">Action</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#FFB86C;font-style:italic;">onMessageReceived</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> consumer </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> EventingBasicConsumer</span><span style="color:#F8F8F2;">(_channel);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        consumer.Received </span><span style="color:#FF79C6;">+=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FFB86C;font-style:italic;">model</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">ea</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> json </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetString</span><span style="color:#F8F8F2;">(ea.Body.</span><span style="color:#50FA7B;">ToArray</span><span style="color:#F8F8F2;">());</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> obj </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> JsonSerializer.</span><span style="color:#50FA7B;">Deserialize</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(json);</span></span>
<span class="line"><span style="color:#FF79C6;">            if</span><span style="color:#F8F8F2;"> (obj </span><span style="color:#FF79C6;">!=</span><span style="color:#BD93F9;"> null</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#50FA7B;">                onMessageReceived</span><span style="color:#F8F8F2;">(obj);</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">BasicConsume</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            queue</span><span style="color:#F8F8F2;">: _options.QueueName,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            autoAck</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            consumer</span><span style="color:#F8F8F2;">: consumer</span></span>
<span class="line"><span style="color:#F8F8F2;">        );</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Dispose</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _connection</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#é˜Ÿåˆ—"><span>é˜Ÿåˆ—</span></a></h2><h3 id="æ­»ä¿¡é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#æ­»ä¿¡é˜Ÿåˆ—"><span>æ­»ä¿¡é˜Ÿåˆ—</span></a></h3><p>æ­»ä¿¡æŒ‡çš„æ˜¯æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯ï¼ŒRabbitMQ ä¼šè‡ªåŠ¨æŠŠå®ƒæŠ•é€’åˆ°ä¸€ä¸ªâ€œæ­»ä¿¡é˜Ÿåˆ—â€é‡Œï¼Œä»¥ä¾¿ä½ åç»­å¤„ç†ã€‚</p><table><thead><tr><th>åœºæ™¯</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>âŒ æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆNack/Requeue = falseï¼‰</td><td>æ¶ˆè´¹è€…æ˜ç¡®æ‹’æ”¶</td></tr><tr><td>â±ï¸ æ¶ˆæ¯è¿‡æœŸï¼ˆTTL åˆ°æœŸï¼‰</td><td>è®¾ç½®äº† TTLï¼ŒæœªåŠæ—¶æ¶ˆè´¹</td></tr><tr><td>ğŸ“¦ é˜Ÿåˆ—å·²æ»¡ï¼ˆmax-length é™åˆ¶ï¼‰</td><td>é˜Ÿåˆ—è¶…è¿‡æœ€å¤§æ¶ˆæ¯æ•°é‡</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span>[Producer] </span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>[Delay Queue (TTL = 30s, DLX = real.exchange)]</span></span>
<span class="line"><span>   â†“ (30s later)</span></span>
<span class="line"><span>[Dead Letter â†’ real.exchange â†’ real.queue]</span></span>
<span class="line"><span>   â†“</span></span>
<span class="line"><span>[Consumer]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> args </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#F8F8F2;">    { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-dead-letter-exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">dlx.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> },             </span><span style="color:#6272A4;">// æ­»ä¿¡äº¤æ¢æœº</span></span>
<span class="line"><span style="color:#F8F8F2;">    { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-dead-letter-routing-key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">dlx.routing.key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> }        </span><span style="color:#6272A4;">// æ­»ä¿¡æ¶ˆæ¯çš„è·¯ç”±é”®</span></span>
<span class="line"><span style="color:#F8F8F2;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">normal.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">arguments</span><span style="color:#F8F8F2;">: args);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">ExchangeDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">dlx.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, ExchangeType.Direct, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">dlx.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">QueueBind</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">dlx.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">dlx.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">dlx.routing.key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å»¶æ—¶é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#å»¶æ—¶é˜Ÿåˆ—"><span>å»¶æ—¶é˜Ÿåˆ—</span></a></h3><h4 id="ä½¿ç”¨-x-delayed-message-æ’ä»¶" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-x-delayed-message-æ’ä»¶"><span>ä½¿ç”¨ x-delayed-message æ’ä»¶</span></a></h4><p>1.å®‰è£…æ’ä»¶</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#50FA7B;">rabbitmq-plugins</span><span style="color:#F1FA8C;"> enable</span><span style="color:#F1FA8C;"> rabbitmq_delayed_message_exchange</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2.å£°æ˜å»¶è¿Ÿäº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼ˆC#ï¼‰</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">ExchangeDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay-exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">type</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delayed-message</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    arguments</span><span style="color:#F8F8F2;">: </span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt; { { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delayed-type</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">direct</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> } });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay-queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">QueueBind</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay-queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay-exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay-key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ˆC#ï¼‰</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> props </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _channel.</span><span style="color:#50FA7B;">CreateBasicProperties</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">props.Headers </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#F8F8F2;">    { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delay</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, delayMs } </span><span style="color:#6272A4;">// ä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½®å»¶è¿Ÿæ—¶é—´</span></span>
<span class="line"><span style="color:#F8F8F2;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay-exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay-key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, props, body);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Json</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> RabbitMqHelper</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">IDisposable</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConnection</span><span style="color:#F8F8F2;"> _connection;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IModel</span><span style="color:#F8F8F2;"> _channel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> ExchangeName </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">delay-exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> QueueName </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">delay-queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> RoutingKey </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">delay-key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> RabbitMqHelper</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> configuration</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Host</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Port </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> int</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Parse</span><span style="color:#F8F8F2;">(configuration[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Port</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">??</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">5672</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">),</span></span>
<span class="line"><span style="color:#F8F8F2;">            UserName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:User</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Password </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> configuration[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Password</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        // å£°æ˜å»¶è¿Ÿäº¤æ¢æœº</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">ExchangeDeclare</span><span style="color:#F8F8F2;">(ExchangeName, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delayed-message</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            arguments</span><span style="color:#F8F8F2;">: </span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#F8F8F2;">                { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delayed-type</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">direct</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> }</span></span>
<span class="line"><span style="color:#F8F8F2;">            });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        // å£°æ˜ç»‘å®šé˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(QueueName, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueBind</span><span style="color:#F8F8F2;">(QueueName, ExchangeName, RoutingKey);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Publish</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#50FA7B;">        PublishDelayed</span><span style="color:#F8F8F2;">(message, </span><span style="color:#FFB86C;font-style:italic;">delayMilliseconds</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> PublishDelayed</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">double</span><span style="color:#FFB86C;font-style:italic;"> delayMilliseconds</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetBytes</span><span style="color:#F8F8F2;">(JsonSerializer.</span><span style="color:#50FA7B;">Serialize</span><span style="color:#F8F8F2;">(message));</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> props </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _channel.</span><span style="color:#50FA7B;">CreateBasicProperties</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        props.DeliveryMode </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 2</span><span style="color:#F8F8F2;">; </span><span style="color:#6272A4;">// persistent</span></span>
<span class="line"><span style="color:#F8F8F2;">        props.Headers </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delay</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, (</span><span style="color:#FF79C6;">int</span><span style="color:#F8F8F2;">)delayMilliseconds }</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            exchange</span><span style="color:#F8F8F2;">: ExchangeName,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            routingKey</span><span style="color:#F8F8F2;">: RoutingKey,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            basicProperties</span><span style="color:#F8F8F2;">: props,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            body</span><span style="color:#F8F8F2;">: body</span></span>
<span class="line"><span style="color:#F8F8F2;">        );</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Dispose</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _connection</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ­»ä¿¡é˜Ÿåˆ—-ttl-å»¶è¿Ÿé˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#æ­»ä¿¡é˜Ÿåˆ—-ttl-å»¶è¿Ÿé˜Ÿåˆ—"><span>æ­»ä¿¡é˜Ÿåˆ— + TTL å»¶è¿Ÿé˜Ÿåˆ—</span></a></h4><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#6272A4;">// Program.cs</span></span>
<span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> builder </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> WebApplication.</span><span style="color:#50FA7B;">CreateBuilder</span><span style="color:#F8F8F2;">(args);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">builder.Services.</span><span style="color:#50FA7B;">AddControllers</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">builder.Services.</span><span style="color:#50FA7B;">AddSingleton</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">RabbitMqHelper</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"><span style="color:#F8F8F2;">builder.Services.</span><span style="color:#50FA7B;">AddHostedService</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">DelayedConsumer</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> app </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> builder.</span><span style="color:#50FA7B;">Build</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">app.</span><span style="color:#50FA7B;">MapControllers</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">app.</span><span style="color:#50FA7B;">Run</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">// appsettings.json</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#E9F284;">  &quot;</span><span style="color:#F1FA8C;">RabbitMQ</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#E9F284;">    &quot;</span><span style="color:#F1FA8C;">Host</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">localhost</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#E9F284;">    &quot;</span><span style="color:#F1FA8C;">User</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">guest</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#E9F284;">    &quot;</span><span style="color:#F1FA8C;">Password</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">guest</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">// Helpers/RabbitMqHelper.cs</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Json</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> RabbitMqHelper</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConnection</span><span style="color:#F8F8F2;"> _connection;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IModel</span><span style="color:#F8F8F2;"> _channel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> RabbitMqHelper</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> config</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Host</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            UserName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:User</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Password </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Password</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#50FA7B;">        SetupQueues</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> SetupQueues</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">ExchangeDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, ExchangeType.Direct, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueBind</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> args </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-dead-letter-exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> },</span></span>
<span class="line"><span style="color:#F8F8F2;">            { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-dead-letter-routing-key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.key</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> }</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">arguments</span><span style="color:#F8F8F2;">: args);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> PublishWithDelay</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">int</span><span style="color:#FFB86C;font-style:italic;"> delayMs</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> props </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _channel.</span><span style="color:#50FA7B;">CreateBasicProperties</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        props.DeliveryMode </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 2</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">        props.Expiration </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> delayMs.</span><span style="color:#50FA7B;">ToString</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetBytes</span><span style="color:#F8F8F2;">(JsonSerializer.</span><span style="color:#50FA7B;">Serialize</span><span style="color:#F8F8F2;">(message));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            exchange</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            routingKey</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">delay.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            basicProperties</span><span style="color:#F8F8F2;">: props,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            body</span><span style="color:#F8F8F2;">: body</span></span>
<span class="line"><span style="color:#F8F8F2;">        );</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">// Consumers/DelayedConsumer.cs</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Events</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> DelayedConsumer</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">BackgroundService</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConfiguration</span><span style="color:#F8F8F2;"> _config;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> DelayedConsumer</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> config</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _config </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    protected</span><span style="color:#FF79C6;"> override</span><span style="color:#8BE9FD;font-style:italic;"> Task</span><span style="color:#50FA7B;"> ExecuteAsync</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">CancellationToken</span><span style="color:#FFB86C;font-style:italic;"> stoppingToken</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Host</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            UserName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:User</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Password </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Password</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> consumer </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> EventingBasicConsumer</span><span style="color:#F8F8F2;">(channel);</span></span>
<span class="line"><span style="color:#F8F8F2;">        consumer.Received </span><span style="color:#FF79C6;">+=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FFB86C;font-style:italic;">model</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">ea</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> ea.Body.</span><span style="color:#50FA7B;">ToArray</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> message </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetString</span><span style="color:#F8F8F2;">(body);</span></span>
<span class="line"><span style="color:#F8F8F2;">            Console.</span><span style="color:#50FA7B;">WriteLine</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">$&quot;</span><span style="color:#F1FA8C;">[Consumer] æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š</span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">message</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;"> - æ—¶é—´ï¼š</span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">DateTime</span><span style="color:#F1FA8C;">.</span><span style="color:#F8F8F2;">Now</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;">HH</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;">mm</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;">ss</span><span style="color:#FF79C6;">}</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        channel.</span><span style="color:#50FA7B;">BasicConsume</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">queue</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">real.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoAck</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">consumer</span><span style="color:#F8F8F2;">: consumer);</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#F8F8F2;"> Task.CompletedTask;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">// Controllers/MessageController.cs</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Microsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">AspNetCore</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Mvc</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">ApiController</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">Route</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">api/[controller]</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)]</span></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> MessageController</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">ControllerBase</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMqHelper</span><span style="color:#F8F8F2;"> _mq;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> MessageController</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">RabbitMqHelper</span><span style="color:#FFB86C;font-style:italic;"> mq</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _mq </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> mq;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    [</span><span style="color:#8BE9FD;font-style:italic;">HttpPost</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">send</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)]</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> IActionResult</span><span style="color:#50FA7B;"> Send</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">string</span><span style="color:#FFB86C;font-style:italic;"> content</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">int</span><span style="color:#FFB86C;font-style:italic;"> delaySeconds</span><span style="color:#FF79C6;"> =</span><span style="color:#BD93F9;"> 10</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> payload </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            Content </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> content,</span></span>
<span class="line"><span style="color:#F8F8F2;">            CreatedAt </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> DateTime.Now.</span><span style="color:#50FA7B;">ToString</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">yyyy-MM-dd HH:mm:ss</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _mq.</span><span style="color:#50FA7B;">PublishWithDelay</span><span style="color:#F8F8F2;">(payload, delaySeconds </span><span style="color:#FF79C6;">*</span><span style="color:#BD93F9;"> 1000</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#50FA7B;"> Ok</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">$&quot;</span><span style="color:#F1FA8C;">æ¶ˆæ¯å°†å»¶è¿Ÿ </span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">delaySeconds</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;"> ç§’åæŠ•é€’</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¼˜å…ˆçº§é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#ä¼˜å…ˆçº§é˜Ÿåˆ—"><span>ä¼˜å…ˆçº§é˜Ÿåˆ—</span></a></h3><p>RabbitMQ æ”¯æŒä¸ºé˜Ÿåˆ—å’Œæ¶ˆæ¯è®¾ç½®ä¼˜å…ˆçº§ã€‚æ¶ˆæ¯ä¼šæ ¹æ®ä¼˜å…ˆçº§å…ˆå…¥é˜Ÿï¼Œä½†åªæœ‰åœ¨æ¶ˆè´¹å‰æ‰èµ·æ•ˆï¼š</p><p>é˜Ÿåˆ—è¦å£°æ˜æ”¯æŒæœ€å¤§ä¼˜å…ˆçº§ï¼ˆæ¯”å¦‚ 10ï¼‰</p><p>æ¯æ¡æ¶ˆæ¯å¯è®¾ç½® priority å€¼ï¼ˆèŒƒå›´ 0 ~ maxï¼Œé»˜è®¤æ˜¯ 0ï¼‰</p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#6272A4;">// 1ï¸âƒ£ å£°æ˜æ”¯æŒä¼˜å…ˆçº§çš„é˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> args </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#F8F8F2;">    { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-max-priority</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">10</span><span style="color:#F8F8F2;"> } </span><span style="color:#6272A4;">// æ”¯æŒ 0 ~ 10 çº§ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="color:#F8F8F2;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">queue</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">priority.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                      durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                      exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                      autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                      arguments</span><span style="color:#F8F8F2;">: args);</span></span>
<span class="line"><span style="color:#6272A4;">// 2ï¸âƒ£ å‘å¸ƒæ¶ˆæ¯æ—¶è®¾ç½® priority</span></span>
<span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> props </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _channel.</span><span style="color:#50FA7B;">CreateBasicProperties</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">props.Priority </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> 9</span><span style="color:#F8F8F2;">; </span><span style="color:#6272A4;">// VIP = é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®® 5 ä»¥ä¸Šï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    exchange</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#6272A4;">// ç›´è¿é»˜è®¤äº¤æ¢æœº</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    routingKey</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">priority.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    basicProperties</span><span style="color:#F8F8F2;">: props,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">    body</span><span style="color:#F8F8F2;">: Encoding.UTF8.</span><span style="color:#50FA7B;">GetBytes</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">VIP message</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">//   æ¶ˆè´¹è€…æŒ‰æ­£å¸¸æ–¹å¼æ¶ˆè´¹å³å¯ï¼ˆRabbitMQ ä¼šè‡ªåŠ¨å…ˆæŠ•é€’é«˜ä¼˜å…ˆçº§æ¶ˆæ¯ï¼‰</span></span>
<span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> consumer </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> EventingBasicConsumer</span><span style="color:#F8F8F2;">(_channel);</span></span>
<span class="line"><span style="color:#F8F8F2;">consumer.Received </span><span style="color:#FF79C6;">+=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FFB86C;font-style:italic;">model</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">ea</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> ea.Body.</span><span style="color:#50FA7B;">ToArray</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">    var</span><span style="color:#F8F8F2;"> message </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetString</span><span style="color:#F8F8F2;">(body);</span></span>
<span class="line"><span style="color:#F8F8F2;">    Console.</span><span style="color:#50FA7B;">WriteLine</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">$&quot;</span><span style="color:#F1FA8C;">æ”¶åˆ°æ¶ˆæ¯ï¼š</span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">message</span><span style="color:#FF79C6;">}</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">_channel.</span><span style="color:#50FA7B;">BasicConsume</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">priority.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, consumer);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> PublishWithPriority</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">int</span><span style="color:#FFB86C;font-style:italic;"> priority</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    var</span><span style="color:#F8F8F2;"> props </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _channel.</span><span style="color:#50FA7B;">CreateBasicProperties</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    props.Priority </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">byte</span><span style="color:#F8F8F2;">)Math.</span><span style="color:#50FA7B;">Clamp</span><span style="color:#F8F8F2;">(priority, </span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">10</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetBytes</span><span style="color:#F8F8F2;">(JsonSerializer.</span><span style="color:#50FA7B;">Serialize</span><span style="color:#F8F8F2;">(message));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    _channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">        exchange</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">        routingKey</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">priority.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">        basicProperties</span><span style="color:#F8F8F2;">: props,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">        body</span><span style="color:#F8F8F2;">: body</span></span>
<span class="line"><span style="color:#F8F8F2;">    );</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¤ºä¾‹åœºæ™¯-è®¢å•ç³»ç»Ÿ-â†’-æ”¯ä»˜ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹åœºæ™¯-è®¢å•ç³»ç»Ÿ-â†’-æ”¯ä»˜ç³»ç»Ÿ"><span>ç¤ºä¾‹åœºæ™¯ï¼šè®¢å•ç³»ç»Ÿ â†’ æ”¯ä»˜ç³»ç»Ÿ</span></a></h2><ul><li><p>Order.APIï¼šç”¨æˆ·åˆ›å»ºè®¢å•ï¼Œå‘é€æ¶ˆæ¯åˆ° order_created é˜Ÿåˆ—ã€‚</p></li><li><p>Payment.APIï¼šç›‘å¬ order_created é˜Ÿåˆ—ï¼Œå½“æ£€æµ‹åˆ°æœ‰æ–°è®¢å•åˆ›å»ºæ—¶ï¼Œæ¨¡æ‹Ÿè‡ªåŠ¨å‘èµ·æ”¯ä»˜ã€‚</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#50FA7B;">RabbitMqDemo/</span></span>
<span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> Order.API/</span><span style="color:#6272A4;">        # è®¢å•æœåŠ¡ï¼šController ä¸­å‘é€æ¶ˆæ¯</span></span>
<span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> Payment.API/</span><span style="color:#6272A4;">      # æ”¯ä»˜æœåŠ¡ï¼šController å¯åŠ¨ç›‘å¬æˆ–è°ƒç”¨æ¶ˆè´¹è€…</span></span>
<span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> Shared/</span><span style="color:#6272A4;">           # å…±äº«æ¨¡å‹ï¼šOrderMessage</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="order-api" tabindex="-1"><a class="header-anchor" href="#order-api"><span>Order.API</span></a></h3><p><code>Shared/Models/OrderMessage.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">namespace</span><span style="color:#8BE9FD;font-style:italic;"> Shared</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> OrderMessage</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> OrderId { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;">.Empty;</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> decimal</span><span style="color:#F8F8F2;"> Amount { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; }</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> DateTime</span><span style="color:#F8F8F2;"> CreatedTime { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Order.API/Services/RabbitMqService.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Shared</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Json</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">namespace</span><span style="color:#8BE9FD;font-style:italic;"> Order</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Services</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> interface</span><span style="color:#8BE9FD;font-style:italic;"> IRabbitMqService</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    void</span><span style="color:#50FA7B;"> PublishOrder</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">OrderMessage</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> RabbitMqService</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">IRabbitMqService</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConfiguration</span><span style="color:#F8F8F2;"> _config;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> RabbitMqService</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> config</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _config </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> PublishOrder</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">OrderMessage</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:HostName</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">??</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">localhost</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        using</span><span style="color:#FF79C6;"> var</span><span style="color:#F8F8F2;"> connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">        using</span><span style="color:#FF79C6;"> var</span><span style="color:#F8F8F2;"> channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">queue</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">order_created</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             arguments</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">null</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetBytes</span><span style="color:#F8F8F2;">(JsonSerializer.</span><span style="color:#50FA7B;">Serialize</span><span style="color:#F8F8F2;">(message));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">exchange</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             routingKey</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">order_created</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             basicProperties</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">null</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             body</span><span style="color:#F8F8F2;">: body);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Order.API/Program.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> app </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> builder.</span><span style="color:#50FA7B;">Build</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">builder.Services.</span><span style="color:#50FA7B;">AddScoped</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IRabbitMqService</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">RabbitMqService</span><span style="color:#F8F8F2;">&gt;();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Order.API/Controllers/OrderController.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Microsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">AspNetCore</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Mvc</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Order</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Services</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Shared</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">namespace</span><span style="color:#8BE9FD;font-style:italic;"> Order</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Controllers</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">ApiController</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">Route</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">api/[controller]</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)]</span></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> OrderController</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">ControllerBase</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IRabbitMqService</span><span style="color:#F8F8F2;"> _rabbitMqService;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> OrderController</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IRabbitMqService</span><span style="color:#FFB86C;font-style:italic;"> rabbitMqService</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _rabbitMqService </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> rabbitMqService;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    [</span><span style="color:#8BE9FD;font-style:italic;">HttpPost</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> IActionResult</span><span style="color:#50FA7B;"> CreateOrder</span><span style="color:#F8F8F2;">([</span><span style="color:#8BE9FD;font-style:italic;">FromBody</span><span style="color:#F8F8F2;">] </span><span style="color:#8BE9FD;font-style:italic;">OrderMessage</span><span style="color:#FFB86C;font-style:italic;"> order</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        order.CreatedTime </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> DateTime.UtcNow;</span></span>
<span class="line"><span style="color:#F8F8F2;">        _rabbitMqService.</span><span style="color:#50FA7B;">PublishOrder</span><span style="color:#F8F8F2;">(order);</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#50FA7B;"> Ok</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#F8F8F2;"> { Message </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">è®¢å•å·²åˆ›å»ºå¹¶å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, Order </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> order });</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="payment-api" tabindex="-1"><a class="header-anchor" href="#payment-api"><span>Payment.API</span></a></h3><p><strong>Controllerç›‘å¬</strong><code>Payment.API/Controllers/PaymentController.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Microsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">AspNetCore</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Mvc</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Payment</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Services</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">namespace</span><span style="color:#8BE9FD;font-style:italic;"> Payment</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Controllers</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">ApiController</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">Route</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">api/[controller]</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)]</span></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> PaymentController</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">ControllerBase</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> OrderConsumerService</span><span style="color:#F8F8F2;"> _consumer;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> PaymentController</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">OrderConsumerService</span><span style="color:#FFB86C;font-style:italic;"> consumer</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _consumer </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> consumer;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    [</span><span style="color:#8BE9FD;font-style:italic;">HttpGet</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">listen</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)]</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> IActionResult</span><span style="color:#50FA7B;"> Listen</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _consumer.</span><span style="color:#50FA7B;">Start</span><span style="color:#F8F8F2;">(); </span><span style="color:#6272A4;">// å¯åŠ¨ RabbitMQ æ¶ˆæ¯ç›‘å¬</span></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#50FA7B;"> Ok</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">æ”¯ä»˜æœåŠ¡å·²å¼€å§‹ç›‘å¬è®¢å•é˜Ÿåˆ—...</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>BackgroundService å®ç°åå°ç›‘å¬</strong><code>Payment.API/Services/OrderConsumerService.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Events</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Shared</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Json</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">namespace</span><span style="color:#8BE9FD;font-style:italic;"> Payment</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Services</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> OrderConsumerBackgroundService</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">BackgroundService</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConfiguration</span><span style="color:#F8F8F2;"> _config;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> ILogger</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">OrderConsumerBackgroundService</span><span style="color:#F8F8F2;">&gt; _logger;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> OrderConsumerBackgroundService</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> config</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">ILogger</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">OrderConsumerBackgroundService</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#FFB86C;font-style:italic;">logger</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _config </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config;</span></span>
<span class="line"><span style="color:#F8F8F2;">        _logger </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> logger;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    protected</span><span style="color:#FF79C6;"> override</span><span style="color:#8BE9FD;font-style:italic;"> Task</span><span style="color:#50FA7B;"> ExecuteAsync</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">CancellationToken</span><span style="color:#FFB86C;font-style:italic;"> stoppingToken</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:HostName</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">??</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">localhost</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">queue</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">order_created</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             arguments</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">null</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _logger.</span><span style="color:#50FA7B;">LogInformation</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">ğŸ“¦ BackgroundService å¯åŠ¨ä¸­ï¼Œç›‘å¬è®¢å•é˜Ÿåˆ—...</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> consumer </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> EventingBasicConsumer</span><span style="color:#F8F8F2;">(channel);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        consumer.Received </span><span style="color:#FF79C6;">+=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FFB86C;font-style:italic;">model</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">ea</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> ea.Body.</span><span style="color:#50FA7B;">ToArray</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> json </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetString</span><span style="color:#F8F8F2;">(body);</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> order </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> JsonSerializer.</span><span style="color:#50FA7B;">Deserialize</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">OrderMessage</span><span style="color:#F8F8F2;">&gt;(json);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">            _logger.</span><span style="color:#50FA7B;">LogInformation</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">$&quot;</span><span style="color:#F1FA8C;">ğŸ’° åå°æœåŠ¡æ”¶åˆ°è®¢å•ï¼š</span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">order</span><span style="color:#FF79C6;">?</span><span style="color:#F1FA8C;">.</span><span style="color:#F8F8F2;">OrderId</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;"> é‡‘é¢ï¼š</span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">order</span><span style="color:#FF79C6;">?</span><span style="color:#F1FA8C;">.</span><span style="color:#F8F8F2;">Amount</span><span style="color:#FF79C6;">}</span><span style="color:#F1FA8C;"> åˆ›å»ºæ—¶é—´ï¼š</span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">order</span><span style="color:#FF79C6;">?</span><span style="color:#F1FA8C;">.</span><span style="color:#F8F8F2;">CreatedTime</span><span style="color:#FF79C6;">}</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        channel.</span><span style="color:#50FA7B;">BasicConsume</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">queue</span><span style="color:#F8F8F2;">: </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">order_created</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             autoAck</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">                             consumer</span><span style="color:#F8F8F2;">: consumer);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#F8F8F2;"> Task.CompletedTask;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Payment.API</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> app </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> builder.</span><span style="color:#50FA7B;">Build</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;"> builder.Services.</span><span style="color:#50FA7B;">AddHostedService</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">OrderConsumerBackgroundService</span><span style="color:#F8F8F2;">&gt;();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç¤ºä¾‹åœºæ™¯-å®šæ—¶æ¨é€" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹åœºæ™¯-å®šæ—¶æ¨é€"><span>ç¤ºä¾‹åœºæ™¯ï¼šå®šæ—¶æ¨é€</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> Controllers/</span></span>
<span class="line"><span style="color:#50FA7B;">â”‚</span><span style="color:#F1FA8C;">   â””â”€â”€</span><span style="color:#F1FA8C;"> ReminderController.cs</span><span style="color:#6272A4;">     # æä¾›åˆ›å»ºæ¨é€ä»»åŠ¡çš„æ¥å£</span></span>
<span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> Services/</span></span>
<span class="line"><span style="color:#50FA7B;">â”‚</span><span style="color:#F1FA8C;">   â”œâ”€â”€</span><span style="color:#F1FA8C;"> RabbitMqHelper.cs</span><span style="color:#6272A4;">        # å»¶è¿Ÿæ¶ˆæ¯å‘å¸ƒå°è£…</span></span>
<span class="line"><span style="color:#50FA7B;">â”‚</span><span style="color:#F1FA8C;">   â”œâ”€â”€</span><span style="color:#F1FA8C;"> ReminderScheduler.cs</span><span style="color:#6272A4;">     # åå°å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨</span></span>
<span class="line"><span style="color:#50FA7B;">â”‚</span><span style="color:#F1FA8C;">   â””â”€â”€</span><span style="color:#F1FA8C;"> SignalRHub.cs</span><span style="color:#6272A4;">            # æ¨é€ SignalR é€šçŸ¥</span></span>
<span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> Models/</span></span>
<span class="line"><span style="color:#50FA7B;">â”‚</span><span style="color:#F1FA8C;">   â””â”€â”€</span><span style="color:#F1FA8C;"> ScheduledMessage.cs</span><span style="color:#6272A4;">      # æ¨é€ä»»åŠ¡å®ä½“æ¨¡å‹</span></span>
<span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> Data/</span></span>
<span class="line"><span style="color:#50FA7B;">â”‚</span><span style="color:#F1FA8C;">   â””â”€â”€</span><span style="color:#F1FA8C;"> ReminderDbContext.cs</span><span style="color:#6272A4;">     # EF Core æ•°æ®åº“ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="color:#50FA7B;">â”œâ”€â”€</span><span style="color:#F1FA8C;"> appsettings.json</span><span style="color:#6272A4;">             # åŒ…å« RabbitMQ é…ç½®</span></span>
<span class="line"><span style="color:#50FA7B;">â””â”€â”€</span><span style="color:#F1FA8C;"> Program.cs</span><span style="color:#6272A4;">                   # æ³¨å†ŒæœåŠ¡/é…ç½®/å¯åŠ¨åå°æœåŠ¡</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æµç¨‹</p>`,81)),p(a,{id:"mermaid-403",code:"eJwrTi0sTc1LTnXJTEwvSszlCi1OLVLQtbNTCErNzcxLSS3ScwzwtFJ41j/hya4lQPJl26Qnu3c/7Vr4fk/Hs+nbXk7fov20rfXpup3v93RyIesBG+LiZKXwZP/cp2tnKAQnZ6SmlOakpvimFhcnpqfCFcMkINaCdDxb3/+0o+3lpPnP5i991rnvxf6Jz+bMf7qv9VnfipcNjRDrcWgPSkxKyizxDbRSeLp724v985/2T3y6o/nZto5njeuBLq7QTUnNSawEuxWqEqzNOT+vuDQXaFhqUVlmcirQCWCvPe3Y8GLfvqcT+p51TX3ZMIkLTRlYa3Bmel5iTpBHaRJQF9iBENue7575rKf96bpZz6eseNaxnQsAhTuw1A=="}),s[1]||(s[1]=n(`<p>packageåŒ…</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#50FA7B;">dotnet</span><span style="color:#F1FA8C;"> add</span><span style="color:#F1FA8C;"> package</span><span style="color:#F1FA8C;"> Pomelo.EntityFrameworkCore.MySql</span></span>
<span class="line"><span style="color:#50FA7B;">dotnet</span><span style="color:#F1FA8C;"> add</span><span style="color:#F1FA8C;"> package</span><span style="color:#F1FA8C;"> Microsoft.EntityFrameworkCore.Design</span></span>
<span class="line"><span style="color:#50FA7B;">dotnet</span><span style="color:#F1FA8C;"> add</span><span style="color:#F1FA8C;"> package</span><span style="color:#F1FA8C;"> RabbitMQ.Client</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>program.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#F8F8F2;">builder.Services.</span><span style="color:#50FA7B;">AddDbContext</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ReminderDbContext</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#FFB86C;font-style:italic;">options</span><span style="color:#FF79C6;"> =&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#F8F8F2;">    options.</span><span style="color:#50FA7B;">UseMySql</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#F8F8F2;">        builder.Configuration.</span><span style="color:#50FA7B;">GetConnectionString</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">MySQL</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">),</span></span>
<span class="line"><span style="color:#FF79C6;">        new</span><span style="color:#8BE9FD;font-style:italic;"> MySqlServerVersion</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> Version</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">8</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">, </span><span style="color:#BD93F9;">34</span><span style="color:#F8F8F2;">))</span></span>
<span class="line"><span style="color:#F8F8F2;">    );</span></span>
<span class="line"><span style="color:#F8F8F2;">});</span></span>
<span class="line"><span style="color:#F8F8F2;">builder.Services.</span><span style="color:#50FA7B;">AddSingleton</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">RabbitMqHelper</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"><span style="color:#6272A4;">// appsettings.json</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#E9F284;">  &quot;</span><span style="color:#F1FA8C;">ConnectionStrings</span><span style="color:#E9F284;">&quot;</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="models" tabindex="-1"><a class="header-anchor" href="#models"><span>Models</span></a></h3><p><code>Models/ScheduledMessage.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> ScheduledMessage</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> Guid</span><span style="color:#F8F8F2;"> Id { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Guid.</span><span style="color:#50FA7B;">NewGuid</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> UserId { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> null</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">;     </span><span style="color:#6272A4;">// æ¥æ”¶ç”¨æˆ·</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> Content { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> null</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">;    </span><span style="color:#6272A4;">// æ¶ˆæ¯å†…å®¹</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> DateTime</span><span style="color:#F8F8F2;"> ScheduledTime { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; }     </span><span style="color:#6272A4;">// è®¡åˆ’æ¨é€æ—¶é—´ï¼ˆUTCï¼‰</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> bool</span><span style="color:#F8F8F2;"> IsSent { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> false</span><span style="color:#F8F8F2;">;       </span><span style="color:#6272A4;">// æ˜¯å¦å·²å‘é€</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Models/CreateReminderRequest.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> CreateReminderRequest</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> UserId { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> null</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> Content { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; } </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> null</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> DateTime</span><span style="color:#F8F8F2;"> ScheduledTime { </span><span style="color:#FF79C6;">get</span><span style="color:#F8F8F2;">; </span><span style="color:#FF79C6;">set</span><span style="color:#F8F8F2;">; }  </span><span style="color:#6272A4;">// è¯·ä»¥ UTC æäº¤</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="data" tabindex="-1"><a class="header-anchor" href="#data"><span>Data</span></a></h3><p><code>Data/ReminderDbContext.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Microsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">EntityFrameworkCore</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Reminder</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> ReminderDbContext</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">DbContext</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> ReminderDbContext</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">DbContextOptions</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ReminderDbContext</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#FFB86C;font-style:italic;">options</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">        : </span><span style="color:#BD93F9;font-style:italic;">base</span><span style="color:#F8F8F2;">(options) { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#8BE9FD;font-style:italic;"> DbSet</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ScheduledMessage</span><span style="color:#F8F8F2;">&gt; ScheduledMessages </span><span style="color:#FF79C6;">=&gt;</span><span style="color:#50FA7B;"> Set</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ScheduledMessage</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="controllers" tabindex="-1"><a class="header-anchor" href="#controllers"><span>Controllers</span></a></h3><p><code>Controllers/ReminderController.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Microsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">AspNetCore</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Mvc</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Reminder</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Reminder</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Data</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">ApiController</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">[</span><span style="color:#8BE9FD;font-style:italic;">Route</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">api/[controller]</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">)]</span></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> ReminderController</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">ControllerBase</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> ReminderDbContext</span><span style="color:#F8F8F2;"> _db;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> ReminderController</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">ReminderDbContext</span><span style="color:#FFB86C;font-style:italic;"> db</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _db </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> db;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    [</span><span style="color:#8BE9FD;font-style:italic;">HttpPost</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> async</span><span style="color:#8BE9FD;font-style:italic;"> Task</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">IActionResult</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#50FA7B;">CreateReminder</span><span style="color:#F8F8F2;">([</span><span style="color:#8BE9FD;font-style:italic;">FromBody</span><span style="color:#F8F8F2;">] </span><span style="color:#8BE9FD;font-style:italic;">CreateReminderRequest</span><span style="color:#FFB86C;font-style:italic;"> request</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> message </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ScheduledMessage</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            UserId </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> request.UserId,</span></span>
<span class="line"><span style="color:#F8F8F2;">            Content </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> request.Content,</span></span>
<span class="line"><span style="color:#F8F8F2;">            ScheduledTime </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> request.ScheduledTime.</span><span style="color:#50FA7B;">ToUniversalTime</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _db.ScheduledMessages.</span><span style="color:#50FA7B;">Add</span><span style="color:#F8F8F2;">(message);</span></span>
<span class="line"><span style="color:#FF79C6;">        await</span><span style="color:#F8F8F2;"> _db.</span><span style="color:#50FA7B;">SaveChangesAsync</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#50FA7B;"> Ok</span><span style="color:#F8F8F2;">(</span><span style="color:#FF79C6;">new</span><span style="color:#F8F8F2;"> { message.Id, Status </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">Scheduled</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> });</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="services" tabindex="-1"><a class="header-anchor" href="#services"><span>Services</span></a></h3><p><code>Services/RabbitMqHelper.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Json</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> RabbitMqHelper</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">IDisposable</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IModel</span><span style="color:#F8F8F2;"> _channel;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConnection</span><span style="color:#F8F8F2;"> _connection;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> ExchangeName </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">reminder.delay.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> QueueName </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">reminder.delay.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> RoutingKey </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">reminder</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> RabbitMqHelper</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> config</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Host</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Port </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> int</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Parse</span><span style="color:#F8F8F2;">(config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Port</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">??</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">5672</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">),</span></span>
<span class="line"><span style="color:#F8F8F2;">            UserName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:User</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Password </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Password</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">        // åˆ›å»ºå»¶è¿Ÿäº¤æ¢æœºï¼ˆéœ€è¦å¯ç”¨ rabbitmq_delayed_message_exchange æ’ä»¶ï¼‰</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">ExchangeDeclare</span><span style="color:#F8F8F2;">(ExchangeName, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delayed-message</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">arguments</span><span style="color:#F8F8F2;">: </span><span style="color:#FF79C6;">new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delayed-type</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">direct</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;"> }</span></span>
<span class="line"><span style="color:#F8F8F2;">        });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(QueueName, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueBind</span><span style="color:#F8F8F2;">(QueueName, ExchangeName, RoutingKey);</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> PublishDelayed</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FFB86C;font-style:italic;">T</span><span style="color:#F8F8F2;">&gt;(</span><span style="color:#8BE9FD;font-style:italic;">T</span><span style="color:#FFB86C;font-style:italic;"> message</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">double</span><span style="color:#FFB86C;font-style:italic;"> delayMs</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetBytes</span><span style="color:#F8F8F2;">(JsonSerializer.</span><span style="color:#50FA7B;">Serialize</span><span style="color:#F8F8F2;">(message));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> props </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _channel.</span><span style="color:#50FA7B;">CreateBasicProperties</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        props.Headers </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> Dictionary</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#FF79C6;">string</span><span style="color:#F8F8F2;">, </span><span style="color:#FF79C6;">object</span><span style="color:#F8F8F2;">&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            { </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">x-delay</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, delayMs }</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">BasicPublish</span><span style="color:#F8F8F2;">(</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            exchange</span><span style="color:#F8F8F2;">: ExchangeName,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            routingKey</span><span style="color:#F8F8F2;">: RoutingKey,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            basicProperties</span><span style="color:#F8F8F2;">: props,</span></span>
<span class="line"><span style="color:#FFB86C;font-style:italic;">            body</span><span style="color:#F8F8F2;">: body</span></span>
<span class="line"><span style="color:#F8F8F2;">        );</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Dispose</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _connection</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Services/ReminderScheduler.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Microsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">EntityFrameworkCore</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Reminder</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Data</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Reminder</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> ReminderScheduler</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">BackgroundService</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IServiceScopeFactory</span><span style="color:#F8F8F2;"> _scopeFactory;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMqHelper</span><span style="color:#F8F8F2;"> _rabbitMqHelper;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> ILogger</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ReminderScheduler</span><span style="color:#F8F8F2;">&gt; _logger;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> ReminderScheduler</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IServiceScopeFactory</span><span style="color:#FFB86C;font-style:italic;"> scopeFactory</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">RabbitMqHelper</span><span style="color:#FFB86C;font-style:italic;"> rabbitMqHelper</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">ILogger</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ReminderScheduler</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#FFB86C;font-style:italic;">logger</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _scopeFactory </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> scopeFactory;</span></span>
<span class="line"><span style="color:#F8F8F2;">        _rabbitMqHelper </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> rabbitMqHelper;</span></span>
<span class="line"><span style="color:#F8F8F2;">        _logger </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> logger;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    protected</span><span style="color:#FF79C6;"> override</span><span style="color:#FF79C6;"> async</span><span style="color:#8BE9FD;font-style:italic;"> Task</span><span style="color:#50FA7B;"> ExecuteAsync</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">CancellationToken</span><span style="color:#FFB86C;font-style:italic;"> stoppingToken</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _logger.</span><span style="color:#50FA7B;">LogInformation</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">â° ReminderScheduler started</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        while</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">!</span><span style="color:#F8F8F2;">stoppingToken.IsCancellationRequested)</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#FF79C6;">            try</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#FF79C6;">                using</span><span style="color:#FF79C6;"> var</span><span style="color:#F8F8F2;"> scope </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _scopeFactory.</span><span style="color:#50FA7B;">CreateScope</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">                var</span><span style="color:#F8F8F2;"> db </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> scope.ServiceProvider.</span><span style="color:#50FA7B;">GetRequiredService</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ReminderDbContext</span><span style="color:#F8F8F2;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">                var</span><span style="color:#F8F8F2;"> now </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> DateTime.UtcNow;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">                var</span><span style="color:#F8F8F2;"> upcomingMessages </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> await</span><span style="color:#F8F8F2;"> db.ScheduledMessages</span></span>
<span class="line"><span style="color:#F8F8F2;">                    .</span><span style="color:#50FA7B;">Where</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">m</span><span style="color:#FF79C6;"> =&gt;</span><span style="color:#FF79C6;"> !</span><span style="color:#F8F8F2;">m.IsSent </span><span style="color:#FF79C6;">&amp;&amp;</span><span style="color:#F8F8F2;"> m.ScheduledTime </span><span style="color:#FF79C6;">&lt;=</span><span style="color:#F8F8F2;"> now.</span><span style="color:#50FA7B;">AddMinutes</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">))</span></span>
<span class="line"><span style="color:#F8F8F2;">                    .</span><span style="color:#50FA7B;">ToListAsync</span><span style="color:#F8F8F2;">(stoppingToken);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">                foreach</span><span style="color:#F8F8F2;"> (</span><span style="color:#FF79C6;">var</span><span style="color:#F8F8F2;"> msg </span><span style="color:#FF79C6;">in</span><span style="color:#F8F8F2;"> upcomingMessages)</span></span>
<span class="line"><span style="color:#F8F8F2;">                {</span></span>
<span class="line"><span style="color:#FF79C6;">                    var</span><span style="color:#F8F8F2;"> delay </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> (msg.ScheduledTime </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> now).TotalMilliseconds;</span></span>
<span class="line"><span style="color:#F8F8F2;">                    delay </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Math.</span><span style="color:#50FA7B;">Max</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">, delay);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">                    _rabbitMqHelper.</span><span style="color:#50FA7B;">PublishDelayed</span><span style="color:#F8F8F2;">(msg, delay);</span></span>
<span class="line"><span style="color:#F8F8F2;">                    msg.IsSent </span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;"> true</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">                    _logger.</span><span style="color:#50FA7B;">LogInformation</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">ğŸ“¨ å‘å¸ƒå»¶è¿Ÿæé†’æ¶ˆæ¯: {Id}, å»¶è¿Ÿ: {Delay}ms</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, msg.Id, delay);</span></span>
<span class="line"><span style="color:#F8F8F2;">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">                await</span><span style="color:#F8F8F2;"> db.</span><span style="color:#50FA7B;">SaveChangesAsync</span><span style="color:#F8F8F2;">(stoppingToken);</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#FF79C6;">            catch</span><span style="color:#F8F8F2;"> (</span><span style="color:#8BE9FD;font-style:italic;">Exception</span><span style="color:#F8F8F2;"> ex)</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#F8F8F2;">                _logger.</span><span style="color:#50FA7B;">LogError</span><span style="color:#F8F8F2;">(ex, </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">åå°è°ƒåº¦å¤±è´¥</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">            await</span><span style="color:#F8F8F2;"> Task.</span><span style="color:#50FA7B;">Delay</span><span style="color:#F8F8F2;">(TimeSpan.</span><span style="color:#50FA7B;">FromSeconds</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">30</span><span style="color:#F8F8F2;">), stoppingToken); </span><span style="color:#6272A4;">// æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡</span></span>
<span class="line"><span style="color:#F8F8F2;">        }</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"><span style="color:#6272A4;">// program</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">builder.Services.</span><span style="color:#50FA7B;">AddHostedService</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ReminderScheduler</span><span style="color:#F8F8F2;">&gt;();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Services/ReminderConsumer.cs</code></p><div class="language-csharp line-numbers-mode" data-highlighter="shiki" data-ext="csharp" data-title="csharp" style="background-color:#282A36;color:#F8F8F2;"><pre class="shiki dracula vp-code"><code><span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> RabbitMQ</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Client</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Events</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> System</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Text</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Json</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Reminder</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">API</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">Models</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">using</span><span style="color:#8BE9FD;font-style:italic;"> Microsoft</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">AspNetCore</span><span style="color:#F8F8F2;">.</span><span style="color:#8BE9FD;font-style:italic;">SignalR</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">public</span><span style="color:#FF79C6;"> class</span><span style="color:#8BE9FD;"> ReminderConsumer</span><span style="color:#F8F8F2;"> : </span><span style="color:#8BE9FD;font-style:italic;">BackgroundService</span></span>
<span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IHubContext</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">SignalRHub</span><span style="color:#F8F8F2;">&gt; _hub;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> readonly</span><span style="color:#8BE9FD;font-style:italic;"> IConfiguration</span><span style="color:#F8F8F2;"> _config;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#8BE9FD;font-style:italic;"> IConnection</span><span style="color:#F8F8F2;">? _connection;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#8BE9FD;font-style:italic;"> IModel</span><span style="color:#F8F8F2;">? _channel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> ExchangeName </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">reminder.delay.exchange</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> QueueName </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">reminder.delay.queue</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#FF79C6;">    private</span><span style="color:#FF79C6;"> const</span><span style="color:#FF79C6;"> string</span><span style="color:#F8F8F2;"> RoutingKey </span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">reminder</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#50FA7B;"> ReminderConsumer</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">IHubContext</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">SignalRHub</span><span style="color:#F8F8F2;">&gt; </span><span style="color:#FFB86C;font-style:italic;">hub</span><span style="color:#F8F8F2;">, </span><span style="color:#8BE9FD;font-style:italic;">IConfiguration</span><span style="color:#FFB86C;font-style:italic;"> config</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _hub </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> hub;</span></span>
<span class="line"><span style="color:#F8F8F2;">        _config </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> config;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    protected</span><span style="color:#FF79C6;"> override</span><span style="color:#8BE9FD;font-style:italic;"> Task</span><span style="color:#50FA7B;"> ExecuteAsync</span><span style="color:#F8F8F2;">(</span><span style="color:#8BE9FD;font-style:italic;">CancellationToken</span><span style="color:#FFB86C;font-style:italic;"> stoppingToken</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> factory </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> ConnectionFactory</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#F8F8F2;">            HostName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Host</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Port </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> int</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Parse</span><span style="color:#F8F8F2;">(_config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Port</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">] </span><span style="color:#FF79C6;">??</span><span style="color:#E9F284;"> &quot;</span><span style="color:#F1FA8C;">5672</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">),</span></span>
<span class="line"><span style="color:#F8F8F2;">            UserName </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:User</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">],</span></span>
<span class="line"><span style="color:#F8F8F2;">            Password </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _config[</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">RabbitMQ:Password</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">]</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _connection </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> factory.</span><span style="color:#50FA7B;">CreateConnection</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> _connection.</span><span style="color:#50FA7B;">CreateModel</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">QueueDeclare</span><span style="color:#F8F8F2;">(QueueName, </span><span style="color:#FFB86C;font-style:italic;">durable</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">exclusive</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">autoDelete</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">false</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        var</span><span style="color:#F8F8F2;"> consumer </span><span style="color:#FF79C6;">=</span><span style="color:#FF79C6;"> new</span><span style="color:#8BE9FD;font-style:italic;"> EventingBasicConsumer</span><span style="color:#F8F8F2;">(_channel);</span></span>
<span class="line"><span style="color:#F8F8F2;">        consumer.Received </span><span style="color:#FF79C6;">+=</span><span style="color:#FF79C6;"> async</span><span style="color:#F8F8F2;"> (</span><span style="color:#FFB86C;font-style:italic;">model</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">ea</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">=&gt;</span></span>
<span class="line"><span style="color:#F8F8F2;">        {</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> body </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> ea.Body.</span><span style="color:#50FA7B;">ToArray</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> json </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> Encoding.UTF8.</span><span style="color:#50FA7B;">GetString</span><span style="color:#F8F8F2;">(body);</span></span>
<span class="line"><span style="color:#FF79C6;">            var</span><span style="color:#F8F8F2;"> msg </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> JsonSerializer.</span><span style="color:#50FA7B;">Deserialize</span><span style="color:#F8F8F2;">&lt;</span><span style="color:#8BE9FD;font-style:italic;">ScheduledMessage</span><span style="color:#F8F8F2;">&gt;(json);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">            if</span><span style="color:#F8F8F2;"> (msg </span><span style="color:#FF79C6;">!=</span><span style="color:#BD93F9;"> null</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">            {</span></span>
<span class="line"><span style="color:#F8F8F2;">                Console.</span><span style="color:#50FA7B;">WriteLine</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">$&quot;</span><span style="color:#F1FA8C;">ğŸ”” æ”¶åˆ°æé†’æ¶ˆæ¯: </span><span style="color:#FF79C6;">{</span><span style="color:#F8F8F2;">msg</span><span style="color:#F1FA8C;">.</span><span style="color:#F8F8F2;">Content</span><span style="color:#FF79C6;">}</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#FF79C6;">                await</span><span style="color:#F8F8F2;"> _hub.Clients.</span><span style="color:#50FA7B;">User</span><span style="color:#F8F8F2;">(msg.UserId).</span><span style="color:#50FA7B;">SendAsync</span><span style="color:#F8F8F2;">(</span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">ReceiveReminder</span><span style="color:#E9F284;">&quot;</span><span style="color:#F8F8F2;">, msg.Content);</span></span>
<span class="line"><span style="color:#F8F8F2;">            }</span></span>
<span class="line"><span style="color:#F8F8F2;">        };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">        _channel.</span><span style="color:#50FA7B;">BasicConsume</span><span style="color:#F8F8F2;">(</span><span style="color:#FFB86C;font-style:italic;">queue</span><span style="color:#F8F8F2;">: QueueName, </span><span style="color:#FFB86C;font-style:italic;">autoAck</span><span style="color:#F8F8F2;">: </span><span style="color:#BD93F9;">true</span><span style="color:#F8F8F2;">, </span><span style="color:#FFB86C;font-style:italic;">consumer</span><span style="color:#F8F8F2;">: consumer);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">        return</span><span style="color:#F8F8F2;"> Task.CompletedTask;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">    public</span><span style="color:#FF79C6;"> override</span><span style="color:#FF79C6;"> void</span><span style="color:#50FA7B;"> Dispose</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    {</span></span>
<span class="line"><span style="color:#F8F8F2;">        _channel</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">        _connection</span><span style="color:#FF79C6;">?</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Close</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic;">        base</span><span style="color:#F8F8F2;">.</span><span style="color:#50FA7B;">Dispose</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å‚è€ƒ" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒ"><span>å‚è€ƒ</span></a></h2><ul><li><a href="https://blog.csdn.net/qq_45173404/article/details/121687489" target="_blank" rel="noopener noreferrer">RabbitMQè¶…è¯¦ç»†å­¦ä¹ ç¬”è®°ï¼ˆç« èŠ‚æ¸…æ™°+é€šä¿—æ˜“æ‡‚ï¼‰</a></li><li><a href="https://www.cnblogs.com/whuanle/p/17837034.html" target="_blank" rel="noopener noreferrer">ä¸‡å­—é•¿æ–‡ï¼šä» C# å…¥é—¨å­¦ä¼š RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—ç¼–ç¨‹</a></li><li><a href="https://www.bilibili.com/video/BV1oCwEeVEe4/?spm_id_from=333.337.search-card.all.click&amp;vd_source=b4222cc2ad9f3adc653a4768dbfd9b95" target="_blank" rel="noopener noreferrer">RabbitMQæ˜¯ä»€ä¹ˆï¼Ÿæ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</a></li></ul>`,24))])}const B=l(u,[["render",b],["__file","base.html.vue"]]),g=JSON.parse('{"path":"/rabbit-mq/base.html","title":"RabbitMQ åŸºç¡€","lang":"en-US","frontmatter":{"title":"RabbitMQ åŸºç¡€","date":"2025-03-30T00:00:00.000Z","category":["DotNet"],"type":["RabbitMQ"],"description":"RabbitMQ æ˜¯ä¸€ä¸ªå®ç°äº† AMQP åè®®çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒAMQP è¢«å®šä¹‰ä¸ºä½œä¸ºæ¶ˆæ¯ä¼ é€’ä¸­é—´ä»¶çš„å¼€æ”¾æ ‡å‡†çš„åº”ç”¨å±‚åè®®ã€‚å®ƒä»£è¡¨é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œå…·æœ‰æ¶ˆæ¯å®šä½ã€è·¯ç”±ã€é˜Ÿåˆ—ã€å®‰å…¨æ€§å’Œå¯é æ€§ç­‰ç‰¹ç‚¹ã€‚ RabbitMQ çš„ä¼˜ç‚¹ã€ç”¨é€”ç­‰ï¼Œå¤§æ¦‚æ˜¯å¯é æ€§é«˜ã€çµæ´»çš„è·¯ç”±è§„åˆ™é…ç½®ã€æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€éµå®ˆ AMQP åè®®ç­‰ã€‚å¯ä»¥ç”¨äºå¼‚æ­¥é€šè®¯ã€æ—¥å¿—æ”¶é›†(æ—¥å¿—æ”¶é›†è¿˜æ˜¯ Kafka...","head":[["meta",{"property":"og:url","content":"https://luxiag.github.io/luxiag/blog/rabbit-mq/base.html"}],["meta",{"property":"og:title","content":"RabbitMQ åŸºç¡€"}],["meta",{"property":"og:description","content":"RabbitMQ æ˜¯ä¸€ä¸ªå®ç°äº† AMQP åè®®çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒAMQP è¢«å®šä¹‰ä¸ºä½œä¸ºæ¶ˆæ¯ä¼ é€’ä¸­é—´ä»¶çš„å¼€æ”¾æ ‡å‡†çš„åº”ç”¨å±‚åè®®ã€‚å®ƒä»£è¡¨é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œå…·æœ‰æ¶ˆæ¯å®šä½ã€è·¯ç”±ã€é˜Ÿåˆ—ã€å®‰å…¨æ€§å’Œå¯é æ€§ç­‰ç‰¹ç‚¹ã€‚ RabbitMQ çš„ä¼˜ç‚¹ã€ç”¨é€”ç­‰ï¼Œå¤§æ¦‚æ˜¯å¯é æ€§é«˜ã€çµæ´»çš„è·¯ç”±è§„åˆ™é…ç½®ã€æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€éµå®ˆ AMQP åè®®ç­‰ã€‚å¯ä»¥ç”¨äºå¼‚æ­¥é€šè®¯ã€æ—¥å¿—æ”¶é›†(æ—¥å¿—æ”¶é›†è¿˜æ˜¯ Kafka..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-04-24T10:58:50.000Z"}],["meta",{"property":"article:published_time","content":"2025-03-30T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-04-24T10:58:50.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"RabbitMQ åŸºç¡€\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-03-30T00:00:00.000Z\\",\\"dateModified\\":\\"2025-04-24T10:58:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"luxiag\\",\\"url\\":\\"https://luxiag.github.io/luxiag\\"}]}"]]},"git":{"createdTime":1745396323000,"updatedTime":1745492330000,"contributors":[{"name":"luxiag","username":"luxiag","email":"luxiag@qq.com","commits":2,"url":"https://github.com/luxiag"}]},"readingTime":{"minutes":15.26,"words":4579},"filePathRelative":"rabbit-mq/base.md","localizedDate":"March 30, 2025","excerpt":"<p>RabbitMQ æ˜¯ä¸€ä¸ªå®ç°äº† AMQP åè®®çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒAMQP è¢«å®šä¹‰ä¸ºä½œä¸ºæ¶ˆæ¯ä¼ é€’ä¸­é—´ä»¶çš„å¼€æ”¾æ ‡å‡†çš„åº”ç”¨å±‚åè®®ã€‚å®ƒä»£è¡¨é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œå…·æœ‰æ¶ˆæ¯å®šä½ã€è·¯ç”±ã€é˜Ÿåˆ—ã€å®‰å…¨æ€§å’Œå¯é æ€§ç­‰ç‰¹ç‚¹ã€‚</p>","autoDesc":true}');export{B as comp,g as data};
